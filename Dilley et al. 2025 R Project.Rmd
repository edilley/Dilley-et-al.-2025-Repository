---
title: "Juvenile Coral Demographic Study Plots and Analyses Final" 
output:
  html_document:
      code_folding: hide
      toc: true
      toc_depth: 3
      toc_float: true
  word_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
## READ BEFORE USING THIS SCRIPT
# IMPORTANT: search for "## user input" in script to find all places where you must input a working directory, folder to save figures to, or to change a variable


## user input
# change to your R working directory

knitr::opts_chunk$set(echo = TRUE)
options(width = 300)
knitr::opts_chunk$set(fig.width=7, fig.height=7)
options(tinytex.verbose = TRUE)
```


```{r Set Working Directory, echo = "FALSE", results='hide', message=FALSE, warning=FALSE}

getwd()

#setwd("~/ericrdilley@gmail.com - Google Drive/Other computers/My iMac/Google Drive/Hixon Lab_Dilley/Masters Thesis/PeerJ Review/R Markdown Working Database and Outputs")
## user input
# change to your R working directory (same as previous code chunk)
```


```{r Packages, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Packages

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('tidyverse', 'ggfortify', 'data.table', 'ggplot2', 'car', 'lme4', 'lmerTest', 'emmeans', 'MuMIn', 'effects', 'rcompanion', 'png', 'stringi', 'forcats', 'AER', 'tweedie', 'gamlss', 'predictmeans', 'nnet', 'e1071', 'sjPlot', 'cowplot', 'gdata', 'Rfast', 'htmlTable', 'GeneralizedHyperbolic', 'scales', 'simr', 'Transform', 'glmmTMB')



```


```{r Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
# Coral database for algal cover code
sub_2 <- read_csv("databases/pub_data_final.csv")

cover_code <- c(1,2,3,4)

side <- c("N", "S")
timestep <- c(1,2,3,4,5,6,7,8,9,10,11,12) 
modules <- c(111,112,113,114,115,116,212,213,214,215,216)
exclusion <- c("NF","D")
label <- c("MA","T")
save_location <- file.path(getwd(), "outputs")
## user input
# need to change path argument to set where figures/tables are saved to

sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
# select the modules to analyze (excluding 211)

urchin_taxa <- c("CHGI", "DIPA", "DISA", "ECAC", "ECCA", "ECDI", "ECMA", "ECOB", "EUME", "HEMA", "TRGR", ".")
fish_taxa_with_transient <- c("ACBL", "ACDU", "ACLE", "ACNI", "ACNR", "ACOL", "ACTR", "ACXA", "CACA", "CHSP", "CTST", "NABR", "NAUN", "SCPS", "SCRU", "ZEFL")
fish_taxa_no_transient <- c("ACBL", "ACDU", "ACLE", "ACNI", "ACNR", "ACOL", "ACTR", "CACA", "CHSP", "CTST", "NABR", "NAUN", "SCPS", "SCRU", "ZEFL")
# species codes including all herbivorous fish and urchin taxa observed during the study

# all coral growth barplot
mult_compare_recruitment <- c("A", "A", "A", "A")
mult_compare_survival <- c("A", "A", "A", "A")
mult_compare_growth_all <- c("A", "A","A", "A")
mult_compare_growth_cover <- c("A", "A", "A", "A")
# used to label multiple comparisons on barplots


glmmTMB_fam <- "binomial"
# model family for glmmTMB models

std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

effect <- function(x){plot(allEffects(x))}
# quick function for plotting model effects

#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data


```

# Urchin Biomass, Herbivorous Fish Biomass, and Benthic Algal Overgrowth
This section contains the analyses and figures for urchin biomass, herbivorous fish biomass, and benthic algal overgrowth on low and high shelter experimental modules at Waikiki and Hanauma Bay.  All barplot figures represent means and standard errors for their associated linear mixed effects model analyses.  Gray bars represent low shelter modules and black bars represent high shelter modules.

```{r Urchins Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## With ECMA and EUME ##
urchin_data <- read_csv("databases/Echinoderm Database 09_03_2020_final.csv", col_names = TRUE)

### filter for urchin species from database
urchin_data <- urchin_data %>% filter(Species %in% urchin_taxa)

urchin_biomass_parameters <- read_csv("databases/Urchin Biomass Parameters.csv")

test_urchin_data <- urchin_data %>% gather(Size, TOTAL, `0.5`:`14+`) %>% 
  filter(TimeStep %in% timestep,
         `Reef #` %in% modules,
         Size != "14+")

# Create biomass incorporated database
urchin_data <- left_join(test_urchin_data, urchin_biomass_parameters, by = c("Species"))

urchin_data$Size <- as.numeric(urchin_data$Size)
urchin_data <- urchin_data %>% replace_na(list(a = 0, b = 0))
urchin_data <- urchin_data %>% mutate(Biomass = a*(Size^b)*TOTAL)


# Site and Treatment long columns #
urchin_data <- urchin_data %>% mutate(Site_long = ifelse(Site == "WAI", "Waikiki", "Hanauma Bay")) %>% 
  mutate(Treatment_long = ifelse(Treatment == "CLO", "Closed", "Open")) %>% 
  mutate(Shelter = ifelse(Treatment == "CLO", "Low", "High")) %>% 
  filter(TimeStep %in% timestep)

# database with starting urchins #
mean_urchin_totals2 <- urchin_data %>% group_by(Year, Date, `Reef #`, TimeStep, Site_long, Treatment_long, Shelter) %>%
  summarize(urchin_abundance = sum(TOTAL),
            urchin_biomass = sum(Biomass)) %>% 
  rename(`Module #` = `Reef #`) %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))



mean_urchin_totals2$new_date <- strptime(as.character(mean_urchin_totals2$Date), "%m/%d/%y")
mean_urchin_totals2$new_date <-  as.Date(mean_urchin_totals2$new_date,'%m/%d/%y')
mean_urchin_totals2$Year <- as.numeric(format(mean_urchin_totals2$new_date,'%y'))
mean_urchin_totals2$new_date <- as.Date(mean_urchin_totals2$new_date)
mean_urchin_totals2$Shelter <- as.factor(mean_urchin_totals2$Shelter)
mean_urchin_totals2$Site_long <- as.factor(mean_urchin_totals2$Site_long)
mean_urchin_totals2$Year <- as.numeric(mean_urchin_totals2$Year)
mean_urchin_totals2$Date <- mean_urchin_totals2$new_date

mean_urchin_totals2 <- mean_urchin_totals2 %>% ungroup() %>% 
  dplyr::select(-Treatment_long, -new_date) %>% 
  mutate(urchin_biomass = urchin_biomass/1000) %>% 
  mutate(urchin_P_A = ifelse(urchin_biomass == 0, 0, 1))

# create database with kg scaled biomass and a presense/absense column


```

```{r Urchins Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

# transform response 
mean_urchin_totals2 <- mean_urchin_totals2 %>% mutate(urchin_biomass_trans = log(urchin_biomass + 1))

urchin_biomass_dist <- plotNormalHistogram(mean_urchin_totals2$urchin_biomass, main = "Urchin Biomass")

urchin_biomass_trans_dist <- plotNormalHistogram(mean_urchin_totals2$urchin_biomass_trans, main = "Urchin Biomass Transformed")

```

```{r Urchins Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
# Urchins with interaction
module_urchins <- mean_urchin_totals2$`Module #`
mean_urchin_totals2$Shelter <- factor(mean_urchin_totals2$Shelter, levels = c("Low", "High"), ordered = TRUE)
mean_urchin_totals2$Site_long <- factor(mean_urchin_totals2$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)


urchin_lmer <- lmer(urchin_biomass_trans ~ Site_long*Shelter + (1|module_urchins) + (1|Year/Season), data = mean_urchin_totals2, na.action = "na.fail")
summary(urchin_lmer)

r.squaredGLMM(urchin_lmer)


# Urchins without interaction
urchin_lmer_no_interaction <- lmer(urchin_biomass_trans ~ Site_long + Shelter + (1|module_urchins) +  (1|Year/Season), data = mean_urchin_totals2, na.action = "na.fail")
summary(urchin_lmer_no_interaction)


# Urchins with glmmTMB
urchin_glmmTMB <- glmmTMB(urchin_biomass ~ Site_long*Shelter + (1|module_urchins) + (1|Year/Season), data = mean_urchin_totals2, na.action = "na.fail", family = tweedie(link = "log"))
summary(urchin_glmmTMB)
```

```{r Urchins Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
##### Analysis Assessment

## Urchin with interaction
png("outputs/Urchins trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_lmer), main = "Urchin trans Residuals")
qqline(resid(urchin_lmer))
dev.off()

qqnorm(resid(urchin_lmer), main = "Urchin trans Residuals")
qqline(resid(urchin_lmer))
urchin_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(urchin_lmer)
#r-squared

emm_urchin_lmer_1 <- emmeans(urchin_lmer, ~ Site_long*Shelter)
pairs(emm_urchin_lmer_1)
# post-hoc tests

plot(allEffects(urchin_lmer), main = "Urchin trans")
# effects plots


## Urchin without interaction
qqnorm(resid(urchin_lmer_no_interaction, main = "Urchin no interaction Residual Plot"))
qqline(resid(urchin_lmer_no_interaction))
# qqplots

r.squaredGLMM(urchin_lmer_no_interaction)
#r-squared

emm_urchin_lmer_1 <- emmeans(urchin_lmer_no_interaction, ~ Site_long*Shelter)
pairs(emm_urchin_lmer_1, simple = "each")
# post-hoc tests

plot(allEffects(urchin_lmer_no_interaction), main = "Urchins no interaction")
# effects plots


## Urchin glmmTMB
png("outputs/Urchins glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_glmmTMB), main = "Urchin glmmTMB Residual Plot")
qqline(resid(urchin_glmmTMB))
urchin_fit_glmmTMB_regular_qq <- recordPlot()
dev.off()
# qqplots

DHARMa::testDispersion(urchin_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_glmmTMB, plot = T)
DHARMa::plotQQunif(simulationOutput)
urchin_fit_glmmTMB <- recordPlot()

png("outputs/Urchin biomass glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "Urchin glmmTMB DHARMa survival")
dev.off()

r.squaredGLMM(urchin_glmmTMB)
#r-squared

emm_urchin_lmer_1 <- emmeans(urchin_glmmTMB, ~ Site_long*Shelter)
pairs(emm_urchin_lmer_1, simple = "each")
# post-hoc tests

```

```{r Urchins Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
#################### Urchin barplot summary database and figures ################

### Summary Database
#plot_data_Site4 <- mean_urchin_totals2 %>%
 # group_by(Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_urchin = mean(urchin_biomass),
   #         sample_size = n())
# mean urchin biomass for each module over entire study
  
plot_data_Site4 <- mean_urchin_totals2 %>% 
  group_by(Site_long, Shelter) %>% 
  summarise(mean = mean(urchin_biomass),
            sd = std.dev.pop(urchin_biomass),
            lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            sample_size = n())
# mean urchin biomass for each treatment (n = 3)
## NOTE: changed the mean calculation from the summary database for the algae figure by taking out calculating module scale means and instead doing means for treatment and site level only


# reorder summary dataframe for plotting #
plot_data_Site4 <- plot_data_Site4[c(3,4,1,2),]
plot_data_Site4$Shelter <- factor(plot_data_Site4$Shelter, levels = c("Low", "High"))
plot_data_Site4$Site_long <- factor(plot_data_Site4$Site_long, levels = c("Waikiki", "Hanauma Bay"))

# ggplot2 barplot final #
position <- c("Waikiki", "Hanauma Bay")


### Plots
urchin_plot_final <- ggplot(data = plot_data_Site4, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Urchin bimass (kg/module)") +
  theme_classic(base_size = 18) +
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        axis.text.y = element_text(angle = 90, hjust = .45), axis.title.y = element_text(size = 16))

urchin_plot_final

urchin_plot_final2 <- ggplot(data = plot_data_Site4, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Urchin bimass (kg/module)") +
  theme_classic(base_size = 20) +
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        axis.text.y = element_text(angle = 90, hjust = .45),
        axis.text.x = element_blank(), axis.title.y = element_text(size = 18, vjust = 1, hjust = 0.5))

urchin_plot_final2


#################### Urchin time series summary database and figures ####################
### Summary Databases
## Time Series Plots ###
## Subsetting for time series figures ##
HAN_OPE_urchin <- mean_urchin_totals2 %>% filter(Site_long == "Hanauma Bay", Shelter == "Open")
HAN_CLO_urchin <- mean_urchin_totals2 %>% filter(Site_long == "Hanauma Bay", Shelter == "Closed")
WAI_OPE_urchin <- mean_urchin_totals2 %>% filter(Site_long == "Waikiki", Shelter == "Open")
WAI_CLO_urchin <- mean_urchin_totals2 %>% filter(Site_long == "Waikiki", Shelter == "Closed")


### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_urchin <- mean_urchin_totals2 %>%
  group_by(TimeStep, Shelter, Site_long) %>% 
  summarise(mean = mean(urchin_biomass),
            sd = std.dev.pop(urchin_biomass),
            lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            Date_new = mean(Date))

# add shelter column #
plot_data_urchin$Shelter <- factor(plot_data_urchin$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_urchin$Site_long <- factor(plot_data_urchin$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)



### Time Series Plots
urchin_time_series_plot <- ggplot(data = plot_data_urchin, aes(x = Date_new, y = mean, fill = Shelter, shape = Site_long)) + 
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c("white", "black"), guide = guide_legend(override.aes = list(shape = 21))) +
  guides(size = FALSE) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  expand_limits(x = as.Date(c("2017-05-15", "2020-04-01"))) +
  labs(x = "Date", y = "Urchin biomass (kg/module)") +
  theme_bw() + theme(text = element_text(size = 14), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), axis.text.y = element_text(angle = 90, hjust = .9), legend.title = element_text(size = rel(1.5)), legend.position = "none", axis.title.y = element_text(size = 16), axis.title = element_text(size = 16)) 

urchin_time_series_plot
```


```{r Herbivorous Fish Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

fish_data_hanauma <- read_csv("databases/CReME Fish Censuses HANAUMA MODULE 09-03-20_final.csv")
fish_data_waikiki <- read_csv("databases/CReME Fish Censuses WAIKIKI MODULE 09-03-20_final.csv")
fish_biomass_parameters <- read_csv("databases/Herbivorous Fish Biomass Parameters.csv")
timestep_year_log <- read_csv("databases/TimeStep_Year_log.csv")

# combine Hanauma and Waikiki fish data
fish_data_hanauma$Start <- as.numeric(fish_data_hanauma$Start)
fish_data_hanauma$End <- as.numeric(fish_data_hanauma$End)
fish_data_hanauma$Tot <- as.numeric(fish_data_hanauma$Tot)

fish_data_full <- rbind(fish_data_waikiki, fish_data_hanauma)


test_fish_data <- fish_data_full %>% gather(Size, Tot, `1`:`>100`) %>% 
  filter(TimeStep %in% timestep,
         `Reef` %in% modules,
         Size != ">100")

# filter for herbivorous fishes
test_fish_data <- test_fish_data %>% filter(Species %in% fish_taxa_with_transient) %>% 
  mutate(`Module #` = Reef)

# combine data with biomass parameters
fish_data <- left_join(test_fish_data, fish_biomass_parameters)

# Make biomass column and full text site and shelter treatment columns #
fish_data$Size <- as.numeric(fish_data$Size)
fish_data$alpha <- as.numeric(fish_data$alpha)
fish_data$beta <- as.numeric(fish_data$beta)

fish_data <- fish_data %>% mutate(Site_long = ifelse(Site == "WAI", "Waikiki", "Hanauma Bay")) %>% 
  mutate(Treatment_long = ifelse(Treat1 == "CLO", "Closed", "Open")) %>% 
  mutate(Shelter = ifelse(Treat1 == "CLO", "Low", "High")) %>% 
  mutate(Biomass = Tot*((alpha)*(Size^(beta)))/1000) %>% 
  # divide by 1000 to make biomass into kg
  mutate(Year_short = ifelse(Year == 2017, 17,
                       ifelse(Year == 2018, 18, 
                       ifelse(Year == 2019, 19,
                       ifelse(Year == 2020, 20, 20))))) %>% 
  filter(TimeStep %in% timestep)

fish_data$Year <- fish_data$Year_short

fish_data <- fish_data %>% 
  add_row(`Module #` = 216, TimeStep = 1, Tot = 0, Biomass = 0) %>% 
complete(`Module #`, TimeStep, fill = list(Tot = 0, Biomass = 0))
# adds row indicating a 0 biomass for herbivorous fish where measurements are missing from the database (aka no herbivorous fish were observed)

# Biomass summary without ACXA #
mean_fish_totals_2 <- fish_data %>% group_by(Date, Year, `Module #`, Site_long, Treatment_long, Shelter, TimeStep) %>% 
  summarize(total_biomass = sum(Biomass))


mean_fish_totals_2$new_date <- strptime(as.character(mean_fish_totals_2$Date), "%m/%d/%y")
mean_fish_totals_2$new_date <-  as.Date(mean_fish_totals_2$Date,'%m/%d/%y')
mean_fish_totals_2$Date <- mean_fish_totals_2$new_date
mean_fish_totals_2$Shelter <- factor(mean_fish_totals_2$Shelter, levels = c("Low", "High"), ordered = TRUE)

mean_fish_totals_2 <- mean_fish_totals_2 %>%
  ungroup() %>% 
  mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %% 2 == 0, "Low", "High")) %>% 
  dplyr::select(-Treatment_long, -new_date) 

# import date log for censuses
fish_urchin_dates <- read_csv("databases/Fish and Urchin Census Log.csv")
fish_urchin_dates$Date <- as.Date(fish_urchin_dates$Date, format = "%m/%d/%y")
fish_urchin_dates$TimeStep <- as.character(fish_urchin_dates$TimeStep)
                              
# merge data and census date log
fish_urchin_dates$TimeStep <- as.numeric(fish_urchin_dates$TimeStep)
fish_urchin_dates <- fish_urchin_dates %>% filter(`Module #` %in% modules)
mean_fish_totals_2$TimeStep <- as.numeric(mean_fish_totals_2$TimeStep)

mean_fish_totals_2 <- left_join(mean_fish_totals_2, fish_urchin_dates, by = c("Site_long", "Shelter", "Module #","TimeStep"))

mean_fish_totals_2 <- mean_fish_totals_2 %>% complete(`Module #`, TimeStep, fill = list(total_biomass = 0)) %>% 
    mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Fish_P_A = ifelse(total_biomass == 0, 0, 1))
# create season and herbivorous fish presense/absense column



mean_fish_totals_2$Date <- mean_fish_totals_2$Date.y
mean_fish_totals_2$Year <- mean_fish_totals_2$Year.y

```

```{r Herbivorous Fish Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Distribution
## Biomass Transformed Analyses
### Distributions
# transformation of biomass for analyses #
mean_fish_totals_2 <- mean_fish_totals_2 %>% mutate(total_biomass_trans = (total_biomass)^(0.25))

plotNormalHistogram(mean_fish_totals_2$total_biomass, main = "Herbivorous Fish Biomass")
plotNormalHistogram(mean_fish_totals_2$total_biomass_trans, main = "Herbivorous Fish Biomass Trans")

```

```{r Herbivorous Fish Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Herbivorous fish biomass with interaction
# variables
module_fish <- mean_fish_totals_2$`Module #`
mean_fish_totals_2$Shelter <- factor(mean_fish_totals_2$Shelter, levels = c("Low", "High"), ordered = TRUE)
mean_fish_totals_2$Site_long <- factor(mean_fish_totals_2$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
mean_fish_totals_2$total_biomass <- as.numeric(mean_fish_totals_2$total_biomass)


# lmer 
fish_lmer <- lmer(total_biomass_trans ~ Site_long*Shelter + (1|module_fish) + (1|Year/Season), data = mean_fish_totals_2, na.action = "na.fail")
summary(fish_lmer)



# Herbivorous fish with glmmTMB
fish_glmmTMB <- glmmTMB(total_biomass ~ Site_long*Shelter + (1|module_fish) + (1|Year/Season), data = mean_fish_totals_2, na.action = "na.fail", family = tweedie(link = "log"))
summary(fish_glmmTMB)


## Herbivorous fish biomass without interaction 
# lmer
fish_lmer_no_interaction <- lmer(total_biomass_trans ~ Site_long + Shelter + (1|module_fish) + (1|Year/Season), data = mean_fish_totals_2, na.action = "na.fail")
summary(fish_lmer_no_interaction)

# Combining urchin and herbivorous fish databases to look for correlations
urchin_vs_herbivorous_fish_data <- left_join(mean_fish_totals_2, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season", "Year"))

urchin_vs_herbivorous_fish_data <- urchin_vs_herbivorous_fish_data %>% filter(Site_long == "Hanauma Bay", Shelter == "High")

lm_urchin_vs_herbivorous_fish <- lm(total_biomass ~ urchin_biomass, data = urchin_vs_herbivorous_fish_data)
summary(lm_urchin_vs_herbivorous_fish)
```

```{r Herbivorous Fish Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analysis Assessment
## Fish with interaction
png("outputs/Herbivorous fish trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_lmer), main = "Fish trans Residuals")
qqline(resid(fish_lmer))
dev.off()

qqnorm(resid(fish_lmer), main = "Fish trans Residuals")
qqline(resid(fish_lmer))
fish_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(fish_lmer)
#r-squared

emm_fish_lmer_1 <- emmeans(fish_lmer, ~ Site_long*Shelter)
pairs(emm_fish_lmer_1)
# post-hoc tests

plot(allEffects(fish_lmer), main = "Herbivorous fish")
# effects plots


## Fish without interaction
qqnorm(resid(fish_lmer_no_interaction, main = "Fish no interaction Residual Plot"))
qqline(resid(fish_lmer_no_interaction))
# qqplots

r.squaredGLMM(fish_lmer_no_interaction)
#r-squared

emm_fish_lmer_1 <- emmeans(fish_lmer_no_interaction, ~ Site_long*Shelter)
pairs(emm_fish_lmer_1, simple = "each")
# post-hoc tests

plot(allEffects(fish_lmer_no_interaction), main = "Fish no interaction")
# effects plots


## fish glmmTMB
png("outputs/Herbivorous fish glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_glmmTMB), main = "Herbivorous fish glmmTMB Residual Plot")
qqline(resid(fish_glmmTMB))
fish_fit_glmmTMB_regular_qq <- recordPlot()
dev.off()
# qqplots


DHARMa::testDispersion(fish_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = fish_glmmTMB, plot = T)
DHARMa::plotQQunif(simulationOutput)
fish_fit_glmmTMB <- recordPlot()
dev.off()

png("outputs/Herbivorous fish biomass glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "Herbivorous fish glmmTMB DHARMa survival")
dev.off()

r.squaredGLMM(fish_glmmTMB)
#r-squared

emm_fish_lmer_1 <- emmeans(fish_glmmTMB, ~ Site_long*Shelter)
pairs(emm_fish_lmer_1, simple = "each")
# post-hoc tests
```

```{r Herbivorous Fish Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
#################### Herbivorous fish barplot summary database and figures ####################

### Summmary Dataframe
#plot_data_Site5 <- mean_fish_totals_2 %>%
 # group_by(Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_fish = mean(total_biomass),
   #         sample_size = n())
# mean urchin biomass for each module over entire study
  
plot_data_Site5 <- mean_fish_totals_2 %>% 
  group_by(Site_long, Shelter) %>% 
  summarise(mean = mean(total_biomass),
            sd = std.dev.pop(total_biomass),
            lower = mean(total_biomass) - std.error.pop(total_biomass),
            upper = mean(total_biomass) + std.error.pop(total_biomass),
            sample_size = n())
# mean urchin biomass for each treatment (n = 3)
## NOTE: changed the mean calculation from the summary database for the algae figure by taking out calculating module scale means and instead doing means for treatment and site level only


plot_data_Site5 <- plot_data_Site5[c(3,4,1,2),]
plot_data_Site5$Shelter <- factor(plot_data_Site5$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_Site5$Site_long <- factor(plot_data_Site5$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

position <- c("Waikiki", "Hanauma Bay")


### Plots
# plots #
## Biomass ##
fish_plot_2 <- ggplot(data = plot_data_Site5, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  #scale_y_continuous(breaks = seq(0, 0.05, 0.01)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
 # geom_text(aes(label = mult_compare5, y = plot_data_Site5$upper), vjust = -.5, position = position_dodge(width = 0.8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Herbivorous fish biomass (kg/module)") +
  theme_classic(base_size = 18) +
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5), axis.text.y = element_text(angle = 90),
        axis.title.y = element_text(size = 16))

fish_plot_2


fish_plot_3 <- ggplot(data = plot_data_Site5, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  #scale_y_continuous(breaks = seq(0, 0.05, 0.01)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
 # geom_text(aes(label = mult_compare5, y = plot_data_Site5$upper), vjust = -.5, position = position_dodge(width = 0.8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Herbivorous fish biomass (kg/module)") +
  theme_classic(base_size = 20) +
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5), axis.text.y = element_text(angle = 90, vjust = 1, hjust = 0.5),
        axis.text.x = element_blank(), axis.title.y = element_text(size = 18))

fish_plot_3


#################### Herbivorous fish time series summary database and figures ####################
### Summary Database
### Population SE ###
plot_data_fish <- mean_fish_totals_2 %>%
  group_by(Site_long, Shelter, TimeStep) %>% 
  summarise(mean = mean(total_biomass),
            sd = std.dev.pop(total_biomass),
            lower = mean(total_biomass) - std.error.pop(total_biomass),
            upper = mean(total_biomass) + std.error.pop(total_biomass),
            Date_new = mean(Date)) 

plot_data_fish$Shelter <- factor(plot_data_fish$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_fish$Site_long <- factor(plot_data_fish$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)




### Time Series Plots
## cropped plot for combined figure ##
fish_time_series_plot <- ggplot(data = plot_data_fish, aes(x = Date_new, y = mean, fill = Shelter, shape = Site_long)) + 
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c("white", "black"), guide = guide_legend(override.aes = list(shape = 21))) +
  guides(size = FALSE) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  expand_limits(x = as.Date(c("2017-05-15", "2020-04-01"))) +
  labs(x = "Date", y = "Herbivorous fish biomass (kg/module)") +
  theme_classic(base_size = 13) +
  theme_bw() + theme(text = element_text(size = 14), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), axis.text.y = element_text(angle = 90), legend.title = element_text(size = rel(1.5)), legend.position = "none", axis.title.y = element_text(size = 16), axis.title = element_text(size = 16))

fish_time_series_plot
```


```{r Benthic Algal Code Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

cover_code_data <- sub_2 %>% filter(`Cover Code` != "?") %>% 
  # filter out corals where there were question marks in cover code column
  filter(!is.na(`Cover Code`),
         # filter out corals where there were NA for cover code
         !`Status Code` %in% exclusion,
         # filter out corals that died
         TimeStep %in% timestep,
         Side %in% side,
         `Module #` %in% modules) %>% 
  filter(`Max Diameter (mm)` <= 20)
        # filter out corals that were greater than 20 mm in diameter
cover_code_data$cover_code <- as.numeric(cover_code_data$`Cover Code`)


cover_code_data <- cover_code_data %>% mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))


cover_code_data_raw <- cover_code_data
## NOTE: saved a raw version of the cover database to run lmer model on all measurements and to create a summary database for plotting that is not a mean of means for cover code (mean only calculated on the treatment and site scale)

cover_code_data_raw <- cover_code_data_raw %>% mutate(Date = as.Date(cover_code_data_raw$Date,'%m/%d/%y'))
# changed the date column format so that mean dates can be calculated

cover_code_data_raw$Site_long <- factor(cover_code_data_raw$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
cover_code_data_raw$Shelter <- factor(cover_code_data_raw$Shelter, levels = c("Low", "High"), ordered = TRUE)



cover_code_data <- cover_code_data %>% group_by(Site_long, Shelter, `Module #`, TimeStep, Season, Year) %>% 
  summarize(mean_cover_code = mean(cover_code))
# Mean algal cover code database for each timestep on the module scale


date_data <- read_csv("databases/Coral Census Date Log.csv")

date_data$Date <- as.Date(date_data$Date,'%m/%d/%y')
date_data$`Module #` <- as.numeric(date_data$`Module #`)

date_data_new <- date_data %>% group_by(`Module #`, Site_long, Shelter, TimeStep, Year) %>% 
  summarize(Date_new = mean(Date))
# calculate mean dates for surveys in which censuses took place over multiple days


date_data_new$`Module #` <- as.factor(date_data_new$`Module #`)
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
cover_code_data$Year <- as.numeric(cover_code_data$Year)

cover_code_data <- left_join(cover_code_data, date_data_new, by = c("Module #", "Site_long", "Shelter", "TimeStep", "Year"))

cover_code_data$Site_long <- factor(cover_code_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
cover_code_data$Shelter <- factor(cover_code_data$Shelter, levels = c("Low", "High"), ordered = TRUE)


############### Urchin vs cover code database ###############
mean_urchin_totals2$TimeStep <- as.numeric(mean_urchin_totals2$TimeStep)
cover_code_data$TimeStep <- as.numeric(cover_code_data$TimeStep)
mean_urchin_totals2$`Module #` <- as.factor(mean_urchin_totals2$`Module #`)
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
cover_code_data$Site_long <- factor(cover_code_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
cover_code_data$Shelter <- factor(cover_code_data$Shelter, levels = c("Low", "High"), ordered = TRUE)
cover_code_data$Year <- as.numeric(cover_code_data$Year)

urchin_vs_cover_data <- left_join(mean_urchin_totals2, cover_code_data)

urchin_vs_cover_data <- urchin_vs_cover_data %>% filter(!is.na(mean_cover_code)) %>% 
  mutate(mean_cover_code_trans = log(mean_cover_code))


############# Herbivorous fish biomass vs algae cover code database ##############
mean_fish_totals_2$TimeStep <- as.numeric(mean_fish_totals_2$TimeStep)
cover_code_data$TimeStep <- as.numeric(cover_code_data$TimeStep)
mean_fish_totals_2$`Module #` <- as.factor(mean_fish_totals_2$`Module #`)
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
mean_fish_totals_2$Year <- as.numeric(mean_fish_totals_2$Year)
cover_code_data$Site_long <- factor(cover_code_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
cover_code_data$Shelter <- factor(cover_code_data$Shelter, levels = c("Low", "High"), ordered = TRUE)

fish_vs_cover_data <- left_join(mean_fish_totals_2, cover_code_data)

fish_vs_cover_data <- fish_vs_cover_data %>% filter(!is.na(mean_cover_code))


############ Urchin and herbivorous fish biomass v algae cover code database ###########
urchin_and_fish_database <- left_join(mean_urchin_totals2, mean_fish_totals_2)

urchin_and_fish_database <- urchin_and_fish_database %>% filter(!is.na(total_biomass))

urchin_and_fish_vs_algae_database <- left_join(urchin_and_fish_database, cover_code_data)

urchin_and_fish_vs_algae_database <- urchin_and_fish_vs_algae_database %>% filter(!is.na(mean_cover_code))


```

```{r Benthic Algal Code Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

module_algae <- cover_code_data_raw$`Module #`
id_code_algae <- as.factor(cover_code_data_raw$ID)

cover_code_data_raw <- cover_code_data_raw %>% mutate(cover_code_trans = (`Cover Code`)^(0.25))

plotNormalHistogram(cover_code_data_raw$cover_code, main = "Benthic Algal Code")
plotNormalHistogram(cover_code_data_raw$cover_code_trans, main = "Benthic Algal Code Trans")

```

```{r Benthic Algal Code Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
########## ordinal cumulative link mixed model
#cover_code_data_raw$cover_code <- factor(cover_code_data_raw$cover_code, levels = c(1,2,3,4), ordered = TRUE)

#cover_code_clmm2 <- clmm2(cover_code ~ Site_long*Shelter + (1|module_algae), data = cover_code_data_raw, na.action = "na.fail")
#summary(cover_code_clmm2)

########## Benthic algal code #############


### Algae cover code analyses
cover_code_lmer <- lmer(cover_code_trans ~ Site_long*Shelter + (1|module_algae) +  (1|Year/Season) + (1|id_code_algae), data = cover_code_data_raw, na.action = "na.fail")
summary(cover_code_lmer)

r.squaredGLMM(cover_code_lmer)


### Algae cover code analyses without interaction
cover_code_lmer_no_interaction <- lmer(`Cover Code` ~ Site_long + Shelter + (1|module_algae) +  (1|Year/Season), data = cover_code_data_raw, na.action = "na.fail")
summary(cover_code_lmer_no_interaction)


#################### Benthic algal code vs herbivore biomass ####################
### Combined herbivore biomass vs cover code full model 
module_urchin_and_fish_biomass_vs_algae <- urchin_and_fish_vs_algae_database$`Module #`

# lmer herbivores combined full model
herbivore_biomass_vs_algae_lmer <- lmer(mean_cover_code ~ urchin_biomass + total_biomass + Site_long*Shelter + (1|module_urchin_and_fish_biomass_vs_algae) + (1|Year/Season), data = urchin_and_fish_vs_algae_database, na.action = "na.fail")
summary(herbivore_biomass_vs_algae_lmer)

effect(herbivore_biomass_vs_algae_lmer)

# lmer with urchin and herbivorous fish biomass only
herbivore_biomass_vs_algae_lmer_only <- lmer(mean_cover_code ~ urchin_biomass + total_biomass +  (1|module_urchin_and_fish_biomass_vs_algae) + (1|Year/Season), data = urchin_and_fish_vs_algae_database, na.action = "na.fail")
summary(herbivore_biomass_vs_algae_lmer_only)

### Urchin vs cover code full model
urchin_vs_cover_data$Shelter <- factor(urchin_vs_cover_data$Shelter, levels = c("Low", "High"), ordered = TRUE)
urchin_vs_cover_data$Site_long <- factor(urchin_vs_cover_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
module_urchin_vs_algae <- urchin_vs_cover_data$`Module #`

urchin_vs_cover_data_lmer <- lmer(mean_cover_code ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_vs_algae) + (1|Year/Season), data = urchin_vs_cover_data, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer)





### Urchin vs cover code without interaction full model
urchin_vs_cover_data$Shelter <- factor(urchin_vs_cover_data$Shelter, levels = c("Low", "High"), ordered = TRUE)
urchin_vs_cover_data$Site_long <- factor(urchin_vs_cover_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

urchin_vs_cover_data_lmer_no_interaction <- lmer(mean_cover_code ~ urchin_biomass + Site_long + Shelter + (1|module_urchin_vs_algae) + (1|Year/Season), data = urchin_vs_cover_data, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer_no_interaction)


### Urchin vs cover code with significant variables and urchin biomass
urchin_vs_cover_data_lmer_sig <- lmer(mean_cover_code ~ urchin_biomass + Site_long + (1|module_urchin_vs_algae) + (1|Year/Season), data = urchin_vs_cover_data, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer_sig)

### Urchin vs cover code only
urchin_vs_cover_data_lmer_only <- lmer(mean_cover_code ~ urchin_biomass + (1|module_urchin_vs_algae) + (1|Year/Season), data = urchin_vs_cover_data, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer_only)

qqnorm(resid(urchin_vs_cover_data_lmer_only, main = "Algae cover code Residual Plot"))
qqline(resid(urchin_vs_cover_data_lmer_only))

r.squaredGLMM(urchin_vs_cover_data_lmer_only)

### Urchin vs cover code only P/A
urchin_vs_cover_data_lmer_only_P_A <- lmer(mean_cover_code ~ urchin_P_A + Site_long*Shelter + (1|module_urchin_vs_algae) + (1|Year/Season), data = urchin_vs_cover_data, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer_only_P_A)

### Urchin vs cover code only >0
urchin_vs_cover_data_above_0 <- urchin_vs_cover_data %>% filter(urchin_P_A == 1)
module_urchin_vs_algae_above_0 <- urchin_vs_cover_data_above_0$`Module #`

urchin_vs_cover_data_lmer_only_above_0 <- lmer(mean_cover_code ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_vs_algae_above_0) + (1|Year/Season), data = urchin_vs_cover_data_above_0, na.action = "na.fail")
summary(urchin_vs_cover_data_lmer_only_above_0)


### Herbivorous fish vs. cover code full model
fish_vs_cover_data$Shelter <- factor(fish_vs_cover_data$Shelter, levels = c("Low", "High"), ordered = TRUE)
fish_vs_cover_data$Site_long <- factor(fish_vs_cover_data$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
module_fish_vs_algae <- fish_vs_cover_data$`Module #`

fish_vs_cover_data_lmer <- lmer(mean_cover_code ~ total_biomass + Site_long*Shelter + (1|module_fish_vs_algae) + (1|Year/Season), data = fish_vs_cover_data, na.action = "na.fail")
summary(fish_vs_cover_data_lmer)

### Herbivorous fish vs. cover code without interaction full model
fish_vs_cover_data_lmer_no_interaction <- lmer(mean_cover_code ~ total_biomass + Site_long + Shelter + (1|module_fish_vs_algae) + (1|Year/Season), data = fish_vs_cover_data, na.action = "na.fail")
summary(fish_vs_cover_data_lmer_no_interaction)
# full model without interaction term

### Herbivours fish vs. cover code with significant variables and fish biomass
fish_vs_cover_data_lmer_sig <- lmer(mean_cover_code ~ total_biomass + Site_long + (1|module_fish_vs_algae) + (1|Year/Season), data = fish_vs_cover_data, na.action = "na.fail")
summary(fish_vs_cover_data_lmer_sig)

### Herbivours fish vs. cover code only
fish_vs_cover_data_lmer_only <- lmer(mean_cover_code ~ total_biomass + (1|module_fish_vs_algae) + (1|Year/Season), data = fish_vs_cover_data, na.action = "na.fail")
summary(fish_vs_cover_data_lmer_only)
# fish biomass only

r.squaredGLMM(fish_vs_cover_data_lmer_only)

### Herbivours fish vs. cover code only P/A
fish_vs_cover_data_lmer_only_P_A <- lmer(mean_cover_code ~ Fish_P_A + Site_long*Shelter + (1|module_fish_vs_algae) + (1|Year/Season), data = fish_vs_cover_data, na.action = "na.fail")
summary(fish_vs_cover_data_lmer_only_P_A)

### Herbivours fish vs. cover code only >0
fish_vs_cover_data_above_0 <- fish_vs_cover_data %>% filter(Fish_P_A == 1)
module_fish_vs_algae_above_0 <- fish_vs_cover_data_above_0$`Module #`

fish_vs_cover_data_lmer_only_above_0 <- lmer(mean_cover_code ~ total_biomass + Site_long*Shelter + (1|module_fish_vs_algae_above_0) + (1|Year/Season), data = fish_vs_cover_data_above_0, na.action = "na.fail")
summary(fish_vs_cover_data_lmer_only_above_0)


```

```{r Benthic Algal Code Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
########### Benthic algal code ###################

## cover code with interaction
png("outputs/Algae raw trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(cover_code_lmer), main = "Algae raw cover code trans Residuals")
qqline(resid(cover_code_lmer))
dev.off()

qqnorm(resid(cover_code_lmer), main = "Algae raw cover code trans Residuals")
qqline(resid(cover_code_lmer))
algae_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(cover_code_lmer)
#r-squared

em <- emmeans(cover_code_lmer, ~ Site_long*Shelter)
pairs(em, simple = "each")
# pairwise multiple comparisons

plot(allEffects(cover_code_lmer), main = "Algae raw trans")
# effects plots


## cover_code_lmer_no_interaction
qqnorm(resid(cover_code_lmer_no_interaction, main = "Algae cover code no interaction Residual Plot"))
qqline(resid(cover_code_lmer_no_interaction))
# qqplots

r.squaredGLMM(cover_code_lmer_no_interaction)
#r-squared

em <- emmeans(cover_code_lmer_no_interaction, ~ Site_long*Shelter)
pairs(em)
# pairwise multiple comparisons

plot(allEffects(cover_code_lmer_no_interaction))
# effects plots


############## Benthic algal code vs herbivore biomass #################

## Urchin without interaction
qqnorm(resid(urchin_vs_cover_data_lmer_only, main = "Urchin vs cover code Residual Plot"))
qqline(resid(urchin_vs_cover_data_lmer_only))
# qqplots

r.squaredGLMM(urchin_vs_cover_data_lmer_only)
#r-squared


plot(allEffects(urchin_vs_cover_data_lmer_only), main = "Urchins vs cover code")
# effects plots


## Fish without interaction
qqnorm(resid(fish_vs_cover_data_lmer_only, main = "Fish vs algae Residual Plot"))
qqline(resid(fish_vs_cover_data_lmer_only))
# qqplots

r.squaredGLMM(fish_vs_cover_data_lmer_only)
#r-squared

plot(allEffects(fish_vs_cover_data_lmer_only), main = "Fish vs algae")
# effects plots


## Urchin and Fish
png("outputs/Urchin and Herbivorous fish biomass vs. algae fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(herbivore_biomass_vs_algae_lmer), main = "Urchin and herbivorous fish vs algae Residuals")
qqline(resid(herbivore_biomass_vs_algae_lmer))
dev.off()
# qqplots

r.squaredGLMM(herbivore_biomass_vs_algae_lmer)
#r-squared

plot(allEffects(herbivore_biomass_vs_algae_lmer), main = "Urchins and herbivorous fish vs algae")
# effects plots
```


```{r Benthic Algal Code Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
#################### Benthic algal code barplot summary database and figures ####################



## Module level means for cover code
#plot_data_cover_test2 <- cover_code_data %>%
 # group_by(Site_long, Shelter, `Module #`) %>% 
  #summarise(mean = mean(mean_cover_code),
   #         sd = std.dev.pop(mean_cover_code), 
    #        lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
     #       upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
      #      sample_size = n())


## Site and Shelter level means for cover code (The database to be used)
plot_data_cover_final <- cover_code_data_raw %>%
  group_by(Site_long, Shelter) %>% 
  summarise(mean_new = mean(`Cover Code`),
            sd_new = std.dev.pop(`Cover Code`), 
            lower_new = mean(`Cover Code`) - std.error.pop(`Cover Code`),
            upper_new = mean(`Cover Code`) + std.error.pop(`Cover Code`),
            sample_size = n())
## NOTE: changed the mean calculation from the summary database for the algae figure by taking out calculating module scale means and instead doing means for treatment and site level only



plot_data_cover_final$Shelter <- factor(plot_data_cover_final$Shelter, levels = c("Low", "High"))


### COVER CODE PLOT
position <- c("Waikiki", "Hanauma Bay")

plot_cover_combined_plot0 <- ggplot(data = plot_data_cover_final, aes(fill=Shelter, y=mean_new, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower_new, ymax = upper_new), position = position_dodge(.8), width = 0, size = 1.5) +
        #geom_text(aes(label = mult_compare_cover_new, y = plot_data_cover_final$upper_new), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Algal overgrowth (1-4)"))) + 
        theme_classic(base_size = 14.5) +
        theme(text = element_text(size = 18), axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90), axis.title.y = element_text(size = 16))

plot_cover_combined_plot0


plot_cover_combined_plot <- ggplot(data = plot_data_cover_final, aes(fill=Shelter, y=mean_new, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = 0.8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower_new, ymax = upper_new), position = position_dodge(.8), width = 0, size = 1.5) +
        #geom_text(aes(label = mult_compare_cover_new, y = plot_data_cover_final$upper_new), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Algal overgrowth (1-4)"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, vjust = 1, hjust = 0.5), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))

plot_cover_combined_plot


################ Benthic algal code time series summary database and figures ###########

### Summary Databases
cover_code_data_raw_test <- cover_code_data_raw %>% mutate(Date = as.Date(Date))

plot_data_algae_all_cover_code <- cover_code_data_raw %>%
  group_by(TimeStep, Site_long, Shelter) %>% 
  summarise(mean = mean(`Cover Code`),
            sd = std.dev.pop(`Cover Code`),
            lower = mean(`Cover Code`) - std.error.pop(`Cover Code`),
            upper = mean(`Cover Code`) + std.error.pop(`Cover Code`),
            Date_final = mean(Date))

plot_data_algae_all_cover_code$Site_long <- factor(plot_data_algae_all_cover_code$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
plot_data_algae_all_cover_code$Shelter <- factor(plot_data_algae_all_cover_code$Shelter, levels = c("Low", "High"), ordered = TRUE)


### Time Series Plots
### algae_total full plot  ###
### cropped plot for combined figure cover code

algae_time_series_plot_cover_code <- ggplot(data = plot_data_algae_all_cover_code, aes(x = Date_final, y = mean, fill = Shelter, shape = Site_long)) + 
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c("white", "black"), guide = guide_legend(override.aes = list(shape = 21))) +
  guides(size = FALSE) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  scale_y_continuous(breaks=seq(1, 4, 0.5)) +
  labs(x = "Date", y = "Algal overgrowth (1-4)") +
  theme_classic(base_size = 13) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), axis.text.y = element_text(angle = 90), legend.title = element_text(size = rel(1.5)), legend.position = "none", axis.title.y = element_text(size = 16), axis.title = element_text(size = 16), plot.margin = margin(10,11,10,9))

algae_time_series_plot_cover_code


################ Benthic algal code vs. herbivore biomass summary databases and figures ################

### Urchin vs cover code without timesteps (12 points, 1 for each module)
urchin_vs_cover_data_mod <- urchin_vs_cover_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_cover_code_new = mean(mean_cover_code),
            cover_sd = std.dev.pop(mean_cover_code),
            cover_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            cover_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code))

urchin_vs_cover_data_mod <- urchin_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

urchin_vs_cover_code_mod_lm <- lm(mean_cover_code_new ~ mean_urchin, data = urchin_vs_cover_data_mod, na.action = "na.fail")
summary(urchin_vs_cover_code_mod_lm)

## Plot lmer with CI 
urchin_vs_cover_code_mod_lmer_plot <- ggplot(data = urchin_vs_cover_data_mod, aes(x = mean_urchin, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_cover_data_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot without trendline (non-significant result)
urchin_vs_cover_code_mod_plot_no_trend <- ggplot(data = urchin_vs_cover_data_mod, aes(x = mean_urchin, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot with CI 
urchin_vs_cover_code_mod_plot <- ggplot(data = urchin_vs_cover_data_mod, aes(x = mean_urchin, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot without CI
urchin_vs_cover_code_mod_plot_no_CI <- ggplot(data = urchin_vs_cover_data_mod, aes(x = mean_urchin, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot raw data without trendline
urchin_vs_cover_code_plot_no_trend <- ggplot(data = urchin_vs_cover_data, aes(x = urchin_biomass, y = mean_cover_code, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot raw data with trendline
urchin_vs_cover_code_plot <- ggplot(data = urchin_vs_cover_data, aes(x = urchin_biomass, y = mean_cover_code, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))


### Herbivorous fish vs cover code without timesteps (11 points, 1 for each module)
fish_vs_cover_data_mod <- fish_vs_cover_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_cover_code_new = mean(mean_cover_code),
            cover_sd = std.dev.pop(mean_cover_code),
            cover_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            cover_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code))

fish_vs_cover_data_mod <- fish_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))


fish_vs_cover_code_mod_lm <- lm(mean_cover_code_new ~ mean_fish, data = fish_vs_cover_data_mod, na.action = "na.fail")
summary(fish_vs_cover_code_mod_lm)


# Plot lmer trendline
fish_vs_cover_code_mod_lmer_plot <- ggplot(data = fish_vs_cover_data_mod, aes(x = mean_fish, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_cover_data_lmer_only)))) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Algal overgrowth (1-4)") +
 # coord_cartesian(xlim = c(0, 0.1), ylim = c(1.1, 1.8)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot trendline
fish_vs_cover_code_mod_plot <- ggplot(data = fish_vs_cover_data_mod, aes(x = mean_fish, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Algal overgrowth (1-4)") +
 # coord_cartesian(xlim = c(0, 0.1), ylim = c(1.1, 1.8)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot without trendline
fish_vs_cover_code_mod_plot_no_trend <- ggplot(data = fish_vs_cover_data_mod, aes(x = mean_fish, y = mean_cover_code_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = cover_lower, ymax = cover_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  #coord_cartesian(xlim = c(0, 0.1), ylim = c(1.1, 1.8)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))


## Plot raw data without trendline
fish_vs_cover_code_plot_no_trend <- ggplot(data = fish_vs_cover_data, aes(x = total_biomass, y = mean_cover_code, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  #coord_cartesian(xlim = c(0, 0.1), ylim = c(1.1, 1.8)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

## Plot raw data with trendline
fish_vs_cover_code_plot <- ggplot(data = fish_vs_cover_data, aes(x = total_biomass, y = mean_cover_code, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Algal overgrowth (1-4)") +
  #coord_cartesian(xlim = c(0, 0.1), ylim = c(1.1, 1.8)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))
```


```{r Benthic Cover Database Table with Means and SE, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Benthos on modules ###
cover_data <- read.csv("databases/CoralNet Data 4.csv")

## Database Construction ##
# Benthic Algae
cover_data$Label[cover_data$Label == "*RDMA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "*BRMA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "*GRMA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "*PADI"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "Dicsp"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "Dictyosph"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "EMA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "FMA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "MAFB"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "MA"] <- "Macroalgae"
cover_data$Label[cover_data$Label == "CCA"] <- "Crustose coralline algae"
cover_data$Label[cover_data$Label == "T"] <- "Turf"


# Invertebrates
cover_data$Label[cover_data$Label == "A"] <- "Ascidians/Bryozoans/Sponges"
cover_data$Label[cover_data$Label == "Brz"] <- "Ascidians/Bryozoans/Sponges"
cover_data$Label[cover_data$Label == "Sponge"] <- "Ascidians/Bryozoans/Sponges"
cover_data$Label[cover_data$Label == "Hydra"] <- "Hydroids"
cover_data$Label[cover_data$Label == "W"] <- "Worms"
cover_data$Label[cover_data$Label == "C"] <- "Corals"

# Substrate
cover_data$Label[cover_data$Label == "B"] <- "Bare substrate"


cover_data <- cover_data %>%  mutate(Treatment = ifelse(`Module` %in% c(1,3,5,7,9,11), "OPE", "CLO")) %>% 
  filter(Side %in% side,
         TimeStep %in% timestep) 

benthos_cover_data <- cover_data %>% group_by(Date, TimeStep, Site, Treatment, Module, Label) %>%
  tally()

benthos_cover_data <- benthos_cover_data %>% ungroup() %>% 
  complete(Module, Label, TimeStep, fill = list(n = 0))


benthos_cover_data$Label <- as.character(benthos_cover_data$Label)

benthos_cover_data_test <- benthos_cover_data %>% group_by(TimeStep, Module) %>% 
  summarize(`nn` = sum(n))


benthos_cover_data_final <- benthos_cover_data_test %>% left_join(benthos_cover_data, benthos_cover_data_test, by = c("Module", "TimeStep")) %>%
  mutate(percent_cover = n/`nn`) %>% 
  ungroup()


benthos_cover_data_final <- benthos_cover_data_final %>% mutate(`Module #` = if_else(Module == 1, 111,
                                                                 if_else(Module == 2, 112,
                                                                         if_else(Module == 3, 113,
                                                                                 if_else(Module == 4, 114,
                                                                                         if_else(Module == 5, 115,
                                                                                                 if_else(Module == 6, 116,
                                                                                                         if_else(Module == 7, 211,
                                                                                                                 if_else(Module == 8, 212,
                                                                                                                         if_else(Module == 9, 213,
                                                                                                                                 if_else(Module == 10, 214,
                                                                                                                                         if_else(Module == 11, 215,
                                                                                                                                                 if_else(Module == 12, 216, 216))))))))))))) %>% 
                          
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Site_long = ifelse(Module %in% c(1,2,3,4,5,6), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(Module %in% c(1,3,5,7,9,11), "High", "Low")) %>% 
  select(-Date, -Site, -Treatment) 


benthos_cover_data_final$Site_long <- factor(benthos_cover_data_final$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
benthos_cover_data_final$Shelter <- factor(benthos_cover_data_final$Shelter, levels = c("Low", "High"), ordered = TRUE)


### Summary database with calculated means and standard errors for all labels
benthos_cover_data_final_summary <- benthos_cover_data_final %>% group_by(Label, Site_long, Shelter) %>% 
summarize(mean = round(mean(percent_cover*100), 2),
            percent_error_plus_minus = round(std.error.pop(percent_cover*100), 2)) 


### Make a wide table for publication
benthos_cover_data_final_summary_table <- benthos_cover_data_final_summary %>% 
  as_tibble() %>%
    pivot_wider(names_from = c(Site_long,Shelter), values_from = c(mean, percent_error_plus_minus)) %>% 
  unite(col = "Waikk-Low", mean_Waikiki_Low, percent_error_plus_minus_Waikiki_Low, sep = "  ") %>% 
  unite(col = "Waikk-High", mean_Waikiki_High, percent_error_plus_minus_Waikiki_High, sep = "  ") %>% 
  unite(col = "Hanauma Bay-Low", `mean_Hanauma Bay_Low`,  `percent_error_plus_minus_Hanauma Bay_Low`, sep = "  ") %>%
  unite(col = "Hanauma Bay-High", `mean_Hanauma Bay_High`,  `percent_error_plus_minus_Hanauma Bay_High`, sep = "  ")


tab_df(benthos_cover_data_final_summary_table, file = "outputs/Module Benthic Algae and Invertebrate Percent Cover Table.html")


```


```{r Benthic Algal Cover Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Algae Database
#################### Benthic algal cover ##############################
cover_data <- read.csv("databases/CoralNet Data 4.csv")

## Database Construction ##
# Macroalgae
cover_data$Label[cover_data$Label == "*RDMA"] <- "MA"
cover_data$Label[cover_data$Label == "*BRMA"] <- "MA"
cover_data$Label[cover_data$Label == "*GRMA"] <- "MA"
cover_data$Label[cover_data$Label == "*PADI"] <- "MA"
cover_data$Label[cover_data$Label == "Dicsp"] <- "MA"
cover_data$Label[cover_data$Label == "Dictyosph"] <- "MA"
cover_data$Label[cover_data$Label == "EMA"] <- "MA"
cover_data$Label[cover_data$Label == "FMA"] <- "MA"
cover_data$Label[cover_data$Label == "MAFB"] <- "MA"

cover_data <- cover_data %>%  mutate(Treatment = ifelse(`Module` %in% c(1,3,5,7,9,11), "OPE", "CLO")) %>% 
  filter(Side %in% side,
         TimeStep %in% timestep)

MA_cover_data <- cover_data %>% group_by(Date, TimeStep, Site, Treatment, Module, Label) %>%
  tally()

MA_cover_data <- MA_cover_data %>% ungroup() %>% 
  complete(Module, Label, TimeStep, fill = list(n = 0))

MA_cover_data$Label <- as.character(MA_cover_data$Label)

MA_cover_data_test <- MA_cover_data %>% group_by(Date, TimeStep, Site, Treatment, Module) %>% 
  summarize(`nn` = sum(n)) %>% 
  drop_na(Date)


MA_cover_final <- MA_cover_data_test %>% left_join(MA_cover_data, MA_cover_data_test, by = c("Date", "Site", "Module", "TimeStep", "Treatment")) %>% 
  mutate(percent_cover = n/`nn`) %>% 
  ungroup()


MA_cover_final <- MA_cover_final %>% group_by(Date, TimeStep, Site, Treatment, Module) %>% 
  filter(Label %in% label) %>% 
  summarise(combined_cover = sum(percent_cover)) %>% 
  ungroup()


### USE ONLY IF YOU ARE KEEPING LABELS TO HAVE SEPERATE % COVER VALUES
# MA_cover_final <- MA_cover_final %>% group_by(Site) %>% 
#  complete(Label, Side, Module, nesting(Date), fill = list(n = 0, percent_cover = 0)) 
# Label specific databases #
# MA_cover_final$n <- as.numeric(MA_cover_final$n)
# MA_cover_final$`nn` <- as.numeric(MA_cover_final$`nn`)
# MA_cover_final$Date <- as.character(MA_cover_final$Date)

# MA_cover_final_side_combined <- MA_cover_final %>% group_by(Year, Date, TimeStep, Shelter, Site_long, `Module #`, Label) %>% 
#  summarise(n = sum(n), 
 #           nn = sum(nn)) %>% 
#  mutate(percent_cover = n/(`nn`)) %>% 
 # ungroup()

# MA_cover_final <- MA_cover_final %>% replace_na(list(`nn` = 50))


## Add in  ##
MA_cover_final <- MA_cover_final %>% 
  mutate(Date_new = as.Date(Date,'%m/%d/%y')) %>% 
  mutate(Year = format(as.Date(Date_new, format="%d/%m/%y"),"%y")) %>% 
  dplyr::select(-Date) %>% 
  mutate(Date = Date_new) %>% 
  mutate(Treatment_long = if_else(Treatment == "OPE", "Open", "Closed")) %>% 
  mutate(Shelter = if_else(Treatment == "OPE", "High", "Low")) %>% 
  mutate(Site_long = as.factor(if_else(Site == "WAI", "Waikiki", "Hanauma Bay")))


#MA_cover_final$Side <- factor(MA_cover_final$Side, levels = c("N", "S"))


### T, MA, and CCA Databases
# Databases
MA_cover_final <- MA_cover_final %>% mutate(`Module #` = if_else(Module == 1, 111,
                                                                 if_else(Module == 2, 112,
                                                                         if_else(Module == 3, 113,
                                                                                 if_else(Module == 4, 114,
                                                                                         if_else(Module == 5, 115,
                                                                                                 if_else(Module == 6, 116,
                                                                                                         if_else(Module == 7, 211,
                                                                                                                 if_else(Module == 8, 212,
                                                                                                                         if_else(Module == 9, 213,
                                                                                                                                 if_else(Module == 10, 214,
                                                                                                                                         if_else(Module == 11, 215,
                                                                                                                                                 if_else(Module == 12, 216, 216))))))))))))) %>% 
                          
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) 

MA_cover_final$Year <- as.numeric(MA_cover_final$Year)


############## Benthic algal cover vs urchin biomass ################
mean_urchin_totals2$TimeStep <- as.numeric(mean_urchin_totals2$TimeStep)
MA_cover_final$TimeStep <- as.numeric(MA_cover_final$TimeStep)
mean_urchin_totals2$`Module #` <- as.factor(mean_urchin_totals2$`Module #`)
MA_cover_final$`Module #` <- as.factor(MA_cover_final$`Module #`)
MA_cover_final$Site_long <- factor(MA_cover_final$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

urchin_vs_algae_data <- left_join( mean_urchin_totals2, MA_cover_final, by = c("TimeStep", "Year", "Shelter", "Site_long"))


#urchin_vs_algae_data <- left_join(MA_cover_final, mean_urchin_totals2, by = c("TimeStep", "Year", "Shelter", "Site_long", "Module #"))

#urchin_vs_algae_data <- urchin_vs_algae_data %>% drop_na(urchin_biomass) %>% 
 # filter(Label == "T")

#module <- urchin_vs_algae_data$`Module #`
#urchin_vs_algae_data$Season <- urchin_vs_algae_data$Season.x


urchin_vs_algae_data <- urchin_vs_algae_data %>% drop_na(combined_cover)
urchin_vs_algae_data$Season <- urchin_vs_algae_data$Season.x


########### Banthic algal cover vs herbivorous fish biomass ################
mean_fish_totals_2$TimeStep <- as.numeric(mean_fish_totals_2$TimeStep)
MA_cover_final$TimeStep <- as.numeric(MA_cover_final$TimeStep)
mean_fish_totals_2$`Module #` <- as.factor(mean_fish_totals_2$`Module #`)
MA_cover_final$`Module #` <- as.factor(MA_cover_final$`Module #`)
mean_fish_totals_2$Site_long <- as.factor(mean_fish_totals_2$Site_long)

herbivorous_fish_vs_algae <- left_join(mean_fish_totals_2, MA_cover_final, by = c("TimeStep", "Year", "Shelter", "Site_long"))

herbivorous_fish_vs_algae <- herbivorous_fish_vs_algae %>% drop_na(combined_cover)
herbivorous_fish_vs_algae$Season <- herbivorous_fish_vs_algae$Season.x
```

```{r Benthic Algal Code and Benthic Algal Cover Correlation, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#MA_cover_final$Site_long <- factor(MA_cover_final$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

algae_corr_database <- left_join(cover_code_data, MA_cover_final, by = c("Site_long", "Shelter", "Module #", "TimeStep", "Season", "Year"))

algae_corr_database <- algae_corr_database %>% filter(!is.na(combined_cover))

algae_corr_module <- algae_corr_database$`Module #`

algae_corr_lm <- lm(mean_cover_code ~ combined_cover, data = algae_corr_database)
summary(algae_corr_lm)

algae_corr_lmer <- lmer(mean_cover_code ~ combined_cover + (1|algae_corr_module) + (1|Year/Season), data = algae_corr_database)
summary(algae_corr_lmer)

r.squaredGLMM(algae_corr_lmer)

```

```{r Benthic Algal Cover Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses
# Benthic Algae
# Benthic algae distribution
plotNormalHistogram(MA_cover_final$combined_cover, main = "Benthic algae")

MA_cover_final <- MA_cover_final %>%  mutate(combined_cover_trans = log(2 - combined_cover))

plotNormalHistogram(MA_cover_final$combined_cover)
plotNormalHistogram(MA_cover_final$combined_cover_trans)
```

```{r Benthic Algal Cover Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### Benthic algal cover  #############
# Algae with interaction
# variables #
MA_cover_final$Shelter <- factor(MA_cover_final$Shelter, levels = c("Low", "High"), ordered = TRUE)
module <- MA_cover_final$`Module #`

# algae in general with interaction
algae_lmer <- lmer(combined_cover ~ Site_long*Shelter + (1|module) + (1|Year/Season), data = MA_cover_final)
summary(algae_lmer)


# algae in general without interaction
algae_lmer_no_interaction <- lmer(combined_cover ~ Site_long + Shelter + (1|module) + (1|Year/Season), data = MA_cover_final)
summary(algae_lmer_no_interaction)


############### Benthic algal cover vs urchin biomass ###############
urchin_vs_algae_data$Shelter <- factor(urchin_vs_algae_data$Shelter, levels = c("Low", "High"), ordered = TRUE)
module <- urchin_vs_algae_data$`Module #.x`

urchin_vs_algae_lmer <- lmer(combined_cover ~ urchin_biomass + Site_long*Shelter + (1|module) + (1|Year/Season), data = urchin_vs_algae_data, na.action = "na.fail")
summary(urchin_vs_algae_lmer)


############# Benthic algal cover vs herbivorous fish biomass ############### 
herbivorous_fish_vs_algae$Shelter <- factor(herbivorous_fish_vs_algae$Shelter, levels = c("Low", "High"), ordered = TRUE)
module <- herbivorous_fish_vs_algae$`Module #.x`

fish_vs_algae_lmer <- lmer(combined_cover ~ total_biomass + Site_long*Shelter + (1|module) + (1|Year/Season), data = herbivorous_fish_vs_algae, na.action = "na.fail")
summary(fish_vs_algae_lmer)

```

```{r Benthic Algal Cover Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## algae with interaction
qqnorm(resid(algae_lmer, main = "Algae no interaction Residual Plot"))
qqline(resid(algae_lmer))

r.squaredGLMM(algae_lmer)
#r-squared

em <- emmeans(algae_lmer, ~ Site_long*Shelter)
pairs(em)
# pairwise multiple comparisons

plot(allEffects(algae_lmer))
# effects plots


## algae without interaction
qqnorm(resid(algae_lmer_no_interaction, main = "Algae no interaction Residual Plot"))
qqline(resid(algae_lmer_no_interaction))
# qqplots

r.squaredGLMM(algae_lmer_no_interaction)
#r-squared

em <- emmeans(algae_lmer_no_interaction, ~ Site_long*Shelter)
pairs(em)
# pairwise multiple comparisons

plot(allEffects(algae_lmer_no_interaction))
# effects plots


## Urchin without interaction
qqnorm(resid(urchin_vs_algae_lmer, main = "Urchin vs algae Residual Plot"))
qqline(resid(urchin_vs_algae_lmer))
# qqplots

r.squaredGLMM(urchin_vs_algae_lmer)
#r-squared

emm_urchin_lmer_1 <- emmeans(urchin_vs_algae_lmer, ~ Site_long*Shelter)
pairs(emm_urchin_lmer_1, simple = "each")
# post-hoc tests

plot(allEffects(urchin_vs_algae_lmer), main = "Urchins vs algae")
# effects plots


## Fish without interaction
qqnorm(resid(fish_vs_algae_lmer, main = "Fish vs algae Residual Plot"))
qqline(resid(fish_vs_algae_lmer))
# qqplots

r.squaredGLMM(fish_vs_algae_lmer)
#r-squared

emm_fish_lmer_1 <- emmeans(fish_vs_algae_lmer, ~ Site_long*Shelter)
pairs(emm_fish_lmer_1, simple = "each")
# post-hoc tests

plot(allEffects(fish_vs_algae_lmer), main = "Fish vs algae")
# effects plots
```

```{r Benthic Algal Cover Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############## Benthic algal cover barplot summary database and figures ############

# algae in general #
MA_cover_final_all_plot <- MA_cover_final %>% group_by(Site_long, Treatment_long, Shelter) %>% 
summarize(mean = mean(combined_cover*100),
            sd = std.dev.pop(combined_cover*100),
            lower = mean(combined_cover*100) - std.error.pop(combined_cover*100),
            upper = mean(combined_cover*100) + std.error.pop(combined_cover*100),
            sample_size = n())

# MA_cover_final_all_plot <- MA_cover_final %>% group_by(Site_long, Treatment_long, Shelter, Label) %>% summarize(mean = mean(percent_cover*100),
#            sd = std.dev.pop(percent_cover*100),
 #           lower = mean(percent_cover*100) - std.error.pop(percent_cover*100),
  #          upper = mean(percent_cover*100) + std.error.pop(percent_cover*100),
   #         sample_size = n())

# reorder summary dataframe for plotting #
MA_cover_final_all_plot <- MA_cover_final_all_plot[c(3,4,1,2),]
MA_cover_final_all_plot$Shelter <- factor(MA_cover_final_all_plot$Shelter, levels = c("Low", "High"))


### Plots
# algae in general #
position <- c("Waikiki", "Hanauma Bay")

mult_compare6 <- c("A", "A", "A", "B")

algae_plot <- ggplot(data = MA_cover_final_all_plot, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  scale_y_continuous(breaks = seq(0, 100, 30)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  geom_text(aes(label = mult_compare6, y = MA_cover_final_all_plot$upper + 0.05), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
  geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
            position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Benthic algal % cover") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none",
        axis.title.x = element_blank(), axis.text.y = element_text(angle = 90))

algae_plot


algae_plot_2 <- ggplot(data = MA_cover_final_all_plot, aes(fill = interaction(Shelter, Label), y = mean, x = Site_long)) +
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  scale_y_continuous(breaks = seq(0, 100, 30)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  labs(x = "", y = "% Cover  95% CI") +
  scale_fill_discrete(name = "", labels = c("CCA-Low", "CCA-High", "MA-Low", "MA-High", "T-Low",  "T-High")) +
  theme_classic(base_size = 15) +
  theme(axis.text.y = element_text(angle = 90))



############## Benthic algal cover time series summary database and figures ############


## Benthic Algae Time Series Plots
### Summary Databases
# Combined database #
plot_data_algae_all <- MA_cover_final %>%
  group_by(TimeStep, Site_long, Shelter) %>% 
  summarise(mean = mean(combined_cover*100),
            sd = std.dev.pop(combined_cover*100),
            lower = mean(combined_cover*100) - std.error.pop(combined_cover*100),
            upper = mean(combined_cover*100) + std.error.pop(combined_cover*100),
            Date_final = mean((as.Date(Date))))

plot_data_algae_all$Shelter <- factor(plot_data_algae_all$Shelter, levels = c("Low", "High"))


### Time Series Plots
### algae_total full plot  ###
plot_data_algae_time_series <- ggplot(data = plot_data_algae_all, aes(x = Date_final, y = mean, fill = Shelter, group = interaction(Site_long, Shelter))) + 
  geom_line(aes(linetype = Shelter)) +
  geom_point(aes(shape = Site_long, size = 3, color = Shelter)) +
  guides(size = FALSE) +
  theme(text = element_text(size = 15)) +
  geom_errorbar(aes(ymin = lower, ymax = upper)) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b%y") +
  scale_y_continuous(breaks=seq(0, 100, 10)) +
  labs(x = "Date", y = "Mean benthic algal % cover  SEM") 

plot_data_algae_time_series <- ggplot(data = plot_data_algae_all, aes(x = Date_final, y = mean, fill = Shelter, group = interaction(Site_long, Shelter))) + 
  geom_line(aes(linetype = Shelter)) +
  geom_point(aes(shape = Site_long, size = 3, color = Shelter)) +
  guides(size = FALSE) +
  theme(text = element_text(size = 15)) +
  geom_errorbar(aes(ymin = lower, ymax = upper)) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b%y") +
  scale_y_continuous(breaks=seq(0, 1, 0.1)) +
  labs(x = "Date", y = "Mean benthic algal cover  SEM") 


plot_data_algae_time_series <- ggplot(data = plot_data_algae_all, aes(x = Date_final, y = mean, fill = Shelter, shape = Site_long, group = interaction(Site_long, Shelter))) + 
  ggtitle("Benthic Algal % Cover") +
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c(NA, "black"), guide = guide_legend(override.aes = list(shape = 21))) +
  guides(size = FALSE) +
  theme(text = element_text(size = 15)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = "Date", y = "Mean benthic algal % cover  SEM") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title = element_text(size = rel(1.5)), axis.text = element_text(size = rel(1.3)), legend.text = element_text(size = rel(1.5)), legend.position = "none", legend.title = element_text(size = rel(1.5)), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5)) 


## cropped plot for combined figure ##
algae_time_series_plot <- ggplot(data = plot_data_algae_all, aes(x = Date_final, y = mean, fill = Shelter, shape = Site_long)) + 
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c(NA, "black"), guide = guide_legend(override.aes = list(shape = 21))) +
  guides(size = FALSE) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  scale_y_continuous(breaks=seq(0, 100, 10)) +
  labs(x = "Date", y = "Benthic algal % cover") +
  theme_classic(base_size = 13) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), axis.text.y = element_text(angle = 90), legend.title = element_text(size = rel(1.5)), legend.position = "none", axis.title.y = element_text(size = 18), axis.title = element_text(size = 16), plot.margin = margin(10,11,10,9))

algae_time_series_plot
```

## Herbivore Hypothesis
This section contains linear mixed effects models that examine urchin biomass, herbivorous fish biomass, and benthic algal overgrowth as a function of experimental module shelter availability (low vs high) and reefscape (Waikiki vs Hanauma Bay).  

These analyses provide the basis of testing the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals.  The last linear mixed effects model examines benthic algal overgrowth as a function of herbivore biomass.

### Urchin Biomass
```{r Urchin Analyses and Figures, echo = TRUE, message=FALSE, warning=FALSE}
## NOTE: for all plots, gray bars represent low shelter modules and black bars represent high shelter modules

## Urchins glmmTMB
#summary(urchin_glmmTMB)
#r.squaredGLMM(urchin_glmmTMB)

## fit
#qqnorm(resid(urchin_glmmTMB), main = "Urchin glmmTMB Residual Plot")
#qqline(resid(urchin_glmmTMB))
#urchin_fit_glmmTMB_regular_qq

#DHARMa::testDispersion(urchin_glmmTMB)
#simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_glmmTMB, plot = F)
#DHARMa::plotQQunif(simulationOutput, main = "Urchin glmmTMB DHARMa Residual Plot")
#urchin_fit_glmmTMB

# pairwise multiple comparisons
#mc_urchin_glmmTMB <- emmeans(urchin_glmmTMB, ~ Site_long*Shelter)
#pairs(mc_urchin_glmmTMB)
# pairwise multiple comparisons simple
#mc_urchin_glmmTMB <- emmeans(urchin_glmmTMB, ~ Site_long*Shelter)
#pairs(mc_urchin_glmmTMB, simple = "each")

## Urchins
summary(urchin_lmer)
r.squaredGLMM(urchin_lmer)

urchin_trans_fit 

# pairwise multiple comparisons
mc_urchin_trans <- emmeans(urchin_lmer, ~ Site_long*Shelter)
pairs(mc_urchin_trans)
# pairwise multiple comparisons simple
mc_urchin_trans <- emmeans(urchin_lmer, ~ Site_long*Shelter)
pairs(mc_urchin_trans, simple = "each")


#summary(urchin_lmer_no_interaction)
#r.squaredGLMM(urchin_lmer_no_interaction)

urchin_plot_final

urchin_time_series_plot

```

### Herbivorous Fish Biomass
```{r Herbivorous Fish Analyses and Figures, echo = TRUE, message=FALSE, warning=FALSE}
## Herbivorous Fish glmmTMB
#summary(fish_glmmTMB)
#r.squaredGLMM(fish_glmmTMB)

## fit
#qqnorm(resid(fish_glmmTMB), main = "Fish glmmTMB Residual Plot")
#qqline(resid(fish_glmmTMB))
#fish_fit_glmmTMB_regular_qq

#DHARMa::testDispersion(urchin_glmmTMB)
#simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_glmmTMB, plot = F)
#DHARMa::plotQQunif(simulationOutput)
#fish_fit_glmmTMB


# pairwise multiple comparisons
#mc_fish_glmmTMB <- emmeans(fish_glmmTMB, ~ Site_long*Shelter)
#pairs(mc_fish_glmmTMB)
# pairwise multiple comparisons simple
#mc_fish_glmmTMB <- emmeans(fish_glmmTMB, ~ Site_long*Shelter)
#pairs(mc_fish_glmmTMB, simple = "each")


## Herbivorous Fish
summary(fish_lmer)
r.squaredGLMM(fish_lmer)

fish_trans_fit

#summary(fish_lmer_no_interaction)
#r.squaredGLMM(fish_lmer_no_interaction)

fish_plot_2

fish_time_series_plot

```

### Benthic Algal Overgrowth and Benthic Algal % Cover Correlation Verification
```{r echo = TRUE, message=FALSE, warning=FALSE}
### Benthic algal overgrowth correlation with benthic algal cover ###
summary(algae_corr_lmer)
r.squaredGLMM(algae_corr_lmer)
```

### Benthic Algal Overgrowth
```{r, Benthic Algal Code Analyses and Figures, echo = TRUE, message=FALSE, warning=FALSE}
## Benthic Algal Cover Code
summary(cover_code_lmer)
r.squaredGLMM(cover_code_lmer)

algae_trans_fit

# pairwise multiple comparisons
em <- emmeans(cover_code_lmer, ~ Site_long*Shelter)
pairs(em)
# pairwise multiple comparisons simple
em <- emmeans(cover_code_lmer, ~ Site_long*Shelter)
pairs(em, simple = "each")


#summary(cover_code_lmer_no_interaction)
#r.squaredGLMM(cover_code_lmer_no_interaction)

plot_cover_combined_plot0

algae_time_series_plot_cover_code


## Urchins vs Herbivorous Fish Biomass on High Shelter Modules at Hanauma Bay
#summary(lm_urchin_vs_herbivorous_fish)



#sub_2_test <- sub_2 %>% filter(Site_long == "Waikiki") %>% 
#group_by(Shelter, Sector) %>% 
#summarize(sample_size = n())
            
            
#            sub_2_test <- sub_2 %>% filter(Site_long == "Waikiki") %>% 
#group_by(Shelter, Sector) %>% 
#summarize(mean_algal_overgrowth = mean(`Cover Code`),
#sd = std.dev.pop(`Cover Code`),
#lower = mean(`Cover Code`) - std.error.pop(`Cover Code`),
#           upper = mean(`Cover Code`) + std.error.pop(`Cover Code`),
#            sample_size = n())
```

### Benthic Algal Overgrowth vs. Herbivore Biomass 
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Combined herbivore biomass vs Algal Cover Code (Less algae with more herbivores)
# lmer combined urchin and herbivorous fish biomass analysis full model
summary(herbivore_biomass_vs_algae_lmer)

## Urchin and Fish fit
qqnorm(resid(herbivore_biomass_vs_algae_lmer), main = "Urchin and herbivorous fish vs algae Residuals")
qqline(resid(herbivore_biomass_vs_algae_lmer))
herbivore_biomass_vs_algae_fit <- recordPlot()
dev.off()

herbivore_biomass_vs_algae_fit
# fit

r.squaredGLMM(herbivore_biomass_vs_algae_lmer)

effect(herbivore_biomass_vs_algae_lmer)

# lmer combined urchin and herbivorous fish biomass analysis
summary(herbivore_biomass_vs_algae_lmer)

r.squaredGLMM(herbivore_biomass_vs_algae_lmer)

# lmer combined urchin and herbivorous fish biomass only
#summary(herbivore_biomass_vs_algae_lmer_only)
#r.squaredGLMM(herbivore_biomass_vs_algae_lmer_only)

## Urchins vs Algal Cover Code (Less algae with more urchins)
# lmer analysis only
#summary(urchin_vs_cover_data_lmer_only)

#r.squaredGLMM(urchin_vs_cover_data_lmer_only)
```

```{r Saved Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

ggsave("Urchin barplot final.png", plot = urchin_plot_final2, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Urchin time series plot final.png", plot = urchin_time_series_plot, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)

ggsave("Herbivorous fish barplot final.png", plot = fish_plot_3, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Herbivorous fish time series plot final.png", plot = fish_time_series_plot, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)

ggsave("Algal overgrowth barplot final.png", plot = plot_cover_combined_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth time series plot final.png", plot = algae_time_series_plot_cover_code, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)

```

# Coral Demographic Analyses
The following sections contain all analyses and figures for the three coral genera *Pocillopora*, *Montipora*, and *Porites* that naturally recruited to experimental modules at Waikiki (6) and Hanauma Bay (5).  Juvenile corals that naturally recruited to experminetal modules were quarterly using a measuring tape during this study.

Coral recruits were considered to be all colonies seen for the first time and measured between 1-5 mm in maximum diameter.  Coral survival and growth were also quantified for each coral genera and were analyzed based on 4 distinct size classes that represent the maximum colony diameter range (1: 1-5 mm, 2: 6-10 mm, 3: 11-15 mm, 4: 16-20 mm).

All barplot figures represent means and standard errors for their associated linear mixed effects model analyses.  Gray bars represent low shelter modules and black bars represent high shelter modules.

# PC 1-5 mm
```{r PC 1-5 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###

module_data <- read.csv("databases/Module Side Area Database.csv")
module_data$`Module #` <- module_data$`Module..`
module_data$`Module..` <- NULL
# area exposed for N and S module sides


###### Summary Plot Databases
Rec <- "PC_1_5" 
Sur <- "PC_S_1_5"
Grow <- "PC_G_1_5" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```

```{r PC 1-5 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 1
max <- 5
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 1
# size class for corals that fall in "size_vect"

min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PC")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PC")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data


```

```{r PC 1-5 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```

```{r PC 1-5 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```

```{r PC 1-5 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PC 1-5 Recruitment Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


### General Workflow Summary
# Make series of databases (ID Databases) for each quarter that filter for all corals within the designated size range represented by the size_vect vector while preventing any individual coral ID from being used in subsequent quarters (prevent pseudoreplication by sampling a individual coral colony more than once)

# Make a series of databases (Quarterly Total Recruits and Larval Output Databases) for each quarter that summarize the total number of recruits and total larval ouput for each module side and coral size_class using the previous series of databases to filter out corals that have already been sampled in previous timesteps or quarters

# Bind these series of databases together by row to make a new single dataframe with all module sides and size classes

# Used date log database to add survey dates back into the database that were lost during the use of the complete() function to fill in missing data (where no corals were observed which means there were 0 recruits per square meter not that there are no data)

# Used the complete() functions twice more to fill in for missing data after joining databases

# Use a series of group_by() and summary() functions to group data such that mean coral recruitment per square meter is calculated based on the total area of both N and S sides of each module

### ID Databases
start_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1))

Q1_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2))

Q2_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3))

Q3_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4))

Q4_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5))

Q5_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6))

Q6_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7))

Q7_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8))

Q8_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9))

Q9_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10))

Q10_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11))

Q11_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12))

#Q12_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13))


### Quarterly Total Recruits and Larval Output Databases
start_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q1_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q2_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q3_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q4_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>%  
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q5_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q6_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q7_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q8_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q9_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q10_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q11_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12)) %>% 
  group_by(`Taxonomic Code`, Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

#Q12_recruiment <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13)) %>% 
#  group_by(Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output, Sector, Sector_Area) %>% 
#  summarise(recruits = n(),
 #           total_larvae = sum(larval_output))

### Final Databases
n1_original <- bind_rows(start_recruitment_original, Q1_recruitment_original, Q2_recruitment_original, Q3_recruitment_original, Q4_recruitment_original, Q5_recruitment_original, Q6_recruitment_original, Q7_recruitment_original, Q8_recruitment_original, Q9_recruitment_original, Q10_recruiment_original, Q11_recruiment_original)

date_data <- read_csv("databases/Coral Census Date Log.csv")

date_data$Date <- as.Date(date_data$Date,'%m/%d/%y')
n1_original$Date <- as.Date(n1_original$Date, '%m/%d/%y')
n1_original$Year <- as.numeric(n1_original$Year)
date_data$Year <- as.numeric(date_data$Year)
date_data$`Module #` <- as.numeric(date_data$`Module #`)
n1_original$`Module #` <- as.numeric(n1_original$`Module #`)

date_data <- date_data %>% filter(TimeStep %in% timestep, Side %in% side, `Module #` %in% modules)
# filter census date database

n1_original <- n1_original %>% filter(TimeStep %in% timestep)



n1_original <- left_join(date_data, n1_original, by = c("Date", "Module #", "Site_long", "Shelter", "Side", "TimeStep"))
  
  
### Recruitment by combining sectors (N & S)

n2_original <- n1_original %>% ungroup()  %>% 
  complete(nesting(`Module #`), Side, TimeStep, fill = list(larval_output = 0, recruits = 0, Settlement_Area = 1)) %>% 
  drop_na(Side, `Module #`) %>%  
  mutate(`Taxonomic Code` = species_label)


n2_original <- n2_original %>%

  group_by(`Module #`, TimeStep, Side) %>% 
  mutate(recruits = sum(recruits),
         larvae = larval_output) %>%
  slice(n())

n3_original <- data_final %>% arrange((Date)) %>% 
  group_by(`Module #`, TimeStep, Side) %>% 
  filter(`Max Diameter (mm)` > repro_min) %>% 
  tally() 


n3_original$`Module #` <- as.numeric(n3_original$`Module #`)

n2_original <- left_join(n2_original, n3_original)

n2_original <- n2_original %>% rename("Reproductive" = n)


# Total coral colony calculation 
n5_original <- data_final %>% filter(TimeStep %in% timestep) %>% 
  mutate(Reproductive = ifelse(`Max Diameter (mm)` >= repro_min, "Yes", "No")) %>% 
  group_by(`Taxonomic Code`, Date, Year, Site_long, Shelter, `Module #`, TimeStep, Side, Sector) %>% 
  tally() %>% 
  filter(Side %in% side,
         `Taxonomic Code` %in% species) 


n5_original <- n5_original %>% group_by(Year, Site_long, Shelter, `Module #`, TimeStep, Side) %>% 
  summarize(Date = mean(Date),
            coral_count = sum(n)) %>% 
  filter(!is.na(Date))

n5_original <- n5_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1))

# make Module # a factor column #
n5_original$`Module #` <- as.numeric(n5_original$`Module #`)

n6_original <- left_join(n2_original, n5_original)

n6_original <- n6_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1, Reproductive = 0))


n7_original <- n6_original %>%
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
group_by(TimeStep, `Module #`) %>%
  fill(Date, Year, .direction = "updown") %>% 
    mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))



#### Module Scale Database for Recruitment
date_data_new <- date_data %>% group_by(`Module #`, Site_long, Shelter, TimeStep, Year) %>% 
  summarize(Date_new = mean(Date))

module_data$`Module #` <- as.numeric(module_data$`Module #`)
n7_original$`Module #` <- as.numeric(n7_original$`Module #`)

n7_original <- left_join(n7_original, module_data, by = c("Site_long", "Shelter", "Module #", "Side", "TimeStep"))


n7_original$Settlement_Area <- n7_original$Settlement_Area.y
n7_original$Year <- n7_original$Year.x


n7_original <- n7_original %>% group_by(`Module #`, TimeStep, `Taxonomic Code`, Site_long, Shelter, Year, Season) %>% 
  summarize(recruits = sum(recruits),
    Settlement_Area = sum(Settlement_Area)) %>% 
  mutate(recruits_per_meter_squared = recruits/Settlement_Area)


n7_original <- left_join(n7_original, date_data_new, by = c("Module #", "Site_long", "Shelter", "TimeStep", "Year"))
n7_original$Date <- n7_original$Date_new

```

```{r PC 1-5 Recruitment Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


# Side combined database
n7_original <-  n7_original %>% mutate(recruits_per_meter_squared_trans = log(recruits_per_meter_squared + 1))

plotNormalHistogram(n7_original$recruits_per_meter_squared, main = "Recruitment original")
# recruitment distributions

plotNormalHistogram(n7_original$recruits_per_meter_squared_trans, main = "Recruitment Trans Original")

```

```{r PC 1-5 Recruitment Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#################### lmer original
# all corals with sides combined
# with interaction
module_recruitment <- as.numeric(n7_original$`Module #`)
n7_original$Site_long <- as.factor(n7_original$Site_long)
# factorize variables

n7_original$Season <- as.factor(n7_original$Season)
n7_original$Season <-  factor(n7_original$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE) 
season <- n7_original$Season
n7_original$Shelter <- factor(n7_original$Shelter, levels = c("Low", "High"), ordered = TRUE)
n7_original$Site_long <- factor(n7_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

PC_recruitment_lmer_original <- lmer(recruits_per_meter_squared_trans ~ Site_long*Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(PC_recruitment_lmer_original)
# model summary

recruitment_lmer_no_interaction_original <- lmer(recruits_per_meter_squared_trans ~ Site_long + Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(recruitment_lmer_no_interaction_original)
# model summary
```


```{r PC 1-5 Recruitment Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Recruitment
png("outputs/PC recruitment trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_recruitment_lmer_original), main = "PC recruitment trans Residuals")
qqline(resid(PC_recruitment_lmer_original))
dev.off()

qqnorm(resid(PC_recruitment_lmer_original), main = "PC recruitment trans Residuals")
qqline(resid(PC_recruitment_lmer_original))
PC_recruitment_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PC_recruitment_lmer_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(PC_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(PC_recruitment_lmer_original), main = "PC recruitment trans")
# effects plots


## Recruitment
qqnorm(resid(recruitment_lmer_no_interaction_original, main = "Recruitment Residual Plot Original"))
qqline(resid(recruitment_lmer_no_interaction_original))
# qqplots

r.squaredGLMM(recruitment_lmer_no_interaction_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(recruitment_lmer_no_interaction_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(recruitment_lmer_no_interaction_original), main = "Recruitment Original")
# effects plots
```

```{r PC 1-5 Recruitment Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############## Recruitment barplot summary database and figures ##############
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))
#standard error function for error bars

plot_data_Site1 <- n7_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_recruit = mean(recruits_per_meter_squared),
            sample_size = n())
# mean urchin biomass for each module over entire study
  
plot_data_Site1 <- plot_data_Site1 %>% 
  group_by(Site_long, Shelter) %>% 
  summarise(mean = mean(mean_recruit),
            sd = std.dev.pop(mean_recruit),
            lower = mean(mean_recruit) - std.error.pop(mean_recruit),
            upper = mean(mean_recruit) + std.error.pop(mean_recruit),
            sample_size = n())
# mean urchin biomass for each treatment (n = 3)

plot_data_Site1 <- plot_data_Site1[c(3, 4, 1, 2),]
plot_data_Site1$Shelter <- factor(plot_data_Site1$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


###### Assign name for summary database from input section at top of script
assign(Rec, plot_data_Site1)


myplotfunc_recruitment <- function(x,y,z)
{
    data <- x
    
    mult_compare_recruitment <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))
    return(plot)
}

recruitment_plot_3 <- myplotfunc_recruitment(plot_data_Site1, mult_compare_recruitment, position)


## Barplot with labels
recruitment_plot_4 <- ggplot(data = plot_data_Site1, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


############## Recruitment time series summary database and figures ##############
## Recruitment Time Series Plots
plot_data_recruitment <- n7_original %>%
  group_by(Year, Site_long, Shelter, TimeStep) %>% 
  summarise(mean = mean(recruits_per_meter_squared),
            sd = std.dev.pop(recruits_per_meter_squared),
            lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared),
            Date = mean(Date))
# time series summary database


plot_data_recruitment$Shelter <- factor(plot_data_recruitment$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_recruitment$Site_long <- factor(plot_data_recruitment$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


## combined figure with legend ##
recruitment_time_series_plot_3 <- ggplot(data = plot_data_recruitment, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months",  date_labels = "%b") +
  theme_classic(base_size = 14.5) +
  coord_cartesian(ylim = c(0, 15)) +
  labs(x = "Date", y = expression(paste("Coral recruitment per m"^"2"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), legend.text = element_text(size = rel(1)), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5), legend.position = "none", legend.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.title.y = element_text(size = 18), axis.text = element_text(size = 16))


PC_recruitment_time_series_plot_3 <- recruitment_time_series_plot_3
```


```{r PC 1-5 Recruitment vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

urchin_vs_recruitment_data <- left_join(n7_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

### Analyses ###

# Analysis
module_urchin_recruit <- urchin_vs_recruitment_data$`Module #`

urchin_vs_PC_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_recruit) + (1|Year/Season), data = urchin_vs_recruitment_data, na.action = "na.fail")
summary(urchin_vs_PC_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PC recruitment vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_recruitment_lmer), main = "Urchin vs. PC recruitment Residual Plot Original")
qqline(resid(urchin_vs_PC_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_recruitment_lmer)
#r-squared

emm_PC_recruit_lmer_1_original <- emmeans(urchin_vs_PC_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PC_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_recruitment_lmer), main = "Urchin vs. PC recruitment Original")
# effects plots


### Scatterplot summary database and figures ###

# Urchin vs cover code without timesteps (12 points, 1 for each module)
urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_recruitment_mod_lmer_plot <- ggplot(data = urchin_vs_recruitment_data_mod, aes(x = mean_urchin, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC recruitment vs. urchin biomass final.png", plot = urchin_vs_PC_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 1-5 Recruitment vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Recruitment vs Herbivorous Fish Biomass ###
# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

fish_vs_recruitment_data <- left_join(n7_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_recruitment_data <- fish_vs_recruitment_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_recruit <- fish_vs_recruitment_data$`Module #`

fish_vs_PC_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ total_biomass + Site_long*Shelter + (1|module_fish_recruit) + (1|Year/Season), data = fish_vs_recruitment_data, na.action = "na.fail")
summary(fish_vs_PC_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PC recruitment vs herbivorous fish biomass fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_recruitment_lmer), main = "Herbivorous fish vs. PC recruitment Residual Plot Original")
qqline(resid(fish_vs_PC_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_recruitment_lmer)
#r-squared

emm_PC_recruit_lmer_1_original <- emmeans(fish_vs_PC_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PC_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_recruitment_lmer), main = "Herbivorous fish vs. PC recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs cover code without timesteps (12 points, 1 for each module)
fish_vs_recruitment_data_mod <- fish_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

fish_vs_recruitment_data_mod <- fish_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_recruitment_mod_lmer_plot <- ggplot(data = fish_vs_recruitment_data_mod, aes(x = mean_fish, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
 # geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC recruitment vs. herbivorous fish biomass final.png", plot = fish_vs_PC_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Recruitment vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs recruitment ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)

algae_vs_recruitment_data <- left_join(n7_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_recruitment_data <- algae_vs_recruitment_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2

### Analyses ###

# Analysis
module_algae_recruit <- algae_vs_recruitment_data$`Module #`

algae_vs_PC_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ mean_cover_code + Site_long*Shelter + (1|module_algae_recruit) + (1|Year/Season), data = algae_vs_recruitment_data, na.action = "na.fail")
summary(algae_vs_PC_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PC recruitment vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_recruitment_lmer), main = "Algal overgrowth vs. PC recruitment Residual Plot Original")
qqline(resid(algae_vs_PC_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_recruitment_lmer)
#r-squared

emm_PC_recruit_lmer_1_original <- emmeans(algae_vs_PC_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PC_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_recruitment_lmer), main = "Algal overgrowth vs. PC recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs cover code without timesteps (12 points, 1 for each module)
algae_vs_recruitment_data_mod <- algae_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

algae_vs_recruitment_data_mod <- algae_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_recruitment_mod_lmer_plot <- ggplot(data = algae_vs_recruitment_data_mod, aes(x = mean_algae, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC recruitment vs. benthic algal overgrowth final.png", plot = algae_vs_PC_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 1-5 Recruiment vs Herbivore Biomass and Benthic Algal Code, echo = FALSE, message=FALSE, warning=FALSE, results='hide', fig.show='hide'}

### Database ###

### Urchin, herbivorous fish, and algae vs. recruitment
# Database
urchin_fish_vs_recruitment_data <- left_join(urchin_vs_recruitment_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_recruitment_data <- urchin_fish_vs_recruitment_data %>% filter(!is.na(total_biomass))

urchin_fish_algae_recruitment_data <- left_join(urchin_fish_vs_recruitment_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_recruitment_data <- urchin_fish_algae_recruitment_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

module_urchin_fish_algae_recruit <- urchin_fish_algae_recruitment_data$`Module #`

urchin_fish_algae_vs_PC_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_recruit) + (1|Year/Season), data = urchin_fish_algae_recruitment_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PC recruitment vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_recruitment_lmer), main = "U, F, & AO vs. PC recruitment Residuals")
qqline(resid(urchin_fish_algae_vs_PC_recruitment_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_recruitment_lmer), main = "U, F, & AO vs. PC recruitment Trans Residuals")
qqline(resid(urchin_fish_algae_vs_PC_recruitment_lmer))
urchin_fish_algae_vs_PC_recruitment_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_recruitment_lmer), main = "U, F, & AO vs. PC recruitment")
# effects plots

```




```{r PC 1-5 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  
 

  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.




survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures



survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PC 1-5 Survival Data Tranformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions
plotNormalHistogram(survival_results_long_2_original$survival_trans)
```
 

```{r PC 1-5 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots
PC_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PC_1_5_survival_glmmTMB)



PC_1_5_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PC_1_5_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PC 1-5 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PC 1-5 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_1_5_survival_lmer_original), main = "PC 1-5 survival Residuals")
qqline(resid(PC_1_5_survival_lmer_original))
dev.off()

qqnorm(resid(PC_1_5_survival_lmer_original), main = "PC 1-5 survival Residuals")
qqline(resid(PC_1_5_survival_lmer_original))
PC_1_5_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PC_1_5_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PC_1_5_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PC_1_5_survival_lmer_original), main = "PC 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(PC_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PC_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_1_5_survival_glmmTMB, plot = T)
PC_1_5_survival_glmmmTMB_DHARMa_fit <- recordPlot() 

png("outputs/PC 1-5 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PC_1_5_survival_glmmTMB), main = "PC 1-5 survival Residuals")
qqline(resid(PC_1_5_survival_glmmTMB))
PC_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 1-5 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_1_5_survival_glmmTMB), main = "PC 1-5 Survival")
qqline(resid(PC_1_5_survival_glmmTMB))
dev.off()
```


```{r PC 1-5 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

################ Survival barplot summary database and figures ################# 

## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))


plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)



#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


############### Survival time series summary database and figures ###############

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PC 1-5 Survival vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PC_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PC_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 1-5 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_1_5_survival_lmer), main = "Urchins vs. PC 1-5 Survival Residual Plot Original")
qqline(resid(urchin_vs_PC_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_1_5_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(urchin_vs_PC_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_1_5_survival_lmer), main = "Urchins vs PC 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_1_5_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 survival vs urchin biomass final.png", plot = urchin_vs_PC_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Survival vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PC_1_5_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PC_1_5_survival_lmer)



### Model assessments ###

## Survival
png("outputs/PC 1-5 survival trans vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_1_5_survival_lmer), main = "Herbivorous fish vs. PC 1-5 Survival Residual Plot Original")
qqline(resid(fish_vs_PC_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_1_5_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(fish_vs_PC_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_1_5_survival_lmer), main = "Herbivorous fish vs PC 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_1_5_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 survival vs herbivorous fish biomass final.png", plot = fish_vs_PC_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Survival vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PC_1_5_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PC_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 1-5 survival algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_1_5_survival_lmer),main = "Algal overgrowth vs PC 1-5 Survival Residual Plot Original")
qqline(resid(algae_vs_PC_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_1_5_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PC_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_1_5_survival_lmer), main = "Algal overgrowth vs PC 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_1_5_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 survival vs benthic algal overgrowth final.png", plot = algae_vs_PC_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PC_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_1_5_survival_lmer)


# DHARMa simulated model
urchin_fish_algae_vs_PC_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)



### Model assessments ###

## Survival
png("outputs/PC 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_survival_lmer), main = "U,F,& AO vs. PC 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_1_5_survival_lmer), main = "U,F,& AO vs. PC 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_survival_lmer))
urchin_fish_algae_vs_PC_1_5_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_1_5_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_1_5_survival_lmer), main = "U,F,& AO vs. PC 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_1_5_survival_glmmTMB, plot = T)
PC_1_5_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot() 

png("outputs/PC 1-5 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB), main = "U,F,& AO vs. PC 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB))
urchin_fish_algae_vs_PC_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB), main = "PC 1-5 Survival")
qqline(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB))
dev.off()

```


```{r PC 1-5 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


#### Filtering Databases for Parametric Tests and Transition Matrices 
### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



############# Function for growth calculations ############# 
###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



########### Growth database for analyses with or without benthic algal code data ########

####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```

```{r PC 1-5 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```

```{r PC 1-5 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PC_1_5_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_1_5_growth_mixed_effects_original)

###



###

r.squaredGLMM(PC_1_5_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PC_1_5_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_1_5_growth_mixed_effects_original_trans)
# transformed model
```


```{r PC 1-5 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PC 1-5 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_1_5_growth_mixed_effects_original), main = "PC 1-5 Growth")
qqline(resid(PC_1_5_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PC_1_5_growth_mixed_effects_original), main = "PC 1-5 Growth")
qqline(resid(PC_1_5_growth_mixed_effects_original))
PC_1_5_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_1_5_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PC_1_5_growth_mixed_effects_original), main = "PC 1-5 growth")
# interaction plots

emm_original <- emmeans(PC_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


## lmer
# all corals cube root transformed growth
png("outputs/PC 1-5 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_1_5_growth_mixed_effects_original_trans), main = "PC 1-5 Growth")
qqline(resid(PC_1_5_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PC_1_5_growth_mixed_effects_original_trans), main = "PC 1-5 Growth trans")
qqline(resid(PC_1_5_growth_mixed_effects_original_trans))
PC_1_5_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_1_5_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PC_1_5_growth_mixed_effects_original_trans), main = "PC 1-5 growth")
# interaction plots

emm_original <- emmeans(PC_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```

```{r PC 1-5 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############### Growth barplot summary database and figures ################

## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))



############# Growth time series summary database and figures ############# 
### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PC 1-5 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PC_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PC_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PC 1-5 growth vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_1_5_growth_lmer, main = "Urchins vs. PC 1-5 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PC_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PC_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_1_5_growth_lmer), main = "Urchins vs PC 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_1_5_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 growth vs. urchins final.png", plot = urchin_vs_PC_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 1-5 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PC_1_5_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PC_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PC 1-5 growth vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_1_5_growth_lmer, main = "Fish vs. PC 1-5 Growth Residual Plot Original"))
qqline(resid(fish_vs_PC_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PC_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_1_5_growth_lmer), main = "Fish vs. PC 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_1_5_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 growth vs. herbivorous fish final.png", plot = fish_vs_PC_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PC_1_5_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PC_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PC 1-5 growth vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_1_5_growth_lmer, main = "Algae vs. PC 1-5 Growth Residual Plot Original"))
qqline(resid(algae_vs_PC_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PC_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_1_5_growth_lmer), main = "Algae vs. PC 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_1_5_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 1-5 growth vs. algal overgrowth final.png", plot = algae_vs_PC_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PC 1-5 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PC_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_1_5_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PC_1_5_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/PC 1-5 growth trans vs. urchin, herbivorous fish, and algal overgrowth fit.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans), main = "PC 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans), main = "U,F,& AO vs. PC 1-5 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans))
urchin_fish_algae_vs_PC_1_5_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_1_5_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans), main = "U,F,& AO vs. PC 1-5 growth trans")
# effects plots


## Growth
png("outputs/PC 1-5 growth vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer), main = "PC 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer), main = "U,F,& AO vs. PC 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer))
urchin_fish_algae_vs_PC_1_5_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_1_5_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_1_5_growth_lmer), main = "U,F,& AO vs. PC 1-5 growth")
# effects plots

```


```{r PC 1-5 Requested Committee Meeting Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

n7_original_new <- n7_original %>% group_by(TimeStep, Season, Site_long, Shelter) %>% 
  summarise(Date_new = mean(Date),
            recruit = sum(recruits)) 

n7_original_new2 <- n7_original_new %>% group_by(Site_long, Shelter) %>%
  arrange(TimeStep) %>% 
  mutate(cum_sum_recruits = cumsum(recruit))

n7_original_new2$Shelter <- factor(n7_original_new2$Shelter, levels = c("Low", "High"), ordered = TRUE)


ggplot(data = n7_original_new2, aes(x = Date_new, y = cum_sum_recruits, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = "Date", y = "Cumulative # of Recruits") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = c(.2, .8), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))



############# Algal Cover vs 1-20 mm Total Colony Area #############
data_final_new <- data_final %>% filter(`Max Diameter (mm)` <= 20)

data_final_new <- data_final_new %>% group_by(TimeStep, Site_long, Shelter, `Module #`) %>% 
  summarize(total_area = sum(area_cm_squared))


data_final_new$TimeStep <- as.factor(data_final_new$TimeStep)
data_final_new$`Module #` <- as.factor(data_final_new$`Module #`)

colony_area_and_cover_code_data <- left_join(data_final_new, cover_code_data)

colony_area_and_cover_code_data <- colony_area_and_cover_code_data %>% drop_na(mean_cover_code)


# Variables
module_colony_area_vs_cover_code <- colony_area_and_cover_code_data$`Module #`


col_area_vs_cover_data_mod <- colony_area_and_cover_code_data %>% group_by(`Module #`) %>% 
  summarize(tot_area = mean(total_area),
            area_sd = std.dev.pop(total_area),
            area_lower = mean(total_area) - std.error.pop(total_area),
            area_upper = mean(total_area) + std.error.pop(total_area),
            mean_cover_code_new = mean(mean_cover_code),
            cover_sd = std.dev.pop(mean_cover_code),
            cover_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            cover_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code))

col_area_vs_cover_data_mod <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

col_area_vs_cover_data_mod_no_211 <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low")) %>%
  filter(`Module #` != 211)

col_area_vs_cover_code_mod_lm <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm)

col_area_vs_cover_code_mod_lm_no_211 <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod_no_211, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm_no_211)

### coral lmer full model
col_area_vs_cover_code_lmer <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer)

### coral lmer with significant predictors and algal overgrowth
col_area_vs_cover_code_lmer_sig <- lmer(total_area ~ mean_cover_code + Site_long + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_sig)

### coral lmer with algal overgrowth only
col_area_vs_cover_code_lmer_only <- lmer(total_area ~ mean_cover_code + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only)

### coral lmer with algal overgrowth only P/A
colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data %>% mutate(algae_P_A = ifelse(mean_cover_code == 1, 0, 1))
module_colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data_lmer_only_P_A$`Module #`

col_area_vs_cover_code_lmer_only_P_A <- lmer(total_area ~ algae_P_A + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_P_A) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_P_A, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_P_A)

### coral lmer with algal overgrowth only >0
colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_P_A %>% filter(algae_P_A == 1)
module_colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_above_1$`Module #`

col_area_vs_cover_code_lmer_only_above_1 <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_above_1) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_above_1, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_above_1)


# Plot lmer with SE 
col_area_vs_cover_code_mod_lmer_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with SE
col_area_vs_cover_code_mod_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with raw data 
col_area_vs_cover_code_plot <- ggplot(data = colony_area_and_cover_code_data, aes(x = mean_cover_code, y = total_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  #coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))
```


## Recruitment Time Series
```{r, echo = TRUE, message=FALSE, warning=FALSE}
recruitment_time_series_plot_3

ggsave("PC recruitment time series plot final.png", plot = recruitment_time_series_plot_3, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)
```


## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral recruitment, survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more herbivores and less algae)
summary(urchin_fish_algae_vs_PC_recruitment_lmer)
# model summary


urchin_fish_algae_vs_PC_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_recruitment_lmer), main = "U, F, & AO vs. PC Trans recruitment")
# effects plots

```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)

## qqplots
# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB), main = "U,F,& AO vs. PC 1-5 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB))

urchin_fish_algae_vs_PC_1_5_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PC 1-5 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB), main = "U,F,& AO vs. PC 1-5 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PC_1_5_survival_lmer)

#urchin_fish_algae_vs_PC_1_5_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_1_5_survival_lmer), main = "U,F,& AO vs. PC 1-5 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PC_1_5_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer), main = "U,F,& AO vs. PC 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_1_5_growth_lmer))

urchin_fish_algae_vs_PC_1_5_growth_fit
# qqplots


r.squaredGLMM(urchin_fish_algae_vs_PC_1_5_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_1_5_growth_lmer), main = "U,F,& AO vs. PC 1-5 growth")
# effects plots
```

```{r PC Benthic Algal Overgrowth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

# lmer full model analysis
summary(urchin_vs_cover_data_lmer)
r.squaredGLMM(urchin_vs_cover_data_lmer)
effect(urchin_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(urchin_vs_cover_data_lmer_sig)
#r.squaredGLMM(urchin_vs_cover_data_lmer_sig)

# lmer with P/A for urchin biomass
#summary(urchin_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_P_A)

# lmer with >0 urchin biomass
#summary(urchin_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_above_0)

#urchin_vs_cover_code_mod_plot_no_trend
# Figure without trendline
#urchin_vs_cover_code_mod_plot
# figure with trendline
#urchin_vs_cover_code_plot_no_trend
# raw data figure without trendline
urchin_vs_cover_code_plot
# raw data figure with trendline
urchin_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(urchin_vs_cover_code_mod_lm)
```


```{r PC Benthic Algal Overgrowth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Herbivorous Fish vs Algal Cover Code (Less algae with more fish)
# lmer analysis only
summary(fish_vs_cover_data_lmer_only)

r.squaredGLMM(fish_vs_cover_data_lmer_only)

# lmer full model analysis
summary(fish_vs_cover_data_lmer)
r.squaredGLMM(fish_vs_cover_data_lmer)
effect(fish_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(fish_vs_cover_data_lmer_sig)
#r.squaredGLMM(fish_vs_cover_data_lmer_sig)

# lmer with P/A for fish biomass
#summary(fish_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_P_A)

# lmer with >0 fish biomass
#summary(fish_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_above_0)

fish_vs_cover_code_mod_plot_no_trend
# figure without trendline since it is an marginal result
#fish_vs_cover_code_mod_plot
# trendline added
fish_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(fish_vs_cover_code_mod_lm)
```

```{r PC Juvenile Coral Cover vs. Benthic Algal Overgrowth, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Algal Cover Code vs. Total Colony Area (Less coral with more algae)
# lmer model
summary(col_area_vs_cover_code_lmer_only)

r.squaredGLMM(col_area_vs_cover_code_lmer_only)

# lmer full model
summary(col_area_vs_cover_code_lmer)
r.squaredGLMM(col_area_vs_cover_code_lmer)
effect(col_area_vs_cover_code_lmer)

# lmer dropped non-significant variables
#summary(col_area_vs_cover_code_lmer_sig)
#r.squaredGLMM(col_area_vs_cover_code_lmer_sig)

# lmer with P/A for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_P_A)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_P_A)

# lmer with >1 for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_above_1)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_above_1)

#col_area_vs_cover_code_mod_plot
# figure with trendline
col_area_vs_cover_code_plot
# raw data figure with trendline
#effect(col_area_vs_cover_code_lmer_only)
# effects plot for raw lmer
col_area_vs_cover_code_mod_lmer_plot
# lmer plot with model trendline

# lm model 
summary(col_area_vs_cover_code_mod_lm)

```

```{r PC Herbivore Hypothesis Saved Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Urchins
ggsave("Algal overgrowth vs urchins final.png", plot = urchin_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final with trend.png", plot = urchin_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data without trend.png", plot = urchin_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data.png", plot = urchin_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Herbivorous fish
ggsave("Algal overgrowth vs herbivorous fish final.png", plot = fish_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final with trend.png", plot = fish_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data without trend.png", plot = fish_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data.png", plot = fish_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Coral cover vs. benthic algal code
ggsave("PC coral cover vs algal overgrowth.png", plot = col_area_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("PC coral cover vs algal overgrowth raw data.png", plot = col_area_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more shelter)
summary(PC_recruitment_lmer_original)
# model summary

PC_recruitment_trans_fit
# fit

r.squaredGLMM(PC_recruitment_lmer_original)
# r^2

# pairwise multiple comparisons
mc_recruitment <- emmeans(PC_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment)
# pairwise multiple comparisons simple
mc_recruitment <- emmeans(PC_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment, simple = "each")


recruitment_plot_4

## Recruitment without interaction (More coral recruitment with more shelter)
#summary(recruitment_lmer_no_interaction_original)
#r.squaredGLMM(recruitment_lmer_no_interaction_original)
```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Survival transformed (Greater coral survival with more shelter)
summary(PC_1_5_survival_glmmTMB)


# final DHARMa Q-Q plot
qqnorm(resid(PC_1_5_survival_glmmTMB), main = "PC 1-5 survival glmmTMB Residuals")
qqline(resid(PC_1_5_survival_glmmTMB))
PC_1_5_survival_fit_glmmTMB
#fit

DHARMa::testDispersion(PC_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PC 1-5 survival glmmTMB")



r.squaredGLMM(PC_1_5_survival_glmmTMB)
performance::r2_nakagawa(PC_1_5_survival_glmmTMB)
# r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PC_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PC_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")



## Survival (Greater coral survival with more shelter)
#summary(PC_1_5_survival_lmer_original)


#PC_1_5_survival_fit
#fit

#r.squaredGLMM(PC_1_5_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PC_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons
#mc_survival <- emmeans(PC_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PC_1_5_growth_mixed_effects_original_trans)

#qqnorm(resid(PC_1_5_growth_mixed_effects_original_trans), main = "PC 1-5 Growth trans")
#qqline(resid(PC_1_5_growth_mixed_effects_original_trans))
#PC_1_5_growth_fit_trans
# fit

#r.squaredGLMM(PC_1_5_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PC_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PC_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PC_1_5_growth_mixed_effects_original)


PC_1_5_growth_fit
# fit

r.squaredGLMM(PC_1_5_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PC_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PC_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


# PC 6-10 mm
```{r PC 6-10 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "PC_S_6_10"
Grow <- "PC_G_6_10" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PC 6-10 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 6
max <- 10
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 2


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PC")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PC")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```


```{r PC 6-10 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PC 6-10 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PC 6-10 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PC 6-10 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PC 6-10 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PC 6-10 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PC_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PC_6_10_survival_glmmTMB)

r.squaredGLMM(PC_6_10_survival_glmmTMB)
performance::r2_nakagawa(PC_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PC_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_6_10_survival_glmmTMB, plot = T)
PC_6_10_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 6-10 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PC_6_10_survival_glmmTMB), main = "PC 6-10 survival glmmTMB Residuals")
qqline(resid(PC_6_10_survival_glmmTMB))
PC_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 6-10 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_6_10_survival_glmmTMB), main = "PC 6-10 Survival")
qqline(resid(PC_6_10_survival_glmmTMB))
dev.off()



PC_6_10_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PC_6_10_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PC 6-10 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PC 6-10 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_6_10_survival_lmer_original), main = "PC 6-10 survival Residuals")
qqline(resid(PC_6_10_survival_lmer_original))
dev.off()

qqnorm(resid(PC_6_10_survival_lmer_original), main = "PC 6-10 survival Residuals")
qqline(resid(PC_6_10_survival_lmer_original))
PC_6_10_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PC_6_10_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PC_6_10_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PC_6_10_survival_lmer_original), main = "PC 6-10 survival")
# effects plots
```


```{r PC 6-10 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PC 6-10 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PC_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PC_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 6-10 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_6_10_survival_lmer), main = "Urchins vs. PC 6-10 Survival Residual Plot Original")
qqline(resid(urchin_vs_PC_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_6_10_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(urchin_vs_PC_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_6_10_survival_lmer), main = "Urchins vs PC 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_6_10_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 6-10 survival vs. urchins final.png", plot = urchin_vs_PC_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PC_6_10_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PC_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 6-10 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_6_10_survival_lmer), main = "Herbivorous fish vs. PC 6-10 Survival Residual Plot Original")
qqline(resid(fish_vs_PC_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_6_10_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(fish_vs_PC_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_6_10_survival_lmer), main = "Herbivorous fish vs PC 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_6_10_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 6-10 survival vs. herbivorous fish final.png", plot = fish_vs_PC_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PC_6_10_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PC_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 6-10 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_6_10_survival_lmer),main = "Algal overgrowth vs PC 6-10 Survival Residual Plot Original")
qqline(resid(algae_vs_PC_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_6_10_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PC_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_6_10_survival_lmer), main = "Algal overgrowth vs PC 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_6_10_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 6-10 survival vs. algal overgrowth final.png", plot = algae_vs_PC_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PC_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_6_10_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PC_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_6_10_survival_glmmTMB, plot = T)
PC_6_10_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 6-10 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB), main = "U,F,& AO vs. PC 6-10 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB))
urchin_fish_algae_vs_PC_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 6-10 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB), main = "PC 6-10 Survival")
qqline(resid(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PC 6-10 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_6_10_survival_lmer), main = "U,F,& AO vs. PC 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_6_10_survival_lmer), main = "U,F,& AO vs. PC 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_survival_lmer))
urchin_fish_algae_vs_PC_6_10_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_6_10_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_6_10_survival_lmer), main = "U,F,& AO vs. PC 6-10 survival")
# effects plots

```


```{r PC 6-10 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PC 6-10 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PC 6-10 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PC_6_10_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_6_10_growth_mixed_effects_original)

r.squaredGLMM(PC_6_10_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PC_6_10_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_6_10_growth_mixed_effects_original_trans)
# transformed model
```


```{r PC 6-10 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PC 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_6_10_growth_mixed_effects_original), main = "PC 6-10 Growth")
qqline(resid(PC_6_10_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PC_6_10_growth_mixed_effects_original), main = "PC 6-10 Growth")
qqline(resid(PC_6_10_growth_mixed_effects_original))
PC_6_10_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_6_10_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PC_6_10_growth_mixed_effects_original), main = "PC 6-10 growth")
# interaction plots

emm_original <- emmeans(PC_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PC 6-10 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_6_10_growth_mixed_effects_original_trans), main = "PC 6-10 Growth")
qqline(resid(PC_6_10_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PC_6_10_growth_mixed_effects_original_trans), main = "PC 6-10 Growth")
qqline(resid(PC_6_10_growth_mixed_effects_original_trans))
PC_6_10_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_6_10_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PC_6_10_growth_mixed_effects_original_trans), main = "PC 6-10 growth")
# interaction plots

emm_original <- emmeans(PC_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PC 6-10 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PC 6-10 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PC_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PC_6_10_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PC 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_6_10_growth_lmer, main = "Urchins vs. PC 6-10 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PC_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PC_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_6_10_growth_lmer), main = "Urchins vs PC 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_6_10_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PC 6-10 growth final.png", plot = urchin_vs_PC_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PC_6_10_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PC_6_10_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PC 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_6_10_growth_lmer, main = "Fish vs. PC 6-10 Growth Residual Plot Original"))
qqline(resid(fish_vs_PC_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PC_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_6_10_growth_lmer), main = "Fish vs. PC 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_6_10_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PC 6-10 growth final.png", plot = fish_vs_PC_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PC_6_10_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PC_6_10_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PC 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_6_10_growth_lmer, main = "Algae vs. PC 6-10 Growth Residual Plot Original"))
qqline(resid(algae_vs_PC_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PC_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_6_10_growth_lmer), main = "Algae vs. PC 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_6_10_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PC 6-10 growth final.png", plot = algae_vs_PC_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 6-10 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PC_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_6_10_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PC_6_10_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 6-10 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans), main = "PC 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans), main = "U,F,& AO vs. PC 6-10 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans))
urchin_fish_algae_vs_PC_6_10_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_6_10_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_6_10_growth_lmer_trans), main = "U,F,& AO vs. PC 6-10 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer), main = "PC 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer))
urchin_fish_algae_vs_PC_6_10_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_6_10_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PC_6_10_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PC 6-10 glmmTMB survival")


r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PC_6_10_survival_glmmTMB), main = "U,F,& AO vs. PC 6-10 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PC_6_10_survival_lmer)

#urchin_fish_algae_vs_PC_6_10_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_6_10_survival_lmer), main = "U,F,& AO vs. PC 6-10 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PC_6_10_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_6_10_growth_lmer))

urchin_fish_algae_vs_PC_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_6_10_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_6_10_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PC_6_10_survival_glmmTMB)
# r^2

PC_6_10_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PC_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PC 6-10 survival glmmTMB")



r.squaredGLMM(PC_6_10_survival_glmmTMB)
performance::r2_nakagawa(PC_6_10_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PC_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PC_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PC_6_10_survival_lmer_original)


#PC_6_10_survival_fit
# fit

#r.squaredGLMM(PC_6_10_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PC_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PC_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PC_6_10_growth_mixed_effects_original_trans)


#qqnorm(resid(PC_6_10_growth_mixed_effects_original_trans), main = "PC 6-10 Growth trans")
#qqline(resid(PC_6_10_growth_mixed_effects_original_trans))
#PC_6_10_growth_fit_trans
# fit

#r.squaredGLMM(PC_6_10_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PC_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PC_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PC_6_10_growth_mixed_effects_original)


PC_6_10_growth_fit
# fit

r.squaredGLMM(PC_6_10_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PC_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PC_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


# PC 11-15 mm
```{r PC 11-15 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###



###### Summary Plot Databases
Sur <- "PC_S_11_15"
Grow <- "PC_G_11_15" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PC 11-15 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 11
max <- 15
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 3


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PC")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PC")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PC 11-15 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PC 11-15 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PC 11-15 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PC 11-15 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PC 11-15 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PC 11-15 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PC_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PC_11_15_survival_glmmTMB)

r.squaredGLMM(PC_11_15_survival_glmmTMB)
performance::r2_nakagawa(PC_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PC_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_11_15_survival_glmmTMB, plot = T)
PC_11_15_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 11-15 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 11-15 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PC_11_15_survival_glmmTMB), main = "PC 11-15 survival glmmTMB Residuals")
qqline(resid(PC_11_15_survival_glmmTMB))
PC_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 11-15 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_11_15_survival_glmmTMB), main = "PC 11-15 Survival")
qqline(resid(PC_11_15_survival_glmmTMB))
dev.off()



PC_11_15_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PC_11_15_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PC 11-15 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PC 11-15 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_11_15_survival_lmer_original), main = "PC 11-15 survival Residuals")
qqline(resid(PC_11_15_survival_lmer_original))
dev.off()

qqnorm(resid(PC_11_15_survival_lmer_original), main = "PC 11-15 survival Residuals")
qqline(resid(PC_11_15_survival_lmer_original))
PC_11_15_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PC_11_15_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PC_11_15_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PC_11_15_survival_lmer_original), main = "PC 11-15 survival")
# effects plots
```


```{r PC 11-15 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)



## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))



### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PC 11-15 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PC_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PC_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 11-15 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_11_15_survival_lmer), main = "Urchins vs. PC 11-15 Survival Residual Plot Original")
qqline(resid(urchin_vs_PC_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_11_15_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(urchin_vs_PC_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_11_15_survival_lmer), main = "Urchins vs PC 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_11_15_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 11-15 survival vs. urchins final.png", plot = urchin_vs_PC_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PC_11_15_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PC_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 11-15 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_11_15_survival_lmer), main = "Herbivorous fish vs. PC 11-15 Survival Residual Plot Original")
qqline(resid(fish_vs_PC_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_11_15_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(fish_vs_PC_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_11_15_survival_lmer), main = "Herbivorous fish vs PC 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_11_15_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 11-15 survival vs. herbivorous fish final.png", plot = fish_vs_PC_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PC_11_15_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PC_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 11-15 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_11_15_survival_lmer),main = "Algal overgrowth vs PC 11-15 Survival Residual Plot Original")
qqline(resid(algae_vs_PC_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_11_15_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PC_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_11_15_survival_lmer), main = "Algal overgrowth vs PC 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_11_15_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 11-15 survival vs. algal overgrowth final.png", plot = algae_vs_PC_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PC_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_11_15_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PC_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_11_15_survival_glmmTMB, plot = T)
PC_11_15_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 11-15 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 11-15 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB), main = "U,F,& AO vs. PC 11-15 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB))
urchin_fish_algae_vs_PC_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 11-15 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB), main = "PC 11-15 Survival")
qqline(resid(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PC 11-15 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_11_15_survival_lmer), main = "U,F,& AO vs. PC 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_11_15_survival_lmer), main = "U,F,& AO vs. PC 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_survival_lmer))
urchin_fish_algae_vs_PC_11_15_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_11_15_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_11_15_survival_lmer), main = "U,F,& AO vs. PC 11-15 survival")
# effects plots

```


```{r PC 11-15 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PC 11-15 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PC 11-15 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PC_11_15_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_11_15_growth_mixed_effects_original)

r.squaredGLMM(PC_11_15_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PC_11_15_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_11_15_growth_mixed_effects_original_trans)
# transformed model
```


```{r PC 11-15 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PC 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_11_15_growth_mixed_effects_original), main = "PC 11-15 Growth")
qqline(resid(PC_11_15_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PC_11_15_growth_mixed_effects_original), main = "PC 11-15 Growth")
qqline(resid(PC_11_15_growth_mixed_effects_original))
PC_11_15_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_11_15_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PC_11_15_growth_mixed_effects_original), main = "PC 11-15 growth")
# interaction plots

emm_original <- emmeans(PC_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PC 11-15 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_11_15_growth_mixed_effects_original_trans), main = "PC 11-15 Growth")
qqline(resid(PC_11_15_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PC_11_15_growth_mixed_effects_original_trans), main = "PC 11-15 Growth trans")
qqline(resid(PC_11_15_growth_mixed_effects_original_trans))
PC_11_15_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_11_15_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PC_11_15_growth_mixed_effects_original_trans), main = "PC 11-15 growth")
# interaction plots

emm_original <- emmeans(PC_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PC 11-15 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)



## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PC 11-15 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PC_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PC_11_15_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PC 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_11_15_growth_lmer, main = "Urchins vs. PC 11-15 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PC_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PC_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_11_15_growth_lmer), main = "Urchins vs PC 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_11_15_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PC 11-15 growth final.png", plot = urchin_vs_PC_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PC_11_15_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PC_11_15_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PC 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_11_15_growth_lmer, main = "Fish vs. PC 11-15 Growth Residual Plot Original"))
qqline(resid(fish_vs_PC_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PC_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_11_15_growth_lmer), main = "Fish vs. PC 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_11_15_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PC 11-15 growth final.png", plot = fish_vs_PC_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PC_11_15_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PC_11_15_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PC 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_11_15_growth_lmer, main = "Algae vs. PC 11-15 Growth Residual Plot Original"))
qqline(resid(algae_vs_PC_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PC_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_11_15_growth_lmer), main = "Algae vs. PC 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_11_15_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PC 11-15 growth final.png", plot = algae_vs_PC_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 11-15 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PC_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_11_15_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PC_11_15_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 11-15 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans), main = "PC 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans), main = "U,F,& AO vs. PC 11-15 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans))
urchin_fish_algae_vs_PC_11_15_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_11_15_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_11_15_growth_lmer_trans), main = "U,F,& AO vs. PC 11-15 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer), main = "PC 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer), main = "U,F,& AO vs. PC 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer))
urchin_fish_algae_vs_PC_11_15_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_11_15_growth_lmer), main = "U,F,& AO vs. PC 11-15 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PC_11_15_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PC 11-15 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PC_11_15_survival_glmmTMB), main = "U,F,& AO vs. PC 11-15 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PC_11_15_survival_lmer)

#urchin_fish_algae_vs_PC_11_15_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_11_15_survival_lmer), main = "U,F,& AO vs. PC 11-15 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PC_11_15_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer), main = "U,F,& AO vs. PC 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_11_15_growth_lmer))

urchin_fish_algae_vs_PC_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_11_15_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_11_15_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PC_11_15_survival_glmmTMB)
# r^2

PC_11_15_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PC_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PC 11-15 survival glmmTMB")


r.squaredGLMM(PC_11_15_survival_glmmTMB)
performance::r2_nakagawa(PC_11_15_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PC_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PC_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PC_11_15_survival_lmer_original)


#PC_11_15_survival_fit
# fit

#r.squaredGLMM(PC_11_15_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PC_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PC_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PC_11_15_growth_mixed_effects_original_trans)


#qqnorm(resid(PC_11_15_growth_mixed_effects_original_trans), main = "PC 11-15 Growth trans")
#qqline(resid(PC_11_15_growth_mixed_effects_original_trans))
#PC_11_15_growth_fit_trans
# fit

#r.squaredGLMM(PC_11_15_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PC_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PC_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PC_11_15_growth_mixed_effects_original)


PC_11_15_growth_fit
# fit

r.squaredGLMM(PC_11_15_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PC_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PC_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```

# PC 16-20 mm
```{r PC 16-20 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "PC_S_16_20"
Grow <- "PC_G_16_20" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PC 16-20 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 16
max <- 20
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 4


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PC")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PC")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PC 16-20 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PC 16-20 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PC 16-20 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PC 16-20 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PC 16-20 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PC 16-20 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PC_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PC_16_20_survival_glmmTMB)

r.squaredGLMM(PC_16_20_survival_glmmTMB)
performance::r2_nakagawa(PC_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PC_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_16_20_survival_glmmTMB, plot = T)
PC_16_20_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 16-20 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 16-20 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PC_16_20_survival_glmmTMB), main = "PC 16-20 survival glmmTMB Residuals")
qqline(resid(PC_16_20_survival_glmmTMB))
PC_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 16-20 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_16_20_survival_glmmTMB), main = "PC 16-20 Survival")
qqline(resid(PC_16_20_survival_glmmTMB))
dev.off()



PC_16_20_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PC_16_20_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PC 16-20 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PC 16-20 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_16_20_survival_lmer_original), main = "PC 16-20 survival Residuals")
qqline(resid(PC_16_20_survival_lmer_original))
dev.off()

qqnorm(resid(PC_16_20_survival_lmer_original), main = "PC 16-20 survival Residuals")
qqline(resid(PC_16_20_survival_lmer_original))
PC_16_20_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PC_16_20_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PC_16_20_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PC_16_20_survival_lmer_original), main = "PC 16-20 survival")
# effects plots
```


```{r PC 16-20 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)



## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))



### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PC 16-20 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PC_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PC_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 16-20 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_16_20_survival_lmer), main = "Urchins vs. PC 16-20 Survival Residual Plot Original")
qqline(resid(urchin_vs_PC_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_16_20_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(urchin_vs_PC_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_16_20_survival_lmer), main = "Urchins vs PC 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_16_20_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 16-20 survival vs. urchins final.png", plot = urchin_vs_PC_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PC_16_20_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PC_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 16-20 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_16_20_survival_lmer), main = "Herbivorous fish vs. PC 16-20 Survival Residual Plot Original")
qqline(resid(fish_vs_PC_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_16_20_survival_lmer)
#r-squared

emm_PC_survival_lmer_1_original <- emmeans(fish_vs_PC_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PC_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_16_20_survival_lmer), main = "Herbivorous fish vs PC 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_16_20_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 16-20 survival vs. herbivorous fish final.png", plot = fish_vs_PC_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PC_16_20_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PC_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PC 16-20 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_16_20_survival_lmer),main = "Algal overgrowth vs PC 16-20 Survival Residual Plot Original")
qqline(resid(algae_vs_PC_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_16_20_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PC_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_16_20_survival_lmer), main = "Algal overgrowth vs PC 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_16_20_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PC 16-20 survival vs. algal overgrowth final.png", plot = algae_vs_PC_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PC_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_16_20_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PC_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_16_20_survival_glmmTMB, plot = T)
PC_16_20_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PC 16-20 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PC 16-20 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB), main = "U,F,& AO vs. PC 16-20 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB))
urchin_fish_algae_vs_PC_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PC 16-20 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB), main = "PC 16-20 Survival")
qqline(resid(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PC 16-20 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_16_20_survival_lmer), main = "U,F,& AO vs. PC 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_16_20_survival_lmer), main = "U,F,& AO vs. PC 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_survival_lmer))
urchin_fish_algae_vs_PC_16_20_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_16_20_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_16_20_survival_lmer), main = "U,F,& AO vs. PC 16-20 survival")
# effects plots

```


```{r PC 16-20 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PC 16-20 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PC 16-20 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PC_16_20_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_16_20_growth_mixed_effects_original)

r.squaredGLMM(PC_16_20_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PC_16_20_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PC_16_20_growth_mixed_effects_original_trans)
# transformed model
```


```{r PC 16-20 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PC 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_16_20_growth_mixed_effects_original), main = "PC 16-20 Growth")
qqline(resid(PC_16_20_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PC_16_20_growth_mixed_effects_original), main = "PC 16-20 Growth")
qqline(resid(PC_16_20_growth_mixed_effects_original))
PC_16_20_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_16_20_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PC_16_20_growth_mixed_effects_original), main = "PC 16-20 growth")
# interaction plots

emm_original <- emmeans(PC_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PC 16-20 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PC_16_20_growth_mixed_effects_original_trans), main = "PC 16-20 Growth")
qqline(resid(PC_16_20_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PC_16_20_growth_mixed_effects_original_trans), main = "PC 16-20 Growth trans")
qqline(resid(PC_16_20_growth_mixed_effects_original_trans))
PC_16_20_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PC_16_20_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PC_16_20_growth_mixed_effects_original_trans), main = "PC 16-20 growth")
# interaction plots

emm_original <- emmeans(PC_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PC 16-20 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PC 16-20 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PC_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PC_16_20_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PC 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PC_16_20_growth_lmer, main = "Urchins vs. PC 16-20 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PC_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PC_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PC_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PC_16_20_growth_lmer), main = "Urchins vs PC 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PC_16_20_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PC_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PC 16-20 growth final.png", plot = urchin_vs_PC_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PC_16_20_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PC_16_20_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PC 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PC_16_20_growth_lmer, main = "Fish vs. PC 16-20 Growth Residual Plot Original"))
qqline(resid(fish_vs_PC_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PC_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PC_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PC_16_20_growth_lmer), main = "Fish vs. PC 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PC_16_20_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PC_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PC 16-20 growth final.png", plot = fish_vs_PC_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PC_16_20_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PC_16_20_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PC 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PC_16_20_growth_lmer, main = "Algae vs. PC 16-20 Growth Residual Plot Original"))
qqline(resid(algae_vs_PC_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PC_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PC_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PC_16_20_growth_lmer), main = "Algae vs. PC 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PC_16_20_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PC_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PC 16-20 growth final.png", plot = algae_vs_PC_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PC 16-20 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PC_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_16_20_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PC_16_20_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 16-20 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans), main = "PC 16-20 Growth")
qqline(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans), main = "U,F,& AO vs. PC 16-20 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans))
urchin_fish_algae_vs_PC_16_20_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_16_20_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_16_20_growth_lmer_trans), main = "U,F,& AO vs. PC 16-20 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PC 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer), main = "PC 16-20 Growth")
qqline(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer), main = "U,F,& AO vs. PC 16-20 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer))
urchin_fish_algae_vs_PC_16_20_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PC_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PC_16_20_growth_lmer), main = "U,F,& AO vs. PC 16-20 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PC_16_20_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PC_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PC 16-20 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PC_16_20_survival_glmmTMB), main = "U,F,& AO vs. PC 16-20 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PC_16_20_survival_lmer)

#urchin_fish_algae_vs_PC_16_20_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_16_20_survival_lmer), main = "U,F,& AO vs. PC 16-20 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PC_16_20_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer), main = "U,F,& AO vs. PC 16 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PC_16_20_growth_lmer))

urchin_fish_algae_vs_PC_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PC_16_20_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PC_16_20_growth_lmer), main = "U,F,& AO vs. PC 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PC_16_20_survival_glmmTMB)
# r^2

PC_16_20_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PC_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PC_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PC 16-20 survival glmmTMB")



r.squaredGLMM(PC_16_20_survival_glmmTMB)
performance::r2_nakagawa(PC_16_20_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PC_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PC_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PC_16_20_survival_lmer_original)


#PC_16_20_survival_fit
# fit

#r.squaredGLMM(PC_16_20_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PC_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PC_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PC_16_20_growth_mixed_effects_original_trans)


#qqnorm(resid(PC_16_20_growth_mixed_effects_original_trans), main = "PC 16-20 Growth trans")
#qqline(resid(PC_16_20_growth_mixed_effects_original_trans))
#PC_16_20_growth_fit_trans
# fit

#r.squaredGLMM(PC_16_20_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PC_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PC_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PC_16_20_growth_mixed_effects_original)


PC_16_20_growth_fit
# fit

r.squaredGLMM(PC_16_20_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PC_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PC_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


```{r PC Transition Matrix Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Workflow
# Change "min" in the "Variables" code chunk to 1 and "max" to 100 to insure you include all corals that grew from either size class 1, 2, 3, or 4 to a larger size class (5) outside 1-20 mm

# Run code through "Breakthrough code" to create long database with all transition probabilities for each quarter

# Run code for creation of transition matrices for Site only and Shelter only (no interaction)

### Site x Shelter Transition Matrix Dataframe Code ###
growth_data_all_matrix <- growth_data_all_matrix[!grepl("_", growth_data_all_matrix$ID),]
# filter out colonies that fused




growth_data_all_matrix <- growth_data_all_matrix %>% mutate(diameter_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(diameter_end), NA, diameter_end),
                                                            size_class_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(size_class_end), NA, size_class_end))
###NOTE: added mutate to make the "diameter_end" and "size_class_end" variables NA even if there was a final measurement of the dead colony in the database.  This is needed for calculating probabilities below for transition matrices which is based on the "size_class_end" being NA to count the transition as mortality.




max_size_class <- 4
# largest size class in transition matrix

## Size class sample size database
sample_size_data <- growth_data_all_matrix %>%
  filter(!is.na(diameter_start), size_class_start <= max_size_class) %>% 
  group_by(Site_long, Shelter, size_class_start) %>% 
  summarise(sample_size = n()) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_"))

test_dataframe_a <- growth_data_all_matrix %>% 
  filter(size_class_start <= max_size_class) %>% 
  group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>% 
  summarise(total_col = n())
# database with total number of colonies for each starting size class for each quarter


test_dataframe <- growth_data_all_matrix %>% filter(size_class_start <= max_size_class) %>% group_by(`Module #`, Quarter, Site_long, Shelter, size_class_start, size_class_end) %>% 
  summarise(total_size = n())
# database with totals for each starting size class transition including mortality represented by size_class_end = NA


test_dataframe_combined <- left_join(test_dataframe, test_dataframe_a)

test_dataframe_combined$total_col <- as.numeric(test_dataframe_combined$total_col)
# make the total_col column into a numeric column

####
# Breakthrough code
test_dataframe_combined_final <- test_dataframe_combined %>% ungroup() %>% 
  complete(`Module #`, Quarter, size_class_start, size_class_end, fill = list(total_size = 0, total_col = 0.5)) %>% 
  mutate(percent_of_colonies = total_size/total_col) %>% 
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_")) %>% 
  sjmisc::replace_na(size_class_end, value = "M")


test_dataframe_combined_final_test <- test_dataframe_combined_final %>% group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>%

  mutate(total_col_new = ifelse(total_col == 0.5, max(total_col), total_col))

test_dataframe_combined_final_test <- test_dataframe_combined_final_test %>% filter(total_col_new != 0.5)

###### Dataframe for Site x Shelter heat maps and matrices



test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_test %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)
# Calculate mean transition probabilities for Site x Shelter
###NOTE: changed "test_dataframe_combined_final_summary_3" to "test_dataframe_combined_final_summary_4" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter

#test_dataframe_combined_final_summary_3 <- test_dataframe_combined_final_test %>% group_by(Quarter, experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))
# Calculate mean transition probabilities for Site x Shelter for each quarter

#test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_3 %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)
# Calculate mean of means to get a mean transition probability for Site x Shelter throughout the study with calculated standard errors




test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% ungroup() %>% 
  complete(experimental_treatment, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))
# Complete function used to insure that no mean transition probabilites are missing.  If not necessary, this version of "test_dataframe_combined_final_summary_4" should be the same as the earlier version above.

test_dataframe_combined_final_summary_4$size_class_end <- factor(test_dataframe_combined_final_summary_4$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
test_dataframe_combined_final_summary_4 <- left_join(test_dataframe_combined_final_summary_4, sample_size_data) %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))


## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4$mean_transition_prob <- round(test_dataframe_combined_final_summary_4$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4$se <- round(test_dataframe_combined_final_summary_4$se, 3)

# Make a new character column for including the mean plus or minus the standard error for placement inside of transition matrices
test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Site Transition Matrix Dataframe Code ###



test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_test %>% group_by(Site_long, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Site" to "test_dataframe_combined_final_summary_4_Site" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Site <- test_dataframe_combined_final_test %>% group_by(Quarter, Site_long, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))

#test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_3_Site %>% group_by(Site_long, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)



test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% ungroup() %>% 
  complete(Site_long, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Site$size_class_end <- factor(test_dataframe_combined_final_summary_4_Site$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Site <- sample_size_data %>% group_by(Site_long, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Site <- left_join(test_dataframe_combined_final_summary_4_Site, sample_size_data_Site) 

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Site$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Site$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Site$se <- round(test_dataframe_combined_final_summary_4_Site$se, 3)

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Shelter Transition Matrix Dataframe Code ###


test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_test %>% group_by(Shelter, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Shelter" to "test_dataframe_combined_final_summary_4_Shelter" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Shelter <- test_dataframe_combined_final_test %>% group_by(Quarter, Shelter, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))


#test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_3_Shelter %>% group_by(Shelter, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)




test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% ungroup() %>% 
  complete(Shelter, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Shelter$size_class_end <- factor(test_dataframe_combined_final_summary_4_Shelter$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Shelter <- sample_size_data %>% group_by(Shelter, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Shelter <- left_join(test_dataframe_combined_final_summary_4_Shelter, sample_size_data_Shelter) 

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Shelter$se <- round(test_dataframe_combined_final_summary_4_Shelter$se, 3)

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Separated databases by Site x Shelter, Site, and Shelter ### 
HAN_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_High")
HAN_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_Low")
WAI_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_High")
WAI_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_Low")

WAI_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Waikiki")
HAN_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Hanauma Bay")

Low_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "Low")
High_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "High")

### Site x Shelter Matrix Generation Code ### 
## Hanauma Bay_High
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_High_Matrix <- matrix(HAN_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_High_Matrix <- rbind(HAN_High_Matrix, n_size)

HAN_High_Matrix <- as.data.frame(HAN_High_Matrix)
HAN_High_Matrix_table <- tab_df(HAN_High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC HAN_High Transition Matrix.html")

## Hanauma Bay_Low
n_size <- HAN_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Low_Matrix <- matrix(HAN_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Low_Matrix <- rbind(HAN_Low_Matrix, n_size)

HAN_Low_Matrix <- as.data.frame(HAN_Low_Matrix)
HAN_Low_Matrix_table <- tab_df(HAN_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC HAN_Low Transition Matrix.html")


## Waikiki_High
n_size <- WAI_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_High_Matrix <- matrix(WAI_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_High_Matrix <- rbind(WAI_High_Matrix, n_size)

WAI_High_Matrix <- as.data.frame(WAI_High_Matrix)
WAI_High_Matrix_table <- tab_df(WAI_High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC WAI_High Transition Matrix.html")

## Waikiki_Low
n_size <- WAI_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

WAI_Low_Matrix <- matrix(WAI_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Low_Matrix <- rbind(WAI_Low_Matrix, n_size)

WAI_Low_Matrix <- as.data.frame(WAI_Low_Matrix)
WAI_Low_Matrix_table <- tab_df(WAI_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC WAI_Low Transition Matrix.html")
####


### Site Matrix Generation Code ###
# Hanauma Bay only
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Matrix <- matrix(HAN_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Matrix <- rbind(HAN_Matrix, n_size)

HAN_Matrix <- as.data.frame(HAN_Matrix)
HAN_Matrix_table <- tab_df(HAN_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC Hanauma Bay Transition Matrix.html")


## Waikiki only
n_size <- WAI_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_Matrix <- matrix(WAI_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Matrix <- rbind(WAI_Matrix, n_size)

WAI_Matrix <- as.data.frame(WAI_Matrix)
WAI_Matrix_table <- tab_df(WAI_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC Waikiki Transition Matrix.html")


### Shelter Matrix Generation Code ###
# Low_only
n_size <- Low_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
Low_Matrix <- matrix(Low_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
Low_Matrix <- rbind(Low_Matrix, n_size)

Low_Matrix <- as.data.frame(Low_Matrix)
Low_Matrix_table <- tab_df(Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC Low Shelter Transition Matrix.html")


# High_only
n_size <- High_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
High_Matrix <- matrix(High_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
High_Matrix <- rbind(High_Matrix, n_size)

High_Matrix <- as.data.frame(High_Matrix)
High_Matrix_table <- tab_df(High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PC High Shelter Transition Matrix.html")


### Site x Shelter Heat Map Generation Code ###
## Waikiki_Low
WAI_Low_Heat_Map <- ggplot(data = WAI_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Waikiki_High
WAI_High_Heat_Map <- ggplot(data = WAI_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_High") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_Low
HAN_Low_Heat_Map <- ggplot(data = HAN_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_High
HAN_High_Heat_Map <- ggplot(data = HAN_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_High") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Site Heat Map Generation Code ###
# Waikiki only
WAI_Heat_Map <- ggplot(data = WAI_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5))  


# Hanauma Bay only
HAN_Heat_Map <- ggplot(data = HAN_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Shelter Heat Map Generation Code ###
# Low shelter only
Low_Heat_Map <- ggplot(data = Low_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Low Shelter") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# High shelter only
High_Heat_Map <- ggplot(data = High_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("High Shelter") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 

```

## Transition Matrices and Heat Maps
Transition matrices and heat maps that quantify and visualize probabilities of growth, stasis, shrinkage, and death for corals of all coral size classes (1-4) including growth to larger size classes (5).  Transition matrices also include the number of colonies that comprise the transitions for each size class.

Transition matrices and heat maps are presented in two forms: 1.) comparing each reefscape x shelter treatment combination (eg. Waikiki low shelter modules) and 2.) comparing low vs. high shelter regardless of reefscape and Waikiki vs. Hanauma Bay regardless of shelter treatment.

```{r, echo = TRUE, message=FALSE, warning=FALSE}
## NOTE: In all matrices row 5 represents the size class that is > 20 mm in diameter, row 6 represents percent mortality for each size class (1-4), and row 7 represents the total number of corals sampled in each size class or the sample size

## Waikiki-Low
WAI_Low_Matrix_table
WAI_Low_Heat_Map

ggsave("PC_WAI_Low_Heat_Map final.png", plot = WAI_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki-High
WAI_High_Matrix_table
WAI_High_Heat_Map

ggsave("PC_WAI_High_Heat_Map final.png", plot = WAI_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-Low
HAN_Low_Matrix_table
HAN_Low_Heat_Map

ggsave("PC_HAN_Low_Heat_Map final.png", plot = HAN_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-High
HAN_High_Matrix_table
HAN_High_Heat_Map

ggsave("PC_HAN_High_Heat_Map final.png", plot = HAN_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Low Shelter
Low_Matrix_table
Low_Heat_Map

ggsave("PC_Low_Heat_Map final.png", plot = Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## High Shelter
High_Matrix_table
High_Heat_Map

ggsave("PC_High_Heat_Map final.png", plot = High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki
WAI_Matrix_table
WAI_Heat_Map

ggsave("PC_WAI_Heat_Map final.png", plot = WAI_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay
HAN_Matrix_table
HAN_Heat_Map

ggsave("PC_HAN_Heat_Map final.png", plot = HAN_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```




# MO 1-5 mm
```{r MO 1-5 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Rec <- "MO_1_5" 
Sur <- "MO_S_1_5"
Grow <- "MO_G_1_5" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r MO 1-5 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 1
max <- 5
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 1


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("MO", "MPA")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("MO")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r MO 1-5 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```

```{r MO 1-5 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```

```{r MO 1-5 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r MO 1-5 Recruitment Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


### General Workflow Summary
# Make series of databases (ID Databases) for each quarter that filter for all corals within the designated size range represented by the size_vect vector while preventing any individual coral ID from being used in subsequent quarters (prevent pseudoreplication by sampling a individual coral colony more than once)

# Make a series of databases (Quarterly Total Recruits and Larval Output Databases) for each quarter that summarize the total number of recruits and total larval ouput for each module side and coral size_class using the previous series of databases to filter out corals that have already been sampled in previous timesteps or quarters

# Bind these series of databases together by row to make a new single dataframe with all module sides and size classes

# Used date log database to add survey dates back into the database that were lost during the use of the complete() function to fill in missing data (where no corals were observed which means there were 0 recruits per square meter not that there are no data)

# Used the complete() functions twice more to fill in for missing data after joining databases

# Use a series of group_by() and summary() functions to group data such that mean coral recruitment per square meter is calculated based on the total area of both N and S sides of each module

### ID Databases
start_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1))

Q1_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2))

Q2_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3))

Q3_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4))

Q4_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5))

Q5_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6))

Q6_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7))

Q7_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8))

Q8_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9))

Q9_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10))

Q10_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11))

Q11_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12))

#Q12_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13))


### Quarterly Total Recruits and Larval Output Databases
start_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q1_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q2_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q3_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q4_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>%  
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q5_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q6_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q7_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q8_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q9_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q10_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q11_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12)) %>% 
  group_by(`Taxonomic Code`, Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

#Q12_recruiment <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13)) %>% 
#  group_by(Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output, Sector, Sector_Area) %>% 
#  summarise(recruits = n(),
 #           total_larvae = sum(larval_output))

### Final Databases
n1_original <- bind_rows(start_recruitment_original, Q1_recruitment_original, Q2_recruitment_original, Q3_recruitment_original, Q4_recruitment_original, Q5_recruitment_original, Q6_recruitment_original, Q7_recruitment_original, Q8_recruitment_original, Q9_recruitment_original, Q10_recruiment_original, Q11_recruiment_original)

date_data <- read_csv("databases/Coral Census Date Log.csv")

date_data$Date <- as.Date(date_data$Date,'%m/%d/%y')
n1_original$Date <- as.Date(n1_original$Date, '%m/%d/%y')
n1_original$Year <- as.numeric(n1_original$Year)
date_data$Year <- as.numeric(date_data$Year)
date_data$`Module #` <- as.numeric(date_data$`Module #`)
n1_original$`Module #` <- as.numeric(n1_original$`Module #`)

date_data <- date_data %>% filter(TimeStep %in% timestep, Side %in% side, `Module #` %in% modules)
# filter census date database

n1_original <- n1_original %>% filter(TimeStep %in% timestep)



n1_original <- left_join(date_data, n1_original, by = c("Date", "Module #", "Site_long", "Shelter", "Side", "TimeStep"))
  
  
### Recruitment by combining sectors (N & S)

n2_original <- n1_original %>% ungroup()  %>% 
  complete(nesting(`Module #`), Side, TimeStep, fill = list(larval_output = 0, recruits = 0, Settlement_Area = 1)) %>% 
  drop_na(Side, `Module #`) %>%  
  mutate(`Taxonomic Code` = species_label)


n2_original <- n2_original %>%

  group_by(`Module #`, TimeStep, Side) %>% 
  mutate(recruits = sum(recruits),
         larvae = larval_output) %>%
  slice(n())

n3_original <- data_final %>% arrange((Date)) %>% 
  group_by(`Module #`, TimeStep, Side) %>% 
  filter(`Max Diameter (mm)` > repro_min) %>% 
  tally() 


n3_original$`Module #` <- as.numeric(n3_original$`Module #`)

n2_original <- left_join(n2_original, n3_original)

n2_original <- n2_original %>% rename("Reproductive" = n)


# Total coral colony calculation 
n5_original <- data_final %>% filter(TimeStep %in% timestep) %>% 
  mutate(Reproductive = ifelse(`Max Diameter (mm)` >= repro_min, "Yes", "No")) %>% 
  group_by(`Taxonomic Code`, Date, Year, Site_long, Shelter, `Module #`, TimeStep, Side, Sector) %>% 
  tally() %>% 
  filter(Side %in% side,
         `Taxonomic Code` %in% species) 


n5_original <- n5_original %>% group_by(Year, Site_long, Shelter, `Module #`, TimeStep, Side) %>% 
  summarize(Date = mean(Date),
            coral_count = sum(n)) %>% 
  filter(!is.na(Date))

n5_original <- n5_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1))

# make Module # a factor column #
n5_original$`Module #` <- as.numeric(n5_original$`Module #`)

n6_original <- left_join(n2_original, n5_original)

n6_original <- n6_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1, Reproductive = 0))


n7_original <- n6_original %>%
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
group_by(TimeStep, `Module #`) %>%
  fill(Date, Year, .direction = "updown") %>% 
    mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))



#### Module Scale Database for Recruitment
date_data_new <- date_data %>% group_by(`Module #`, Site_long, Shelter, TimeStep, Year) %>% 
  summarize(Date_new = mean(Date))

module_data$`Module #` <- as.numeric(module_data$`Module #`)
n7_original$`Module #` <- as.numeric(n7_original$`Module #`)

n7_original <- left_join(n7_original, module_data, by = c("Site_long", "Shelter", "Module #", "Side", "TimeStep"))


n7_original$Settlement_Area <- n7_original$Settlement_Area.y
n7_original$Year <- n7_original$Year.x


n7_original <- n7_original %>% group_by(`Module #`, TimeStep, `Taxonomic Code`, Site_long, Shelter, Year, Season) %>% 
  summarize(recruits = sum(recruits),
    Settlement_Area = sum(Settlement_Area)) %>% 
  mutate(recruits_per_meter_squared = recruits/Settlement_Area)


n7_original <- left_join(n7_original, date_data_new, by = c("Module #", "Site_long", "Shelter", "TimeStep", "Year"))
n7_original$Date <- n7_original$Date_new

```

```{r MO 1-5 Recruitment Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


# Side combined database
n7_original <-  n7_original %>% mutate(recruits_per_meter_squared_trans = log(recruits_per_meter_squared + 1))

plotNormalHistogram(n7_original$recruits_per_meter_squared, main = "Recruitment original")
# recruitment distributions

plotNormalHistogram(n7_original$recruits_per_meter_squared_trans, main = "Recruitment Trans Original")

```

```{r MO 1-5 Recruitment Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#################### lmer original
# all corals with sides combined
# with interaction
module_recruitment <- as.numeric(n7_original$`Module #`)
n7_original$Site_long <- as.factor(n7_original$Site_long)
# factorize variables

n7_original$Season <- as.factor(n7_original$Season)
n7_original$Season <-  factor(n7_original$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE) 
season <- n7_original$Season
n7_original$Shelter <- factor(n7_original$Shelter, levels = c("Low", "High"), ordered = TRUE)
n7_original$Site_long <- factor(n7_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

MO_recruitment_lmer_original <- lmer(recruits_per_meter_squared_trans ~ Site_long*Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(MO_recruitment_lmer_original)
# model summary

recruitment_lmer_no_interaction_original <- lmer(recruits_per_meter_squared_trans ~ Site_long + Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(recruitment_lmer_no_interaction_original)
# model summary
```


```{r MO 1-5 Recruitment Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Recruitment
png("outputs/MO recruitment trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_recruitment_lmer_original), main = "MO recruitment trans Residuals")
qqline(resid(MO_recruitment_lmer_original))
dev.off()

qqnorm(resid(MO_recruitment_lmer_original), main = "MO recruitment trans Residuals")
qqline(resid(MO_recruitment_lmer_original))
MO_recruitment_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(MO_recruitment_lmer_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(MO_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(MO_recruitment_lmer_original), main = "MO recruitment trans")
# effects plots


## Recruitment
qqnorm(resid(recruitment_lmer_no_interaction_original, main = "Recruitment Residual Plot Original"))
qqline(resid(recruitment_lmer_no_interaction_original))
# qqplots

r.squaredGLMM(recruitment_lmer_no_interaction_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(recruitment_lmer_no_interaction_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(recruitment_lmer_no_interaction_original), main = "Recruitment Original")
# effects plots
```

```{r MO 1-5 Recruitment Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############## Recruitment barplot summary database and figures ##############
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))
#standard error function for error bars

plot_data_Site1 <- n7_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_recruit = mean(recruits_per_meter_squared),
            sample_size = n())
# mean urchin biomass for each module over entire study
  
plot_data_Site1 <- plot_data_Site1 %>% 
  group_by(Site_long, Shelter) %>% 
  summarise(mean = mean(mean_recruit),
            sd = std.dev.pop(mean_recruit),
            lower = mean(mean_recruit) - std.error.pop(mean_recruit),
            upper = mean(mean_recruit) + std.error.pop(mean_recruit),
            sample_size = n())
# mean urchin biomass for each treatment (n = 3)

plot_data_Site1 <- plot_data_Site1[c(3, 4, 1, 2),]
plot_data_Site1$Shelter <- factor(plot_data_Site1$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


###### Assign name for summary database from input section at top of script
assign(Rec, plot_data_Site1)


myplotfunc_recruitment <- function(x,y,z)
{
    data <- x
    
    mult_compare_recruitment <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))
    return(plot)
}

recruitment_plot_3 <- myplotfunc_recruitment(plot_data_Site1, mult_compare_recruitment, position)


## Barplot with labels
recruitment_plot_4 <- ggplot(data = plot_data_Site1, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


############## Recruitment time series summary database and figures ##############
## Recruitment Time Series Plots
plot_data_recruitment <- n7_original %>%
  group_by(Year, Site_long, Shelter, TimeStep) %>% 
  summarise(mean = mean(recruits_per_meter_squared),
            sd = std.dev.pop(recruits_per_meter_squared),
            lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared),
            Date = mean(Date))
# time series summary database


plot_data_recruitment$Shelter <- factor(plot_data_recruitment$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_recruitment$Site_long <- factor(plot_data_recruitment$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


## combined figure with legend ##
recruitment_time_series_plot_3 <- ggplot(data = plot_data_recruitment, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months",  date_labels = "%b") +
  theme_classic(base_size = 14.5) +
  coord_cartesian(ylim = c(0, 15)) +
  labs(x = "Date", y = expression(paste("Coral recruitment per m"^"2"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), legend.text = element_text(size = rel(1)), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5), legend.position = "none", legend.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.title.y = element_text(size = 18), axis.text = element_text(size = 16))


MO_recruitment_time_series_plot_3 <- recruitment_time_series_plot_3
```


```{r MO 1-5 Recruitment vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

urchin_vs_recruitment_data <- left_join(n7_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

### Analyses ###

# Analysis
module_urchin_recruit <- urchin_vs_recruitment_data$`Module #`

urchin_vs_MO_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_recruit) + (1|Year/Season), data = urchin_vs_recruitment_data, na.action = "na.fail")
summary(urchin_vs_MO_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/MO recruitment vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_recruitment_lmer), main = "Urchin vs. MO recruitment Residual Plot Original")
qqline(resid(urchin_vs_MO_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_recruitment_lmer)
#r-squared

emm_MO_recruit_lmer_1_original <- emmeans(urchin_vs_MO_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_MO_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_recruitment_lmer), main = "Urchin vs. MO recruitment Original")
# effects plots


### Scatterplot summary database and figures ###

# Urchin vs cover code without timesteps (12 points, 1 for each module)
urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_recruitment_mod_lmer_plot <- ggplot(data = urchin_vs_recruitment_data_mod, aes(x = mean_urchin, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO recruitment vs. urchin biomass final.png", plot = urchin_vs_MO_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 1-5 Recruitment vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Recruitment vs Herbivorous Fish Biomass ###
# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

fish_vs_recruitment_data <- left_join(n7_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_recruitment_data <- fish_vs_recruitment_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_recruit <- fish_vs_recruitment_data$`Module #`

fish_vs_MO_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ total_biomass + Site_long*Shelter + (1|module_fish_recruit) + (1|Year/Season), data = fish_vs_recruitment_data, na.action = "na.fail")
summary(fish_vs_MO_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/MO recruitment vs herbivorous fish biomass fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_recruitment_lmer), main = "Herbivorous fish vs. MO recruitment Residual Plot Original")
qqline(resid(fish_vs_MO_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_recruitment_lmer)
#r-squared

emm_MO_recruit_lmer_1_original <- emmeans(fish_vs_MO_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_MO_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_recruitment_lmer), main = "Herbivorous fish vs. MO recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs cover code without timesteps (12 points, 1 for each module)
fish_vs_recruitment_data_mod <- fish_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

fish_vs_recruitment_data_mod <- fish_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_recruitment_mod_lmer_plot <- ggplot(data = fish_vs_recruitment_data_mod, aes(x = mean_fish, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
 # geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO recruitment vs. herbivorous fish biomass final.png", plot = fish_vs_MO_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Recruitment vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs recruitment ###
# Database
n7_original$TimeStep <- as.factor(n7_original$TimeStep)
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)

algae_vs_recruitment_data <- left_join(n7_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_recruitment_data <- algae_vs_recruitment_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2

### Analyses ###

# Analysis
module_algae_recruit <- algae_vs_recruitment_data$`Module #`

algae_vs_MO_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ mean_cover_code + Site_long*Shelter + (1|module_algae_recruit) + (1|Year/Season), data = algae_vs_recruitment_data, na.action = "na.fail")
summary(algae_vs_MO_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/MO recruitment vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_recruitment_lmer), main = "Algal overgrowth vs. MO recruitment Residual Plot Original")
qqline(resid(algae_vs_MO_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_recruitment_lmer)
#r-squared

emm_MO_recruit_lmer_1_original <- emmeans(algae_vs_MO_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_MO_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_recruitment_lmer), main = "Algal overgrowth vs. MO recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs cover code without timesteps (12 points, 1 for each module)
algae_vs_recruitment_data_mod <- algae_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

algae_vs_recruitment_data_mod <- algae_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_recruitment_mod_lmer_plot <- ggplot(data = algae_vs_recruitment_data_mod, aes(x = mean_algae, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO recruitment vs. benthic algal overgrowth final.png", plot = algae_vs_MO_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 1-5 Recruiment vs Herbivore Biomass and Benthic Algal Code, echo = FALSE, message=FALSE, warning=FALSE, results='hide', fig.show='hide'}

### Database ###

### Urchin, herbivorous fish, and algae vs. recruitment
# Database
urchin_fish_vs_recruitment_data <- left_join(urchin_vs_recruitment_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_recruitment_data <- urchin_fish_vs_recruitment_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_recruitment_data$TimeStep <- as.factor(urchin_fish_vs_recruitment_data$TimeStep)

urchin_fish_algae_recruitment_data <- left_join(urchin_fish_vs_recruitment_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_recruitment_data <- urchin_fish_algae_recruitment_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

module_urchin_fish_algae_recruit <- urchin_fish_algae_recruitment_data$`Module #`

urchin_fish_algae_vs_MO_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_recruit) + (1|Year/Season), data = urchin_fish_algae_recruitment_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/MO recruitment trans vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_recruitment_lmer), main = "U, F, & AO vs. MO recruitment Residuals")
qqline(resid(urchin_fish_algae_vs_MO_recruitment_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_recruitment_lmer), main = "U, F, & AO vs. MO recruitment trans Residuals")
qqline(resid(urchin_fish_algae_vs_MO_recruitment_lmer))
urchin_fish_algae_vs_MO_recruitment_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_recruitment_lmer), main = "U, F, & AO vs. MO recruitment")
# effects plots

```




```{r MO 1-5 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  
 

  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.




survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures



survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r MO 1-5 Survival Data Tranformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions
plotNormalHistogram(survival_results_long_2_original$survival_trans)
```
 

```{r MO 1-5 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots
MO_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(MO_1_5_survival_glmmTMB)



MO_1_5_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(MO_1_5_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r MO 1-5 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/MO 1-5 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_1_5_survival_lmer_original), main = "MO 1-5 survival Residuals")
qqline(resid(MO_1_5_survival_lmer_original))
dev.off()

qqnorm(resid(MO_1_5_survival_lmer_original), main = "MO 1-5 survival Residuals")
qqline(resid(MO_1_5_survival_lmer_original))
MO_1_5_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(MO_1_5_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(MO_1_5_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(MO_1_5_survival_lmer_original), main = "MO 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(MO_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(MO_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_1_5_survival_glmmTMB, plot = T)
MO_1_5_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 1-5 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(MO_1_5_survival_glmmTMB), main = "MO 1-5 survival glmmTMB Residuals")
qqline(resid(MO_1_5_survival_glmmTMB))
MO_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 1-5 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_1_5_survival_glmmTMB), main = "MO 1-5 Survival")
qqline(resid(MO_1_5_survival_glmmTMB))
dev.off()
```


```{r MO 1-5 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

################ Survival barplot summary database and figures ################# 

## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))


plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)



#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)



## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


############### Survival time series summary database and figures ###############

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r MO 1-5 Survival vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_MO_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_MO_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 1-5 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_1_5_survival_lmer), main = "Urchins vs. MO 1-5 Survival Residual Plot Original")
qqline(resid(urchin_vs_MO_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_1_5_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(urchin_vs_MO_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_1_5_survival_lmer), main = "Urchins vs MO 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_1_5_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 survival vs urchin biomass final.png", plot = urchin_vs_MO_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Survival vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_MO_1_5_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_MO_1_5_survival_lmer)



### Model assessments ###

## Survival
png("outputs/MO 1-5 survival trans vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_1_5_survival_lmer), main = "Herbivorous fish vs. MO 1-5 Survival Residual Plot Original")
qqline(resid(fish_vs_MO_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_1_5_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(fish_vs_MO_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_1_5_survival_lmer), main = "Herbivorous fish vs MO 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_1_5_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 survival vs herbivorous fish biomass final.png", plot = fish_vs_MO_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Survival vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_MO_1_5_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_MO_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 1-5 survival algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_1_5_survival_lmer),main = "Algal overgrowth vs MO 1-5 Survival Residual Plot Original")
qqline(resid(algae_vs_MO_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_1_5_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_MO_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_1_5_survival_lmer), main = "Algal overgrowth vs MO 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_1_5_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 survival vs benthic algal overgrowth final.png", plot = algae_vs_MO_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_MO_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_1_5_survival_lmer)


# DHARMa simulated model
urchin_fish_algae_vs_MO_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)



### Model assessments ###

## Survival
png("outputs/MO 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_survival_lmer), main = "U,F,& AO vs. MO 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_1_5_survival_lmer), main = "U,F,& AO vs. MO 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_survival_lmer))
urchin_fish_algae_vs_MO_1_5_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_1_5_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_1_5_survival_lmer), main = "U,F,& AO vs. MO 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_1_5_survival_glmmTMB, plot = T)
MO_1_5_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 1-5 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB), main = "U,F,& AO vs. MO 1-5 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB))
urchin_fish_algae_vs_MO_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB), main = "MO 1-5 Survival")
qqline(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB))
dev.off()

```


```{r MO 1-5 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


#### Filtering Databases for Parametric Tests and Transition Matrices 
### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



############# Function for growth calculations ############# 
###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



########### Growth database for analyses with or without benthic algal code data ########

####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```

```{r MO 1-5 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```

```{r MO 1-5 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


MO_1_5_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_1_5_growth_mixed_effects_original)

r.squaredGLMM(MO_1_5_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

MO_1_5_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_1_5_growth_mixed_effects_original_trans)
# transformed model
```


```{r MO 1-5 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/MO 1-5 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_1_5_growth_mixed_effects_original), main = "MO 1-5 Growth")
qqline(resid(MO_1_5_growth_mixed_effects_original))
dev.off()

qqnorm(resid(MO_1_5_growth_mixed_effects_original), main = "MO 1-5 Growth")
qqline(resid(MO_1_5_growth_mixed_effects_original))
MO_1_5_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_1_5_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(MO_1_5_growth_mixed_effects_original), main = "MO 1-5 growth")
# interaction plots

emm_original <- emmeans(MO_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


## lmer
# all corals cube root transformed growth
png("outputs/MO 1-5 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_1_5_growth_mixed_effects_original_trans), main = "MO 1-5 Growth")
qqline(resid(MO_1_5_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(MO_1_5_growth_mixed_effects_original_trans), main = "MO 1-5 Growth trans")
qqline(resid(MO_1_5_growth_mixed_effects_original_trans))
MO_1_5_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_1_5_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(MO_1_5_growth_mixed_effects_original_trans), main = "MO 1-5 growth")
# interaction plots

emm_original <- emmeans(MO_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```

```{r MO 1-5 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############### Growth barplot summary database and figures ################

## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)



## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


############# Growth time series summary database and figures ############# 
### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r MO 1-5 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_MO_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_MO_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/MO 1-5 growth vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_1_5_growth_lmer, main = "Urchins vs. MO 1-5 Growth Residual Plot Original"))
qqline(resid(urchin_vs_MO_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_MO_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_1_5_growth_lmer), main = "Urchins vs MO 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_1_5_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 growth vs. urchins final.png", plot = urchin_vs_MO_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 1-5 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_MO_1_5_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_MO_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/MO 1-5 growth vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_1_5_growth_lmer, main = "Fish vs. MO 1-5 Growth Residual Plot Original"))
qqline(resid(fish_vs_MO_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_MO_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_1_5_growth_lmer), main = "Fish vs. MO 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_1_5_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 growth vs. herbivorous fish final.png", plot = fish_vs_MO_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_MO_1_5_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_MO_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/MO 1-5 growth vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_1_5_growth_lmer, main = "Algae vs. MO 1-5 Growth Residual Plot Original"))
qqline(resid(algae_vs_MO_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_MO_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_1_5_growth_lmer), main = "Algae vs. MO 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_1_5_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 1-5 growth vs. algal overgrowth final.png", plot = algae_vs_MO_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r MO 1-5 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_MO_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_1_5_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_MO_1_5_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/MO 1-5 growth trans vs. urchin, herbivorous fish, and algal overgrowth fit.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans), main = "MO 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans), main = "U,F,& AO vs. MO 1-5 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans))
urchin_fish_algae_vs_MO_1_5_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_1_5_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans), main = "U,F,& AO vs. MO 1-5 growth trans")
# effects plots


## Growth
png("outputs/MO 1-5 growth vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer), main = "MO 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer), main = "U,F,& AO vs. MO 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer))
urchin_fish_algae_vs_MO_1_5_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_1_5_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_1_5_growth_lmer), main = "U,F,& AO vs. MO 1-5 growth")
# effects plots

```


```{r MO 1-5 Requested Committee Meeting Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

n7_original_new <- n7_original %>% group_by(TimeStep, Season, Site_long, Shelter) %>% 
  summarise(Date_new = mean(Date),
            recruit = sum(recruits)) 

n7_original_new2 <- n7_original_new %>% group_by(Site_long, Shelter) %>%
  arrange(TimeStep) %>% 
  mutate(cum_sum_recruits = cumsum(recruit))

n7_original_new2$Shelter <- factor(n7_original_new2$Shelter, levels = c("Low", "High"), ordered = TRUE)


ggplot(data = n7_original_new2, aes(x = Date_new, y = cum_sum_recruits, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = "Date", y = "Cumulative # of Recruits") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = c(.2, .8), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))



############# Algal Cover vs 1-20 mm Total Colony Area #############
data_final_new <- data_final %>% filter(`Max Diameter (mm)` <= 20)

data_final_new <- data_final_new %>% group_by(TimeStep, Site_long, Shelter, `Module #`) %>% 
  summarize(total_area = sum(area_cm_squared))


data_final_new$TimeStep <- as.factor(data_final_new$TimeStep)
data_final_new$`Module #` <- as.factor(data_final_new$`Module #`)

colony_area_and_cover_code_data <- left_join(data_final_new, cover_code_data)

colony_area_and_cover_code_data <- colony_area_and_cover_code_data %>% drop_na(mean_cover_code)


# Variables
module_colony_area_vs_cover_code <- colony_area_and_cover_code_data$`Module #`


col_area_vs_cover_data_mod <- colony_area_and_cover_code_data %>% group_by(`Module #`) %>% 
  summarize(tot_area = mean(total_area),
            area_sd = std.dev.pop(total_area),
            area_lower = mean(total_area) - std.error.pop(total_area),
            area_upper = mean(total_area) + std.error.pop(total_area),
            mean_cover_code_new = mean(mean_cover_code),
            cover_sd = std.dev.pop(mean_cover_code),
            cover_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            cover_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code))

col_area_vs_cover_data_mod <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

col_area_vs_cover_data_mod_no_211 <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low")) %>%
  filter(`Module #` != 211)

col_area_vs_cover_code_mod_lm <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm)

col_area_vs_cover_code_mod_lm_no_211 <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod_no_211, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm_no_211)

### coral lmer full model
col_area_vs_cover_code_lmer <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer)

### coral lmer with significant predictors and algal overgrowth
col_area_vs_cover_code_lmer_sig <- lmer(total_area ~ mean_cover_code + Site_long + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_sig)

### coral lmer with algal overgrowth only
col_area_vs_cover_code_lmer_only <- lmer(total_area ~ mean_cover_code + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only)

### coral lmer with algal overgrowth only P/A
colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data %>% mutate(algae_P_A = ifelse(mean_cover_code == 1, 0, 1))
module_colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data_lmer_only_P_A$`Module #`

col_area_vs_cover_code_lmer_only_P_A <- lmer(total_area ~ algae_P_A + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_P_A) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_P_A, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_P_A)

### coral lmer with algal overgrowth only >0
colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_P_A %>% filter(algae_P_A == 1)
module_colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_above_1$`Module #`

col_area_vs_cover_code_lmer_only_above_1 <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_above_1) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_above_1, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_above_1)


# Plot lmer with SE 
col_area_vs_cover_code_mod_lmer_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with SE
col_area_vs_cover_code_mod_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with raw data 
col_area_vs_cover_code_plot <- ggplot(data = colony_area_and_cover_code_data, aes(x = mean_cover_code, y = total_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  #coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))
```


## Recruitment Time Series
```{r, echo = TRUE, message=FALSE, warning=FALSE}
recruitment_time_series_plot_3

ggsave("MO recruitment time series plot final.png", plot = recruitment_time_series_plot_3, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)
```


## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral recruitment, survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more herbivores and less algae)
summary(urchin_fish_algae_vs_MO_recruitment_lmer)
# model summary


urchin_fish_algae_vs_MO_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_recruitment_lmer), main = "U, F, & AO vs. MO recruitment")
# effects plots

```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)

## qqplots
qqnorm(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB), main = "U,F,& AO vs. MO 1-5 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB))
urchin_fish_algae_vs_MO_1_5_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. MO 1-5 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB), main = "U,F,& AO vs. MO 1-5 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_MO_1_5_survival_lmer)

#urchin_fish_algae_vs_MO_1_5_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_1_5_survival_lmer), main = "U,F,& AO vs. MO 1-5 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_MO_1_5_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer), main = "U,F,& AO vs. MO 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_1_5_growth_lmer))

urchin_fish_algae_vs_MO_1_5_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_1_5_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_1_5_growth_lmer), main = "U,F,& AO vs. MO 1-5 growth")
# effects plots
```

```{r MO Benthic Algal Overgrowth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

# lmer full model analysis
summary(urchin_vs_cover_data_lmer)
r.squaredGLMM(urchin_vs_cover_data_lmer)
effect(urchin_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(urchin_vs_cover_data_lmer_sig)
#r.squaredGLMM(urchin_vs_cover_data_lmer_sig)

# lmer with P/A for urchin biomass
#summary(urchin_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_P_A)

# lmer with >0 urchin biomass
#summary(urchin_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_above_0)

#urchin_vs_cover_code_mod_plot_no_trend
# Figure without trendline
#urchin_vs_cover_code_mod_plot
# figure with trendline
#urchin_vs_cover_code_plot_no_trend
# raw data figure without trendline
urchin_vs_cover_code_plot
# raw data figure with trendline
urchin_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(urchin_vs_cover_code_mod_lm)
```


```{r MO Benthic Algal Overgrowth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Herbivorous Fish vs Algal Cover Code (Less algae with more fish)
# lmer analysis only
summary(fish_vs_cover_data_lmer_only)

r.squaredGLMM(fish_vs_cover_data_lmer_only)

# lmer full model analysis
summary(fish_vs_cover_data_lmer)
r.squaredGLMM(fish_vs_cover_data_lmer)
effect(fish_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(fish_vs_cover_data_lmer_sig)
#r.squaredGLMM(fish_vs_cover_data_lmer_sig)

# lmer with P/A for fish biomass
#summary(fish_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_P_A)

# lmer with >0 fish biomass
#summary(fish_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_above_0)

fish_vs_cover_code_mod_plot_no_trend
# figure without trendline since it is an marginal result
#fish_vs_cover_code_mod_plot
# trendline added
fish_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(fish_vs_cover_code_mod_lm)
```

```{r MO Juvenile Coral Cover vs. Benthic Algal Overgrowth, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Algal Cover Code vs. Total Colony Area (Less coral with more algae)
# lmer model
summary(col_area_vs_cover_code_lmer_only)

r.squaredGLMM(col_area_vs_cover_code_lmer_only)

# lmer full model
summary(col_area_vs_cover_code_lmer)
r.squaredGLMM(col_area_vs_cover_code_lmer)
effect(col_area_vs_cover_code_lmer)

# lmer dropped non-significant variables
#summary(col_area_vs_cover_code_lmer_sig)
#r.squaredGLMM(col_area_vs_cover_code_lmer_sig)

# lmer with P/A for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_P_A)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_P_A)

# lmer with >1 for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_above_1)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_above_1)

#col_area_vs_cover_code_mod_plot
# figure with trendline
col_area_vs_cover_code_plot
# raw data figure with trendline
#effect(col_area_vs_cover_code_lmer_only)
# effects plot for raw lmer
col_area_vs_cover_code_mod_lmer_plot
# lmer plot with model trendline

# lm model 
summary(col_area_vs_cover_code_mod_lm)

```

```{r MO Herbivore Hypothesis Saved Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Urchins
ggsave("Algal overgrowth vs urchins final.png", plot = urchin_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final with trend.png", plot = urchin_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data without trend.png", plot = urchin_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data.png", plot = urchin_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Herbivorous fish
ggsave("Algal overgrowth vs herbivorous fish final.png", plot = fish_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final with trend.png", plot = fish_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data without trend.png", plot = fish_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data.png", plot = fish_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Coral cover vs. benthic algal code
ggsave("MO coral cover vs algal overgrowth.png", plot = col_area_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("MO coral cover vs algal overgrowth raw data.png", plot = col_area_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more shelter)
summary(MO_recruitment_lmer_original)
# model summary

MO_recruitment_trans_fit
# fit

r.squaredGLMM(MO_recruitment_lmer_original)
# r^2

# pairwise multiple comparisons
mc_recruitment <- emmeans(MO_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment)
# pairwise multiple comparisons simple
mc_recruitment <- emmeans(MO_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment, simple = "each")


recruitment_plot_4

## Recruitment without interaction (More coral recruitment with more shelter)
#summary(recruitment_lmer_no_interaction_original)
#r.squaredGLMM(recruitment_lmer_no_interaction_original)
```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Survival transformed (Greater coral survival with more shelter)
summary(MO_1_5_survival_glmmTMB)

qqnorm(resid(MO_1_5_survival_glmmTMB), main = "MO 1-5 survival glmmTMB Residuals")
qqline(resid(MO_1_5_survival_glmmTMB))
MO_1_5_survival_fit_glmmTMB
#fit

DHARMa::testDispersion(MO_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "MO 1-5 survival glmmTMB")



r.squaredGLMM(MO_1_5_survival_glmmTMB)
performance::r2_nakagawa(MO_1_5_survival_glmmTMB)
# r^2

# pairwise multiple comparisons
mc_survival <- emmeans(MO_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(MO_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")



## Survival (Greater coral survival with more shelter)
#summary(MO_1_5_survival_lmer_original)


#MO_1_5_survival_fit
#fit

#r.squaredGLMM(MO_1_5_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(MO_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons
#mc_survival <- emmeans(MO_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(MO_1_5_growth_mixed_effects_original_trans)


#qqnorm(resid(MO_1_5_growth_mixed_effects_original_trans), main = "MO 1-5 Growth trans")
#qqline(resid(MO_1_5_growth_mixed_effects_original_trans))
#MO_1_5_growth_fit_trans
# fit

#r.squaredGLMM(MO_1_5_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(MO_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(MO_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(MO_1_5_growth_mixed_effects_original)


MO_1_5_growth_fit
# fit

r.squaredGLMM(MO_1_5_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(MO_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(MO_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


# MO 6-10 mm
```{r MO 6-10 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###



###### Summary Plot Databases
Sur <- "MO_S_6_10"
Grow <- "MO_G_6_10" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r MO 6-10 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 6
max <- 10
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 2


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("MO", "MPA")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("MO")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r MO 6-10 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r MO 6-10 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r MO 6-10 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r MO 6-10 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r MO 6-10 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r MO 6-10 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

MO_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(MO_6_10_survival_glmmTMB)

r.squaredGLMM(MO_6_10_survival_glmmTMB)
performance::r2_nakagawa(MO_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(MO_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_6_10_survival_glmmTMB, plot = T)
MO_6_10_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 6-10 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(MO_6_10_survival_glmmTMB), main = "MO 6-10 survival glmmTMB Residuals")
qqline(resid(MO_6_10_survival_glmmTMB))
MO_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 6-10 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_6_10_survival_glmmTMB), main = "MO 6-10 Survival")
qqline(resid(MO_6_10_survival_glmmTMB))
dev.off()



MO_6_10_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(MO_6_10_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r MO 6-10 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/MO 6-10 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_6_10_survival_lmer_original), main = "MO 6-10 survival Residuals")
qqline(resid(MO_6_10_survival_lmer_original))
dev.off()

qqnorm(resid(MO_6_10_survival_lmer_original), main = "MO 6-10 survival Residuals")
qqline(resid(MO_6_10_survival_lmer_original))
MO_6_10_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(MO_6_10_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(MO_6_10_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(MO_6_10_survival_lmer_original), main = "MO 6-10 survival")
# effects plots
```


```{r MO 6-10 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r MO 6-10 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_MO_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_MO_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 6-10 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_6_10_survival_lmer), main = "Urchins vs. MO 6-10 Survival Residual Plot Original")
qqline(resid(urchin_vs_MO_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_6_10_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(urchin_vs_MO_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_6_10_survival_lmer), main = "Urchins vs MO 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_6_10_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 6-10 survival vs. urchins final.png", plot = urchin_vs_MO_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_MO_6_10_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_MO_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 6-10 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_6_10_survival_lmer), main = "Herbivorous fish vs. MO 6-10 Survival Residual Plot Original")
qqline(resid(fish_vs_MO_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_6_10_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(fish_vs_MO_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_6_10_survival_lmer), main = "Herbivorous fish vs MO 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_6_10_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 6-10 survival vs. herbivorous fish final.png", plot = fish_vs_MO_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_MO_6_10_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_MO_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 6-10 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_6_10_survival_lmer),main = "Algal overgrowth vs MO 6-10 Survival Residual Plot Original")
qqline(resid(algae_vs_MO_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_6_10_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_MO_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_6_10_survival_lmer), main = "Algal overgrowth vs MO 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_6_10_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 6-10 survival vs. algal overgrowth final.png", plot = algae_vs_MO_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_MO_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_6_10_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_MO_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_6_10_survival_glmmTMB, plot = T)
MO_6_10_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 6-10 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB), main = "U,F,& AO vs. MO 6-10 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB))
urchin_fish_algae_vs_MO_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 6-10 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB), main = "MO 6-10 Survival")
qqline(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB))
dev.off()


## Survival
png("outputs/MO 6-10 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_survival_lmer), main = "U,F,& AO vs. MO 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_6_10_survival_lmer), main = "U,F,& AO vs. MO 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_survival_lmer))
urchin_fish_algae_vs_MO_6_10_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_6_10_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_6_10_survival_lmer), main = "U,F,& AO vs. MO 6-10 survival")
# effects plots

```


```{r MO 6-10 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r MO 6-10 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r MO 6-10 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


MO_6_10_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_6_10_growth_mixed_effects_original)

r.squaredGLMM(MO_6_10_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

MO_6_10_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_6_10_growth_mixed_effects_original_trans)
# transformed model
```


```{r MO 6-10 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/MO 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_6_10_growth_mixed_effects_original), main = "MO 6-10 Growth")
qqline(resid(MO_6_10_growth_mixed_effects_original))
dev.off()

qqnorm(resid(MO_6_10_growth_mixed_effects_original), main = "MO 6-10 Growth")
qqline(resid(MO_6_10_growth_mixed_effects_original))
MO_6_10_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_6_10_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(MO_6_10_growth_mixed_effects_original), main = "MO 6-10 growth")
# interaction plots

emm_original <- emmeans(MO_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/MO 6-10 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_6_10_growth_mixed_effects_original_trans), main = "MO 6-10 Growth")
qqline(resid(MO_6_10_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(MO_6_10_growth_mixed_effects_original_trans), main = "MO 6-10 Growth trans")
qqline(resid(MO_6_10_growth_mixed_effects_original_trans))
MO_6_10_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_6_10_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(MO_6_10_growth_mixed_effects_original_trans), main = "MO 6-10 growth")
# interaction plots

emm_original <- emmeans(MO_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r MO 6-10 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)



## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r MO 6-10 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_MO_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_MO_6_10_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. MO 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_6_10_growth_lmer, main = "Urchins vs. MO 6-10 Growth Residual Plot Original"))
qqline(resid(urchin_vs_MO_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_MO_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_6_10_growth_lmer), main = "Urchins vs MO 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_6_10_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs MO 6-10 growth final.png", plot = urchin_vs_MO_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_MO_6_10_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_MO_6_10_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. MO 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_6_10_growth_lmer, main = "Fish vs. MO 6-10 Growth Residual Plot Original"))
qqline(resid(fish_vs_MO_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_MO_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_6_10_growth_lmer), main = "Fish vs. MO 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_6_10_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs MO 6-10 growth final.png", plot = fish_vs_MO_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_MO_6_10_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_MO_6_10_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. MO 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_6_10_growth_lmer, main = "Algae vs. MO 6-10 Growth Residual Plot Original"))
qqline(resid(algae_vs_MO_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_MO_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_6_10_growth_lmer), main = "Algae vs. MO 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_6_10_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs MO 6-10 growth final.png", plot = algae_vs_MO_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 6-10 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_MO_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_6_10_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_MO_6_10_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 6-10 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans), main = "MO 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans), main = "U,F,& AO vs. MO 6-10 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans))
urchin_fish_algae_vs_MO_6_10_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_6_10_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_6_10_growth_lmer_trans), main = "U,F,& AO vs. MO 6-10 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer), main = "MO 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer))
urchin_fish_algae_vs_MO_6_10_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_6_10_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)

## qqplots
qqnorm(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB), main = "U,F,& AO vs. MO 6-10 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB))
urchin_fish_algae_vs_MO_6_10_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. MO 6-10 glmmTMB survival")


r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_MO_6_10_survival_glmmTMB), main = "U,F,& AO vs. MO 6-10 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_MO_6_10_survival_lmer)

#urchin_fish_algae_vs_MO_6_10_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_6_10_survival_lmer), main = "U,F,& AO vs. MO 6-10 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_MO_6_10_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_6_10_growth_lmer))

urchin_fish_algae_vs_MO_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_6_10_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_6_10_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(MO_6_10_survival_glmmTMB)
# r^2


MO_6_10_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(MO_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "MO 6-10 survival glmmTMB")



r.squaredGLMM(MO_6_10_survival_glmmTMB)
performance::r2_nakagawa(MO_6_10_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(MO_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(MO_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(MO_6_10_survival_lmer_original)


#MO_6_10_survival_fit
# fit

#r.squaredGLMM(MO_6_10_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(MO_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(MO_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(MO_6_10_growth_mixed_effects_original_trans)


#qqnorm(resid(MO_6_10_growth_mixed_effects_original_trans), main = "MO 6-10 Growth trans")
#qqline(resid(MO_6_10_growth_mixed_effects_original_trans))
#MO_6_10_growth_fit_trans
# fit

#r.squaredGLMM(MO_6_10_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(MO_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(MO_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(MO_6_10_growth_mixed_effects_original)


MO_6_10_growth_fit
# fit

r.squaredGLMM(MO_6_10_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(MO_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(MO_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```

# MO 11-15 mm
```{r MO 11-15 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "MO_S_11_15"
Grow <- "MO_G_11_15" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r MO 11-15 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 11
max <- 15
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 3


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("MO", "MPA")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("MO")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r MO 11-15 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r MO 11-15 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r MO 11-15 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r MO 11-15 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r MO 11-15 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r MO 11-15 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

MO_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(MO_11_15_survival_glmmTMB)

r.squaredGLMM(MO_11_15_survival_glmmTMB)
performance::r2_nakagawa(MO_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(MO_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_11_15_survival_glmmTMB, plot = T)
MO_11_15_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 11-15 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 11-15 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(MO_11_15_survival_glmmTMB), main = "MO 11-15 survival glmmTMB Residuals")
qqline(resid(MO_11_15_survival_glmmTMB))
MO_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 11-15 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_11_15_survival_glmmTMB), main = "MO 11-15 Survival")
qqline(resid(MO_11_15_survival_glmmTMB))
dev.off()



MO_11_15_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(MO_11_15_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r MO 11-15 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/MO 11-15 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_11_15_survival_lmer_original), main = "MO 11-15 survival Residuals")
qqline(resid(MO_11_15_survival_lmer_original))
dev.off()

qqnorm(resid(MO_11_15_survival_lmer_original), main = "MO 11-15 survival Residuals")
qqline(resid(MO_11_15_survival_lmer_original))
MO_11_15_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(MO_11_15_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(MO_11_15_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(MO_11_15_survival_lmer_original), main = "MO 11-15 survival")
# effects plots
```


```{r MO 11-15 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r MO 11-15 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_MO_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_MO_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 11-15 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_11_15_survival_lmer), main = "Urchins vs. MO 11-15 Survival Residual Plot Original")
qqline(resid(urchin_vs_MO_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_11_15_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(urchin_vs_MO_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_11_15_survival_lmer), main = "Urchins vs MO 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_11_15_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 11-15 survival vs. urchins final.png", plot = urchin_vs_MO_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_MO_11_15_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_MO_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 11-15 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_11_15_survival_lmer), main = "Herbivorous fish vs. MO 11-15 Survival Residual Plot Original")
qqline(resid(fish_vs_MO_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_11_15_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(fish_vs_MO_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_11_15_survival_lmer), main = "Herbivorous fish vs MO 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_11_15_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 11-15 survival vs. herbivorous fish final.png", plot = fish_vs_MO_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_MO_11_15_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_MO_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 11-15 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_11_15_survival_lmer),main = "Algal overgrowth vs MO 11-15 Survival Residual Plot Original")
qqline(resid(algae_vs_MO_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_11_15_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_MO_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_11_15_survival_lmer), main = "Algal overgrowth vs MO 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_11_15_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 11-15 survival vs. algal overgrowth final.png", plot = algae_vs_MO_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_MO_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_11_15_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_MO_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_11_15_survival_glmmTMB, plot = T)
MO_11_15_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 11-15 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 11-15 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB), main = "U,F,& AO vs. MO 11-15 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB))
urchin_fish_algae_vs_MO_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 11-15 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB), main = "MO 11-15 Survival")
qqline(resid(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB))
dev.off()


## Survival
png("outputs/MO 11-15 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_11_15_survival_lmer), main = "U,F,& AO vs. MO 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_11_15_survival_lmer), main = "U,F,& AO vs. MO 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_survival_lmer))
urchin_fish_algae_vs_MO_11_15_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_11_15_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_11_15_survival_lmer), main = "U,F,& AO vs. MO 11-15 survival")
# effects plots

```


```{r MO 11-15 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r MO 11-15 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r MO 11-15 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


MO_11_15_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_11_15_growth_mixed_effects_original)

r.squaredGLMM(MO_11_15_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

MO_11_15_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_11_15_growth_mixed_effects_original_trans)
# transformed model
```


```{r MO 11-15 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/MO 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_11_15_growth_mixed_effects_original), main = "MO 11-15 Growth")
qqline(resid(MO_11_15_growth_mixed_effects_original))
dev.off()

qqnorm(resid(MO_11_15_growth_mixed_effects_original), main = "MO 11-15 Growth")
qqline(resid(MO_11_15_growth_mixed_effects_original))
MO_11_15_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_11_15_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(MO_11_15_growth_mixed_effects_original), main = "MO 11-15 growth")
# interaction plots

emm_original <- emmeans(MO_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/MO 11-15 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_11_15_growth_mixed_effects_original_trans), main = "MO 11-15 Growth")
qqline(resid(MO_11_15_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(MO_11_15_growth_mixed_effects_original_trans), main = "MO 11-15 Growth trans")
qqline(resid(MO_11_15_growth_mixed_effects_original_trans))
MO_11_15_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_11_15_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(MO_11_15_growth_mixed_effects_original_trans), main = "MO 11-15 growth")
# interaction plots

emm_original <- emmeans(MO_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r MO 11-15 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r MO 11-15 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_MO_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_MO_11_15_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. MO 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_11_15_growth_lmer, main = "Urchins vs. MO 11-15 Growth Residual Plot Original"))
qqline(resid(urchin_vs_MO_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_MO_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_11_15_growth_lmer), main = "Urchins vs MO 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_11_15_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs MO 11-15 growth final.png", plot = urchin_vs_MO_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_MO_11_15_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_MO_11_15_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. MO 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_11_15_growth_lmer, main = "Fish vs. MO 11-15 Growth Residual Plot Original"))
qqline(resid(fish_vs_MO_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_MO_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_11_15_growth_lmer), main = "Fish vs. MO 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_11_15_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs MO 11-15 growth final.png", plot = fish_vs_MO_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_MO_11_15_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_MO_11_15_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. MO 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_11_15_growth_lmer, main = "Algae vs. MO 11-15 Growth Residual Plot Original"))
qqline(resid(algae_vs_MO_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_MO_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_11_15_growth_lmer), main = "Algae vs. MO 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_11_15_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs MO 11-15 growth final.png", plot = algae_vs_MO_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 11-15 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_MO_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_11_15_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_MO_11_15_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 11-15 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans), main = "MO 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans), main = "U,F,& AO vs. MO 11-15 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans))
urchin_fish_algae_vs_MO_11_15_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_11_15_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_11_15_growth_lmer_trans), main = "U,F,& AO vs. MO 11-15 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer), main = "MO 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer), main = "U,F,& AO vs. MO 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer))
urchin_fish_algae_vs_MO_11_15_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_11_15_growth_lmer), main = "U,F,& AO vs. MO 11-15 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_MO_11_15_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. MO 11-15 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_MO_11_15_survival_glmmTMB), main = "U,F,& AO vs. MO 11-15 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_MO_11_15_survival_lmer)

#urchin_fish_algae_vs_MO_11_15_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_11_15_survival_lmer), main = "U,F,& AO vs. MO 11-15 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_MO_11_15_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer), main = "U,F,& AO vs. MO 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_11_15_growth_lmer))

urchin_fish_algae_vs_MO_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_11_15_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_11_15_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(MO_11_15_survival_glmmTMB)
# r^2

MO_11_15_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(MO_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "MO 11-15 survival glmmTMB")



r.squaredGLMM(MO_11_15_survival_glmmTMB)
performance::r2_nakagawa(MO_11_15_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(MO_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(MO_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(MO_11_15_survival_lmer_original)


#MO_11_15_survival_fit
# fit

#r.squaredGLMM(MO_11_15_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(MO_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(MO_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(MO_11_15_growth_mixed_effects_original_trans)


#qqnorm(resid(MO_11_15_growth_mixed_effects_original_trans), main = "MO 11-15 Growth trans")
#qqline(resid(MO_11_15_growth_mixed_effects_original_trans))
#MO_11_15_growth_fit_trans
# fit

#r.squaredGLMM(MO_11_15_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(MO_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(MO_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(MO_11_15_growth_mixed_effects_original)


MO_11_15_growth_fit
# fit

r.squaredGLMM(MO_11_15_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(MO_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(MO_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```

# MO 16-20 mm
```{r MO 16-20 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "MO_S_16_20"
Grow <- "MO_G_16_20" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r MO 16-20 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 16
max <- 20
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 4


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("MO", "MPA")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("MO")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r MO 16-20 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r MO 16-20 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r MO 16-20 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r MO 16-20 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r MO 16-20 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r MO 16-20 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

MO_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(MO_16_20_survival_glmmTMB)

r.squaredGLMM(MO_16_20_survival_glmmTMB)
performance::r2_nakagawa(MO_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(MO_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_16_20_survival_glmmTMB, plot = T)
MO_16_20_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 16-20 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 16-20 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(MO_16_20_survival_glmmTMB), main = "MO 16-20 survival glmmTMB Residuals")
qqline(resid(MO_16_20_survival_glmmTMB))
MO_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 16-20 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_16_20_survival_glmmTMB), main = "MO 16-20 Survival")
qqline(resid(MO_16_20_survival_glmmTMB))
dev.off()



MO_16_20_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(MO_16_20_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r MO 16-20 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/MO 16-20 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_16_20_survival_lmer_original), main = "MO 16-20 survival Residuals")
qqline(resid(MO_16_20_survival_lmer_original))
dev.off()

qqnorm(resid(MO_16_20_survival_lmer_original), main = "MO 16-20 survival Residuals")
qqline(resid(MO_16_20_survival_lmer_original))
MO_16_20_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(MO_16_20_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(MO_16_20_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(MO_16_20_survival_lmer_original), main = "MO 16-20 survival")
# effects plots
```


```{r MO 16-20 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r MO 16-20 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_MO_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_MO_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 16-20 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_16_20_survival_lmer), main = "Urchins vs. MO 16-20 Survival Residual Plot Original")
qqline(resid(urchin_vs_MO_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_16_20_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(urchin_vs_MO_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_16_20_survival_lmer), main = "Urchins vs MO 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_16_20_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 16-20 survival vs. urchins final.png", plot = urchin_vs_MO_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_MO_16_20_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_MO_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 16-20 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_16_20_survival_lmer), main = "Herbivorous fish vs. MO 16-20 Survival Residual Plot Original")
qqline(resid(fish_vs_MO_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_16_20_survival_lmer)
#r-squared

emm_MO_survival_lmer_1_original <- emmeans(fish_vs_MO_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_MO_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_16_20_survival_lmer), main = "Herbivorous fish vs MO 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_16_20_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 16-20 survival vs. herbivorous fish final.png", plot = fish_vs_MO_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_MO_16_20_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_MO_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/MO 16-20 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_16_20_survival_lmer),main = "Algal overgrowth vs MO 16-20 Survival Residual Plot Original")
qqline(resid(algae_vs_MO_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_16_20_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_MO_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_16_20_survival_lmer), main = "Algal overgrowth vs MO 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_16_20_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("MO 16-20 survival vs. algal overgrowth final.png", plot = algae_vs_MO_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_MO_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_16_20_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_MO_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_16_20_survival_glmmTMB, plot = T)
MO_16_20_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/MO 16-20 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "MO 16-20 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB), main = "U,F,& AO vs. MO 16-20 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB))
urchin_fish_algae_vs_MO_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/MO 16-20 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB), main = "MO 16-20 Survival")
qqline(resid(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB))
dev.off()


## Survival
png("outputs/MO 16-20 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_16_20_survival_lmer), main = "U,F,& AO vs. MO 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_16_20_survival_lmer), main = "U,F,& AO vs. MO 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_survival_lmer))
urchin_fish_algae_vs_MO_16_20_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_16_20_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_16_20_survival_lmer), main = "U,F,& AO vs. MO 16-20 survival")
# effects plots

```


```{r MO 16-20 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r MO 16-20 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r MO 16-20 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


MO_16_20_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_16_20_growth_mixed_effects_original)

r.squaredGLMM(MO_16_20_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

MO_16_20_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(MO_16_20_growth_mixed_effects_original_trans)
# transformed model
```


```{r MO 16-20 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/MO 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_16_20_growth_mixed_effects_original), main = "MO 16-20 Growth")
qqline(resid(MO_16_20_growth_mixed_effects_original))
dev.off()

qqnorm(resid(MO_16_20_growth_mixed_effects_original), main = "MO 16-20 Growth")
qqline(resid(MO_16_20_growth_mixed_effects_original))
MO_16_20_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_16_20_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(MO_16_20_growth_mixed_effects_original), main = "MO 16-20 growth")
# interaction plots

emm_original <- emmeans(MO_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/MO 16-20 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(MO_16_20_growth_mixed_effects_original_trans), main = "MO 16-20 Growth")
qqline(resid(MO_16_20_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(MO_16_20_growth_mixed_effects_original_trans), main = "MO 16-20 Growth trans")
qqline(resid(MO_16_20_growth_mixed_effects_original_trans))
MO_16_20_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(MO_16_20_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(MO_16_20_growth_mixed_effects_original_trans), main = "MO 16-20 growth")
# interaction plots

emm_original <- emmeans(MO_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r MO 16-20 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r MO 16-20 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_MO_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_MO_16_20_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. MO 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_MO_16_20_growth_lmer, main = "Urchins vs. MO 16-20 Growth Residual Plot Original"))
qqline(resid(urchin_vs_MO_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_MO_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_MO_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_MO_16_20_growth_lmer), main = "Urchins vs MO 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_MO_16_20_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_MO_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs MO 16-20 growth final.png", plot = urchin_vs_MO_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_MO_16_20_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_MO_16_20_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. MO 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_MO_16_20_growth_lmer, main = "Fish vs. MO 16-20 Growth Residual Plot Original"))
qqline(resid(fish_vs_MO_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_MO_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_MO_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_MO_16_20_growth_lmer), main = "Fish vs. MO 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_MO_16_20_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_MO_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs MO 16-20 growth final.png", plot = fish_vs_MO_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_MO_16_20_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_MO_16_20_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. MO 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_MO_16_20_growth_lmer, main = "Algae vs. MO 16-20 Growth Residual Plot Original"))
qqline(resid(algae_vs_MO_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_MO_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_MO_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_MO_16_20_growth_lmer), main = "Algae vs. MO 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_MO_16_20_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_MO_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs MO 16-20 growth final.png", plot = algae_vs_MO_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r MO 16-20 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_MO_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_16_20_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_MO_16_20_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 16-20 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans), main = "MO 16-20 Growth")
qqline(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans), main = "U,F,& AO vs. MO 16-20 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans))
urchin_fish_algae_vs_MO_16_20_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_16_20_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_16_20_growth_lmer_trans), main = "U,F,& AO vs. MO 16-20 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. MO 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer), main = "MO 16-20 Growth")
qqline(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer), main = "U,F,& AO vs. MO 16-20 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer))
urchin_fish_algae_vs_MO_16_20_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_MO_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_MO_16_20_growth_lmer), main = "U,F,& AO vs. MO 16-20 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_MO_16_20_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_MO_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. MO 16-20 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_MO_16_20_survival_glmmTMB), main = "U,F,& AO vs. MO 16-20 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_MO_16_20_survival_lmer)

#urchin_fish_algae_vs_MO_16_20_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_16_20_survival_lmer), main = "U,F,& AO vs. MO 16-20 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_MO_16_20_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer), main = "U,F,& AO vs. MO 16 growth Residuals")
qqline(resid(urchin_fish_algae_vs_MO_16_20_growth_lmer))

urchin_fish_algae_vs_MO_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_MO_16_20_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_MO_16_20_growth_lmer), main = "U,F,& AO vs. MO 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(MO_16_20_survival_glmmTMB)
# r^2

MO_16_20_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(MO_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = MO_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "MO 16-20 survival glmmTMB")



r.squaredGLMM(MO_16_20_survival_glmmTMB)
performance::r2_nakagawa(MO_16_20_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(MO_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(MO_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(MO_16_20_survival_lmer_original)


#MO_16_20_survival_fit
# fit

#r.squaredGLMM(MO_16_20_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(MO_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(MO_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(MO_16_20_growth_mixed_effects_original_trans)


#qqnorm(resid(MO_16_20_growth_mixed_effects_original_trans), main = "MO 16-20 Growth trans")
#qqline(resid(MO_16_20_growth_mixed_effects_original_trans))
#MO_16_20_growth_fit_trans
# fit

#r.squaredGLMM(MO_16_20_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(MO_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(MO_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(MO_16_20_growth_mixed_effects_original)


MO_16_20_growth_fit
# fit

r.squaredGLMM(MO_16_20_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(MO_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(MO_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


```{r MO Transition Matrix Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Workflow
# Change "min" in the "Variables" code chunk to 1 and "max" to 100 to insure you include all corals that grew from either size class 1, 2, 3, or 4 to a larger size class (5) outside 1-20 mm

# Run code through "Breakthrough code" to create long database with all transition probabilities for each quarter

# Run code for creation of transition matrices for Site only and Shelter only (no interaction)

### Site x Shelter Transition Matrix Dataframe Code ### 
growth_data_all_matrix <- growth_data_all_matrix[!grepl("_", growth_data_all_matrix$ID),]
# filter out colonies that fused



growth_data_all_matrix <- growth_data_all_matrix %>% mutate(diameter_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(diameter_end), NA, diameter_end),
                                                            size_class_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(size_class_end), NA, size_class_end))
###NOTE: added mutate to make the "diameter_end" and "size_class_end" variables NA even if there was a final measurement of the dead colony in the database.  This is needed for calculating probabilities below for transition matrices which is based on the "size_class_end" being NA to count the transition as mortality.




max_size_class <- 4
# largest size class in transition matrix

## Size class sample size database
sample_size_data <- growth_data_all_matrix %>%
  filter(!is.na(diameter_start), size_class_start <= max_size_class) %>% 
  group_by(Site_long, Shelter, size_class_start) %>% 
  summarise(sample_size = n()) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_"))

test_dataframe_a <- growth_data_all_matrix %>% 
  filter(size_class_start <= max_size_class) %>% 
  group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>% 
  summarise(total_col = n())
# database with total number of colonies for each starting size class for each quarter


test_dataframe <- growth_data_all_matrix %>% filter(size_class_start <= max_size_class) %>% group_by(`Module #`, Quarter, Site_long, Shelter, size_class_start, size_class_end) %>% 
  summarise(total_size = n())
# database with totals for each starting size class transition including mortality represented by size_class_end = NA


test_dataframe_combined <- left_join(test_dataframe, test_dataframe_a)

test_dataframe_combined$total_col <- as.numeric(test_dataframe_combined$total_col)
# make the total_col column into a numeric column

####
# Breakthrough code
test_dataframe_combined_final <- test_dataframe_combined %>% ungroup() %>% 
  complete(`Module #`, Quarter, size_class_start, size_class_end, fill = list(total_size = 0, total_col = 0.5)) %>% 
  mutate(percent_of_colonies = total_size/total_col) %>% 
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_")) %>% 
  sjmisc::replace_na(size_class_end, value = "M")


test_dataframe_combined_final_test <- test_dataframe_combined_final %>% group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>%

  mutate(total_col_new = ifelse(total_col == 0.5, max(total_col), total_col))

test_dataframe_combined_final_test <- test_dataframe_combined_final_test %>% filter(total_col_new != 0.5)

###### Dataframe for Site x Shelter heat maps and matrices



test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_test %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)
# Calculate mean transition probabilities for Site x Shelter
###NOTE: changed "test_dataframe_combined_final_summary_3" to "test_dataframe_combined_final_summary_4" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter

#test_dataframe_combined_final_summary_3 <- test_dataframe_combined_final_test %>% group_by(Quarter, experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))
# Calculate mean transition probabilities for Site x Shelter for each quarter

#test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_3 %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)
# Calculate mean of means to get a mean transition probability for Site x Shelter throughout the study with calculated standard errors




test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% ungroup() %>% 
  complete(experimental_treatment, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))
# Complete function used to insure that no mean transition probabilites are missing.  If not necessary, this version of "test_dataframe_combined_final_summary_4" should be the same as the earlier version above.

test_dataframe_combined_final_summary_4$size_class_end <- factor(test_dataframe_combined_final_summary_4$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
test_dataframe_combined_final_summary_4 <- left_join(test_dataframe_combined_final_summary_4, sample_size_data) %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))


## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4$mean_transition_prob <- round(test_dataframe_combined_final_summary_4$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4$se <- round(test_dataframe_combined_final_summary_4$se, 3)

# Make a new character column for including the mean plus or minus the standard error for placement inside of transition matrices
test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Site Transition Matrix Dataframe Code ###



test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_test %>% group_by(Site_long, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Site" to "test_dataframe_combined_final_summary_4_Site" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Site <- test_dataframe_combined_final_test %>% group_by(Quarter, Site_long, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))

#test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_3_Site %>% group_by(Site_long, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)





test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% ungroup() %>% 
  complete(Site_long, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Site$size_class_end <- factor(test_dataframe_combined_final_summary_4_Site$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Site <- sample_size_data %>% group_by(Site_long, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Site <- left_join(test_dataframe_combined_final_summary_4_Site, sample_size_data_Site) 

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Site$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Site$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Site$se <- round(test_dataframe_combined_final_summary_4_Site$se, 3)

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Shelter Transition Matrix Dataframe Code ###



test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_test %>% group_by(Shelter, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Shelter" to "test_dataframe_combined_final_summary_4_Shelter" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Shelter <- test_dataframe_combined_final_test %>% group_by(Quarter, Shelter, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))


#test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_3_Shelter %>% group_by(Shelter, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)





test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% ungroup() %>% 
  complete(Shelter, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Shelter$size_class_end <- factor(test_dataframe_combined_final_summary_4_Shelter$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Shelter <- sample_size_data %>% group_by(Shelter, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Shelter <- left_join(test_dataframe_combined_final_summary_4_Shelter, sample_size_data_Shelter) 

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Shelter$se <- round(test_dataframe_combined_final_summary_4_Shelter$se, 3)

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Separated databases by Site x Shelter, Site, and Shelter ###
HAN_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_High")
HAN_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_Low")
WAI_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_High")
WAI_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_Low")

WAI_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Waikiki")
HAN_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Hanauma Bay")

Low_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "Low")
High_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "High")

### Site x Shelter Matrix Generation Code ###
## Hanauma Bay_High
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_High_Matrix <- matrix(HAN_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_High_Matrix <- rbind(HAN_High_Matrix, n_size)

HAN_High_Matrix <- as.data.frame(HAN_High_Matrix)
HAN_High_Matrix_table <- tab_df(HAN_High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO HAN_High Transition Matrix.html")

## Hanauma Bay_Low
n_size <- HAN_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Low_Matrix <- matrix(HAN_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Low_Matrix <- rbind(HAN_Low_Matrix, n_size)

HAN_Low_Matrix <- as.data.frame(HAN_Low_Matrix)
HAN_Low_Matrix_table <- tab_df(HAN_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO HAN_Low Transition Matrix.html")


## Waikiki_High
n_size <- WAI_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_High_Matrix <- matrix(WAI_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_High_Matrix <- rbind(WAI_High_Matrix, n_size)

WAI_High_Matrix <- as.data.frame(WAI_High_Matrix)
WAI_High_Matrix_table <- tab_df(WAI_High_Matrix, col.header = col, show.rownames = TRUE, file ="outputs/MO WAI_High Transition Matrix.html")

## Waikiki_Low
n_size <- WAI_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

WAI_Low_Matrix <- matrix(WAI_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Low_Matrix <- rbind(WAI_Low_Matrix, n_size)

WAI_Low_Matrix <- as.data.frame(WAI_Low_Matrix)
WAI_Low_Matrix_table <- tab_df(WAI_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO WAI_Low Transition Matrix.html")
####


### Site Matrix Generation Code ###
# Hanauma Bay only
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Matrix <- matrix(HAN_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Matrix <- rbind(HAN_Matrix, n_size)

HAN_Matrix <- as.data.frame(HAN_Matrix)
HAN_Matrix_table <- tab_df(HAN_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO Hanauma Bay Transition Matrix.html")


## Waikiki only
n_size <- WAI_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_Matrix <- matrix(WAI_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Matrix <- rbind(WAI_Matrix, n_size)

WAI_Matrix <- as.data.frame(WAI_Matrix)
WAI_Matrix_table <- tab_df(WAI_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO Waikiki Transition Matrix.html")


### Shelter Matrix Generation Code ###
# Low_only
n_size <- Low_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
Low_Matrix <- matrix(Low_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
Low_Matrix <- rbind(Low_Matrix, n_size)

Low_Matrix <- as.data.frame(Low_Matrix)
Low_Matrix_table <- tab_df(Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO Low Shelter Transition Matrix.html")


# High_only
n_size <- High_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
High_Matrix <- matrix(High_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
High_Matrix <- rbind(High_Matrix, n_size)

High_Matrix <- as.data.frame(High_Matrix)
High_Matrix_table <- tab_df(High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/MO High Shelter Transition Matrix.html")



### Site x Shelter Heat Map Generation Code ### 
## Waikiki_Low
WAI_Low_Heat_Map <- ggplot(data = WAI_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Waikiki_High
WAI_High_Heat_Map <- ggplot(data = WAI_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_High") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_Low
HAN_Low_Heat_Map <- ggplot(data = HAN_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_High
HAN_High_Heat_Map <- ggplot(data = HAN_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_High") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Site Heat Map Generation Code ###
# Waikiki only
WAI_Heat_Map <- ggplot(data = WAI_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay only
HAN_Heat_Map <- ggplot(data = HAN_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Shelter Heat Map Generation Code ###
# Low shelter only
Low_Heat_Map <- ggplot(data = Low_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Low Shelter") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# High shelter only
High_Heat_Map <- ggplot(data = High_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("High Shelter") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5))  

```


## Transition Matrices and Heat Maps
Transition matrices and heat maps that quantify and visualize probabilities of growth, stasis, shrinkage, and death for corals of all coral size classes (1-4) including growth to larger size classes (5).  Transition matrices also include the number of colonies that comprise the transitions for each size class.

Transition matrices and heat maps are presented in two forms: 1.) comparing each reefscape x shelter treatment combination (eg. Waikiki low shelter modules) and 2.) comparing low vs. high shelter regardless of reefscape and Waikiki vs. Hanauma Bay regardless of shelter treatment.

```{r, echo = TRUE, message=FALSE, warning=FALSE}
# NOTE: In all matrices row 5 represents the size class that is > 20 mm in diameter, row 6 represents percent mortality for each size class (1-4), and row 7 represents the total number of corals sampled in each size class or the sample size

## Waikiki-Low
WAI_Low_Matrix_table
WAI_Low_Heat_Map

ggsave("MO_WAI_Low_Heat_Map final.png", plot = WAI_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki-High
WAI_High_Matrix_table
WAI_High_Heat_Map

ggsave("MO_WAI_High_Heat_Map final.png", plot = WAI_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-Low
HAN_Low_Matrix_table
HAN_Low_Heat_Map

ggsave("MO_HAN_Low_Heat_Map final.png", plot = HAN_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-High
HAN_High_Matrix_table
HAN_High_Heat_Map

ggsave("MO_HAN_High_Heat_Map final.png", plot = HAN_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Low Shelter
Low_Matrix_table
Low_Heat_Map

ggsave("MO_Low_Heat_Map final.png", plot = Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## High Shelter
High_Matrix_table
High_Heat_Map

ggsave("MO_High_Heat_Map final.png", plot = High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki
WAI_Matrix_table
WAI_Heat_Map

ggsave("MO_WAI_Heat_Map final.png", plot = WAI_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay
HAN_Matrix_table
HAN_Heat_Map

ggsave("MO_HAN_Heat_Map final.png", plot = HAN_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


# PR 1-5 mm
```{r PR 1-5 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Rec <- "PR_1_5" 
Sur <- "PR_S_1_5"
Grow <- "PR_G_1_5" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PR 1-5 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 1
max <- 5
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 1


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PR")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PR")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PR 1-5 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```

```{r PR 1-5 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```

```{r PR 1-5 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PR 1-5 Recruitment Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


### General Workflow Summary
# Make series of databases (ID Databases) for each quarter that filter for all corals within the designated size range represented by the size_vect vector while preventing any individual coral ID from being used in subsequent quarters (prevent pseudoreplication by sampling a individual coral colony more than once)

# Make a series of databases (Quarterly Total Recruits and Larval Output Databases) for each quarter that summarize the total number of recruits and total larval ouput for each module side and coral size_class using the previous series of databases to filter out corals that have already been sampled in previous timesteps or quarters

# Bind these series of databases together by row to make a new single dataframe with all module sides and size classes

# Used date log database to add survey dates back into the database that were lost during the use of the complete() function to fill in missing data (where no corals were observed which means there were 0 recruits per square meter not that there are no data)

# Used the complete() functions twice more to fill in for missing data after joining databases

# Use a series of group_by() and summary() functions to group data such that mean coral recruitment per square meter is calculated based on the total area of both N and S sides of each module

### ID Databases
start_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1))

Q1_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2))

Q2_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3))

Q3_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4))

Q4_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5))

Q5_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6))

Q6_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7))

Q7_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8))

Q8_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9))

Q9_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10))

Q10_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11))

Q11_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12))

#Q12_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13))


### Quarterly Total Recruits and Larval Output Databases
start_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q1_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q2_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q3_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q4_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>%  
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q5_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q6_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q7_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q8_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q9_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q10_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q11_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12)) %>% 
  group_by(`Taxonomic Code`, Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

#Q12_recruiment <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13)) %>% 
#  group_by(Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output, Sector, Sector_Area) %>% 
#  summarise(recruits = n(),
 #           total_larvae = sum(larval_output))

### Final Databases
n1_original <- bind_rows(start_recruitment_original, Q1_recruitment_original, Q2_recruitment_original, Q3_recruitment_original, Q4_recruitment_original, Q5_recruitment_original, Q6_recruitment_original, Q7_recruitment_original, Q8_recruitment_original, Q9_recruitment_original, Q10_recruiment_original, Q11_recruiment_original)

date_data <- read_csv("databases/Coral Census Date Log.csv")

date_data$Date <- as.Date(date_data$Date,'%m/%d/%y')
n1_original$Date <- as.Date(n1_original$Date, '%m/%d/%y')
n1_original$Year <- as.numeric(n1_original$Year)
date_data$Year <- as.numeric(date_data$Year)
date_data$`Module #` <- as.numeric(date_data$`Module #`)
n1_original$`Module #` <- as.numeric(n1_original$`Module #`)

date_data <- date_data %>% filter(TimeStep %in% timestep, Side %in% side, `Module #` %in% modules)
# filter census date database

n1_original <- n1_original %>% filter(TimeStep %in% timestep)



n1_original <- left_join(date_data, n1_original, by = c("Date", "Module #", "Site_long", "Shelter", "Side", "TimeStep"))
  
  
### Recruitment by combining sectors (N & S)

n2_original <- n1_original %>% ungroup()  %>% 
  complete(nesting(`Module #`), Side, TimeStep, fill = list(larval_output = 0, recruits = 0, Settlement_Area = 1)) %>% 
  drop_na(Side, `Module #`) %>%  
  mutate(`Taxonomic Code` = species_label)


n2_original <- n2_original %>%

  group_by(`Module #`, TimeStep, Side) %>% 
  mutate(recruits = sum(recruits),
         larvae = larval_output) %>%
  slice(n())

n3_original <- data_final %>% arrange((Date)) %>% 
  group_by(`Module #`, TimeStep, Side) %>% 
  filter(`Max Diameter (mm)` > repro_min) %>% 
  tally() 


n3_original$`Module #` <- as.numeric(n3_original$`Module #`)

n2_original <- left_join(n2_original, n3_original)

n2_original <- n2_original %>% rename("Reproductive" = n)


# Total coral colony calculation 
n5_original <- data_final %>% filter(TimeStep %in% timestep) %>% 
  mutate(Reproductive = ifelse(`Max Diameter (mm)` >= repro_min, "Yes", "No")) %>% 
  group_by(`Taxonomic Code`, Date, Year, Site_long, Shelter, `Module #`, TimeStep, Side, Sector) %>% 
  tally() %>% 
  filter(Side %in% side,
         `Taxonomic Code` %in% species) 


n5_original <- n5_original %>% group_by(Year, Site_long, Shelter, `Module #`, TimeStep, Side) %>% 
  summarize(Date = mean(Date),
            coral_count = sum(n)) %>% 
  filter(!is.na(Date))

n5_original <- n5_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1))

# make Module # a factor column #
n5_original$`Module #` <- as.numeric(n5_original$`Module #`)

n6_original <- left_join(n2_original, n5_original)

n6_original <- n6_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1, Reproductive = 0))


n7_original <- n6_original %>%
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
group_by(TimeStep, `Module #`) %>%
  fill(Date, Year, .direction = "updown") %>% 
    mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))



#### Module Scale Database for Recruitment
date_data_new <- date_data %>% group_by(`Module #`, Site_long, Shelter, TimeStep, Year) %>% 
  summarize(Date_new = mean(Date))

module_data$`Module #` <- as.numeric(module_data$`Module #`)
n7_original$`Module #` <- as.numeric(n7_original$`Module #`)

n7_original <- left_join(n7_original, module_data, by = c("Site_long", "Shelter", "Module #", "Side", "TimeStep"))


n7_original$Settlement_Area <- n7_original$Settlement_Area.y
n7_original$Year <- n7_original$Year.x


n7_original <- n7_original %>% group_by(`Module #`, TimeStep, `Taxonomic Code`, Site_long, Shelter, Year, Season) %>% 
  summarize(recruits = sum(recruits),
    Settlement_Area = sum(Settlement_Area)) %>% 
  mutate(recruits_per_meter_squared = recruits/Settlement_Area)


n7_original <- left_join(n7_original, date_data_new, by = c("Module #", "Site_long", "Shelter", "TimeStep", "Year"))
n7_original$Date <- n7_original$Date_new

```

```{r PR 1-5 Recruitment Data Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}


# Side combined database
n7_original <-  n7_original %>% mutate(recruits_per_meter_squared_trans = log(recruits_per_meter_squared + 1))

plotNormalHistogram(n7_original$recruits_per_meter_squared, main = "Recruitment original")
# recruitment distributions

plotNormalHistogram(n7_original$recruits_per_meter_squared_trans, main = "Recruitment Trans Original")

```

```{r PR 1-5 Recruitment Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#################### lmer original
# all corals with sides combined
# with interaction
module_recruitment <- as.numeric(n7_original$`Module #`)
n7_original$Site_long <- as.factor(n7_original$Site_long)
# factorize variables

n7_original$Season <- as.factor(n7_original$Season)
n7_original$Season <-  factor(n7_original$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE) 
season <- n7_original$Season
n7_original$Shelter <- factor(n7_original$Shelter, levels = c("Low", "High"), ordered = TRUE)
n7_original$Site_long <- factor(n7_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)

PR_recruitment_lmer_original <- lmer(recruits_per_meter_squared_trans ~ Site_long*Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(PR_recruitment_lmer_original)
# model summary

recruitment_lmer_no_interaction_original <- lmer(recruits_per_meter_squared_trans ~ Site_long + Shelter + (1|module_recruitment) + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(recruitment_lmer_no_interaction_original)
# model summary
```


```{r PR 1-5 Recruitment Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Recruitment
png("outputs/PR recruitment trans fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_recruitment_lmer_original), main = "PR recruitment trans Residuals")
qqline(resid(PR_recruitment_lmer_original))
dev.off()

qqnorm(resid(PR_recruitment_lmer_original), main = "PR recruitment trans Residuals")
qqline(resid(PR_recruitment_lmer_original))
PR_recruitment_trans_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PR_recruitment_lmer_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(PR_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(PR_recruitment_lmer_original), main = "PR recruitment trans")
# effects plots


## Recruitment
qqnorm(resid(recruitment_lmer_no_interaction_original, main = "Recruitment Residual Plot Original"))
qqline(resid(recruitment_lmer_no_interaction_original))
# qqplots

r.squaredGLMM(recruitment_lmer_no_interaction_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(recruitment_lmer_no_interaction_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(recruitment_lmer_no_interaction_original), main = "Recruitment Original")
# effects plots
```

```{r PR 1-5 Recruitment Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############## Recruitment barplot summary database and figures ##############
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))
#standard error function for error bars

plot_data_Site1 <- n7_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_recruit = mean(recruits_per_meter_squared),
            sample_size = n())
# mean urchin biomass for each module over entire study
  
plot_data_Site1 <- plot_data_Site1 %>% 
  group_by(Site_long, Shelter) %>% 
  summarise(mean = mean(mean_recruit),
            sd = std.dev.pop(mean_recruit),
            lower = mean(mean_recruit) - std.error.pop(mean_recruit),
            upper = mean(mean_recruit) + std.error.pop(mean_recruit),
            sample_size = n())
# mean urchin biomass for each treatment (n = 3)

plot_data_Site1 <- plot_data_Site1[c(3, 4, 1, 2),]
plot_data_Site1$Shelter <- factor(plot_data_Site1$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


###### Assign name for summary database from input section at top of script
assign(Rec, plot_data_Site1)


myplotfunc_recruitment <- function(x,y,z)
{
    data <- x
    
    mult_compare_recruitment <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))
    return(plot)
}

recruitment_plot_3 <- myplotfunc_recruitment(plot_data_Site1, mult_compare_recruitment, position)


## Barplot with labels
recruitment_plot_4 <- ggplot(data = plot_data_Site1, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


############## Recruitment time series summary database and figures ##############
## Recruitment Time Series Plots
plot_data_recruitment <- n7_original %>%
  group_by(Year, Site_long, Shelter, TimeStep) %>% 
  summarise(mean = mean(recruits_per_meter_squared),
            sd = std.dev.pop(recruits_per_meter_squared),
            lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared),
            Date = mean(Date))
# time series summary database


plot_data_recruitment$Shelter <- factor(plot_data_recruitment$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_recruitment$Site_long <- factor(plot_data_recruitment$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


## combined figure with legend ##
recruitment_time_series_plot_3 <- ggplot(data = plot_data_recruitment, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months",  date_labels = "%b") +
  theme_classic(base_size = 14.5) +
  coord_cartesian(ylim = c(0, 15)) +
  labs(x = "Date", y = expression(paste("Coral recruitment per m"^"2"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), legend.text = element_text(size = rel(1)), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5), legend.position = "none", legend.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.title.y = element_text(size = 18), axis.text = element_text(size = 16))


PR_recruitment_time_series_plot_3 <- recruitment_time_series_plot_3
```


```{r PR 1-5 Recruitment vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

urchin_vs_recruitment_data <- left_join(n7_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

### Analyses ###

# Analysis
module_urchin_recruit <- urchin_vs_recruitment_data$`Module #`

urchin_vs_PR_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_recruit) + (1|Year/Season), data = urchin_vs_recruitment_data, na.action = "na.fail")
summary(urchin_vs_PR_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PR recruitment vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_recruitment_lmer), main = "Urchin vs. PR recruitment Residual Plot Original")
qqline(resid(urchin_vs_PR_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_recruitment_lmer)
#r-squared

emm_PR_recruit_lmer_1_original <- emmeans(urchin_vs_PR_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PR_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_recruitment_lmer), main = "Urchin vs. PR recruitment Original")
# effects plots


### Scatterplot summary database and figures ###

# Urchin vs cover code without timesteps (12 points, 1 for each module)
urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

urchin_vs_recruitment_data_mod <- urchin_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_recruitment_mod_lmer_plot <- ggplot(data = urchin_vs_recruitment_data_mod, aes(x = mean_urchin, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR recruitment vs. urchin biomass final.png", plot = urchin_vs_PR_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 1-5 Recruitment vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Recruitment vs Herbivorous Fish Biomass ###
# Database
n7_original$`Module #` <- as.factor(n7_original$`Module #`)

fish_vs_recruitment_data <- left_join(n7_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_recruitment_data <- fish_vs_recruitment_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_recruit <- fish_vs_recruitment_data$`Module #`

fish_vs_PR_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ total_biomass + Site_long*Shelter + (1|module_fish_recruit) + (1|Year/Season), data = fish_vs_recruitment_data, na.action = "na.fail")
summary(fish_vs_PR_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PR recruitment vs herbivorous fish biomass fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_recruitment_lmer), main = "Herbivorous fish vs. PR recruitment Residual Plot Original")
qqline(resid(fish_vs_PR_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_recruitment_lmer)
#r-squared

emm_PR_recruit_lmer_1_original <- emmeans(fish_vs_PR_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PR_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_recruitment_lmer), main = "Herbivorous fish vs. PR recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs cover code without timesteps (12 points, 1 for each module)
fish_vs_recruitment_data_mod <- fish_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

fish_vs_recruitment_data_mod <- fish_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_recruitment_mod_lmer_plot <- ggplot(data = fish_vs_recruitment_data_mod, aes(x = mean_fish, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
 # geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR recruitment vs. herbivorous fish biomass final.png", plot = fish_vs_PR_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Recruitment vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs recruitment ###
# Database
n7_original$TimeStep <- as.factor(n7_original$TimeStep)
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)

algae_vs_recruitment_data <- left_join(n7_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_recruitment_data <- algae_vs_recruitment_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2

### Analyses ###

# Analysis
module_algae_recruit <- algae_vs_recruitment_data$`Module #`

algae_vs_PR_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ mean_cover_code + Site_long*Shelter + (1|module_algae_recruit) + (1|Year/Season), data = algae_vs_recruitment_data, na.action = "na.fail")
summary(algae_vs_PR_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PR recruitment vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_recruitment_lmer), main = "Algal overgrowth vs. PR recruitment Residual Plot Original")
qqline(resid(algae_vs_PR_recruitment_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_recruitment_lmer)
#r-squared

emm_PR_recruit_lmer_1_original <- emmeans(algae_vs_PR_recruitment_lmer, ~ Site_long*Shelter)
pairs(emm_PR_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_recruitment_lmer), main = "Algal overgrowth vs. PR recruitment Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs cover code without timesteps (12 points, 1 for each module)
algae_vs_recruitment_data_mod <- algae_vs_recruitment_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_recruitment_new = mean(recruits_per_meter_squared),
            recruitment_sd = std.dev.pop(recruits_per_meter_squared),
            recruitment_lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            recruitment_upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared))

algae_vs_recruitment_data_mod <- algae_vs_recruitment_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_recruitment_mod_lmer_plot <- ggplot(data = algae_vs_recruitment_data_mod, aes(x = mean_algae, y = mean_recruitment_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = recruitment_lower, ymax = recruitment_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_recruitment_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Coral recruitment per m"^"2"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR recruitment vs. benthic algal overgrowth final.png", plot = algae_vs_PR_recruitment_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 1-5 Recruiment vs Herbivore Biomass and Benthic Algal Code, echo = FALSE, message=FALSE, warning=FALSE, results='hide', fig.show='hide'}

### Database ###

### Urchin, herbivorous fish, and algae vs. recruitment
# Database
urchin_fish_vs_recruitment_data <- left_join(urchin_vs_recruitment_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_recruitment_data <- urchin_fish_vs_recruitment_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_recruitment_data$TimeStep <- as.factor(urchin_fish_vs_recruitment_data$TimeStep)

urchin_fish_algae_recruitment_data <- left_join(urchin_fish_vs_recruitment_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_recruitment_data <- urchin_fish_algae_recruitment_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

module_urchin_fish_algae_recruit <- urchin_fish_algae_recruitment_data$`Module #`

urchin_fish_algae_vs_PR_recruitment_lmer <- lmer(recruits_per_meter_squared_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_recruit) + (1|Year/Season), data = urchin_fish_algae_recruitment_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_recruitment_lmer)


### Model assessments ###

## Recruitment
png("outputs/PR recruitment trans vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_recruitment_lmer), main = "U, F, & AO vs. PR recruitment Residuals")
qqline(resid(urchin_fish_algae_vs_PR_recruitment_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_recruitment_lmer), main = "U, F, & AO vs. PR recruitment trans Residuals")
qqline(resid(urchin_fish_algae_vs_PR_recruitment_lmer))
urchin_fish_algae_vs_PR_recruitment_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_recruitment_lmer), main = "U, F, & AO vs. PR recruitment")
# effects plots

```




```{r PR 1-5 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  
 

  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.




survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures



survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PR 1-5 Survival Data Tranformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions
plotNormalHistogram(survival_results_long_2_original$survival_trans)
```
 

```{r PR 1-5 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots
PR_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PR_1_5_survival_glmmTMB)



PR_1_5_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PR_1_5_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PR 1-5 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PR 1-5 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_1_5_survival_lmer_original), main = "PR 1-5 survival Residuals")
qqline(resid(PR_1_5_survival_lmer_original))
dev.off()

qqnorm(resid(PR_1_5_survival_lmer_original), main = "PR 1-5 survival Residuals")
qqline(resid(PR_1_5_survival_lmer_original))
PR_1_5_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PR_1_5_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PR_1_5_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PR_1_5_survival_lmer_original), main = "PR 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(PR_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PR_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_1_5_survival_glmmTMB, plot = T)
PR_1_5_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 1-5 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PR_1_5_survival_glmmTMB), main = "PR 1-5 survival glmmTMB Residuals")
qqline(resid(PR_1_5_survival_glmmTMB))
PR_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 1-5 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_1_5_survival_glmmTMB), main = "PR 1-5 Survival")
qqline(resid(PR_1_5_survival_glmmTMB))
dev.off()
```


```{r PR 1-5 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

################ Survival barplot summary database and figures ################# 

## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))


plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)



#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


############### Survival time series summary database and figures ###############

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PR 1-5 Survival vs Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PR_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PR_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 1-5 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_1_5_survival_lmer), main = "Urchins vs. PR 1-5 Survival Residual Plot Original")
qqline(resid(urchin_vs_PR_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_1_5_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(urchin_vs_PR_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_1_5_survival_lmer), main = "Urchins vs PR 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_1_5_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 survival vs urchin biomass final.png", plot = urchin_vs_PR_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Survival vs Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PR_1_5_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PR_1_5_survival_lmer)



### Model assessments ###

## Survival
png("outputs/PR 1-5 survival trans vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_1_5_survival_lmer), main = "Herbivorous fish vs. PR 1-5 Survival Residual Plot Original")
qqline(resid(fish_vs_PR_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_1_5_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(fish_vs_PR_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_1_5_survival_lmer), main = "Herbivorous fish vs PR 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_1_5_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 survival vs herbivorous fish biomass final.png", plot = fish_vs_PR_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Survival vs Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

#### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PR_1_5_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PR_1_5_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 1-5 survival algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_1_5_survival_lmer),main = "Algal overgrowth vs PR 1-5 Survival Residual Plot Original")
qqline(resid(algae_vs_PR_1_5_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_1_5_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PR_1_5_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_1_5_survival_lmer), main = "Algal overgrowth vs PR 1-5 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_1_5_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_1_5_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 survival vs benthic algal overgrowth final.png", plot = algae_vs_PR_1_5_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PR_1_5_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_1_5_survival_lmer)


# DHARMa simulated model
urchin_fish_algae_vs_PR_1_5_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)



### Model assessments ###

## Survival
png("outputs/PR 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_survival_lmer), main = "U,F,& AO vs. PR 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_1_5_survival_lmer), main = "U,F,& AO vs. PR 1-5 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_survival_lmer))
urchin_fish_algae_vs_PR_1_5_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_1_5_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_1_5_survival_lmer), main = "U,F,& AO vs. PR 1-5 survival")
# effects plots


## glmmTMB

r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_1_5_survival_glmmTMB, plot = T)
PR_1_5_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 1-5 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 1-5 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB), main = "U,F,& AO vs. PR 1-5 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB))
urchin_fish_algae_vs_PR_1_5_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 1-5 survival vs. urchin, herbivorous fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB), main = "PR 1-5 Survival")
qqline(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB))
dev.off()

```


```{r PR 1-5 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


#### Filtering Databases for Parametric Tests and Transition Matrices 
### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



############# Function for growth calculations ############# 
###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



########### Growth database for analyses with or without benthic algal code data ########

####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```

```{r PR 1-5 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```

```{r PR 1-5 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PR_1_5_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_1_5_growth_mixed_effects_original)

r.squaredGLMM(PR_1_5_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PR_1_5_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_1_5_growth_mixed_effects_original_trans)
# transformed model
```


```{r PR 1-5 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PR 1-5 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_1_5_growth_mixed_effects_original), main = "PR 1-5 Growth")
qqline(resid(PR_1_5_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PR_1_5_growth_mixed_effects_original), main = "PR 1-5 Growth")
qqline(resid(PR_1_5_growth_mixed_effects_original))
PR_1_5_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_1_5_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PR_1_5_growth_mixed_effects_original), main = "PR 1-5 growth")
# interaction plots

emm_original <- emmeans(PR_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


## lmer
# all corals cube root transformed growth
png("outputs/PR 1-5 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_1_5_growth_mixed_effects_original_trans), main = "PR 1-5 Growth")
qqline(resid(PR_1_5_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PR_1_5_growth_mixed_effects_original_trans), main = "PR 1-5 Growth trans")
qqline(resid(PR_1_5_growth_mixed_effects_original_trans))
PR_1_5_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_1_5_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PR_1_5_growth_mixed_effects_original_trans), main = "PR 1-5 growth")
# interaction plots

emm_original <- emmeans(PR_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```

```{r PR 1-5 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

############### Growth barplot summary database and figures ################

## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)



## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


############# Growth time series summary database and figures ############# 
### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PR 1-5 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PR_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PR_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PR 1-5 growth vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_1_5_growth_lmer, main = "Urchins vs. PR 1-5 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PR_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PR_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_1_5_growth_lmer), main = "Urchins vs PR 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_1_5_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 growth vs. urchins final.png", plot = urchin_vs_PR_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 1-5 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PR_1_5_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PR_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PR 1-5 growth vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_1_5_growth_lmer, main = "Fish vs. PR 1-5 Growth Residual Plot Original"))
qqline(resid(fish_vs_PR_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PR_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_1_5_growth_lmer), main = "Fish vs. PR 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_1_5_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 growth vs. herbivorous fish final.png", plot = fish_vs_PR_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PR_1_5_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PR_1_5_growth_lmer)


### Model assessments ###

## Growth
png("outputs/PR 1-5 growth vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_1_5_growth_lmer, main = "Algae vs. PR 1-5 Growth Residual Plot Original"))
qqline(resid(algae_vs_PR_1_5_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_1_5_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PR_1_5_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_1_5_growth_lmer), main = "Algae vs. PR 1-5 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_1_5_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_1_5_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 1-5 growth vs. algal overgrowth final.png", plot = algae_vs_PR_1_5_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

```{r PR 1-5 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PR_1_5_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_1_5_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PR_1_5_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/PR 1-5 growth trans vs. urchin, herbivorous fish, and algal overgrowth fit.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans), main = "PR 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans), main = "U,F,& AO vs. PR 1-5 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans))
urchin_fish_algae_vs_PR_1_5_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_1_5_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans), main = "U,F,& AO vs. PR 1-5 growth trans")
# effects plots


## Growth
png("outputs/PR 1-5 growth vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer), main = "PR 1-5 Growth")
qqline(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer), main = "U,F,& AO vs. PR 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer))
urchin_fish_algae_vs_PR_1_5_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_1_5_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_1_5_growth_lmer), main = "U,F,& AO vs. PR 1-5 growth")
# effects plots

```


```{r PR 1-5 Requested Committee Meeting Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

n7_original_new <- n7_original %>% group_by(TimeStep, Season, Site_long, Shelter) %>% 
  summarise(Date_new = mean(Date),
            recruit = sum(recruits)) 

n7_original_new2 <- n7_original_new %>% group_by(Site_long, Shelter) %>%
  arrange(TimeStep) %>% 
  mutate(cum_sum_recruits = cumsum(recruit))

n7_original_new2$Shelter <- factor(n7_original_new2$Shelter, levels = c("Low", "High"), ordered = TRUE)


ggplot(data = n7_original_new2, aes(x = Date_new, y = cum_sum_recruits, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = "Date", y = "Cumulative # of Recruits") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = c(.2, .8), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))



############# Algal Cover vs 1-20 mm Total Colony Area #############
data_final_new <- data_final %>% filter(`Max Diameter (mm)` <= 20)

data_final_new <- data_final_new %>% group_by(TimeStep, Site_long, Shelter, `Module #`) %>% 
  summarize(total_area = sum(area_cm_squared))


data_final_new$TimeStep <- as.factor(data_final_new$TimeStep)
data_final_new$`Module #` <- as.factor(data_final_new$`Module #`)

colony_area_and_cover_code_data <- left_join(data_final_new, cover_code_data)

colony_area_and_cover_code_data <- colony_area_and_cover_code_data %>% drop_na(mean_cover_code)


# Variables
module_colony_area_vs_cover_code <- colony_area_and_cover_code_data$`Module #`


col_area_vs_cover_data_mod <- colony_area_and_cover_code_data %>% group_by(`Module #`) %>% 
  summarize(tot_area = mean(total_area),
            area_sd = std.dev.pop(total_area),
            area_lower = mean(total_area) - std.error.pop(total_area),
            area_upper = mean(total_area) + std.error.pop(total_area),
            mean_cover_code_new = mean(mean_cover_code),
            cover_sd = std.dev.pop(mean_cover_code),
            cover_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            cover_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code))

col_area_vs_cover_data_mod <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

col_area_vs_cover_data_mod_no_211 <- col_area_vs_cover_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low")) %>%
  filter(`Module #` != 211)

col_area_vs_cover_code_mod_lm <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm)

col_area_vs_cover_code_mod_lm_no_211 <- lm(tot_area ~ mean_cover_code_new, data = col_area_vs_cover_data_mod_no_211, na.action = "na.fail")
summary(col_area_vs_cover_code_mod_lm_no_211)

### coral lmer full model
col_area_vs_cover_code_lmer <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer)

### coral lmer with significant predictors and algal overgrowth
col_area_vs_cover_code_lmer_sig <- lmer(total_area ~ mean_cover_code + Site_long + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_sig)

### coral lmer with algal overgrowth only
col_area_vs_cover_code_lmer_only <- lmer(total_area ~ mean_cover_code + (1|module_colony_area_vs_cover_code) + (1|Year/Season), data = colony_area_and_cover_code_data, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only)

### coral lmer with algal overgrowth only P/A
colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data %>% mutate(algae_P_A = ifelse(mean_cover_code == 1, 0, 1))
module_colony_area_and_cover_code_data_lmer_only_P_A <- colony_area_and_cover_code_data_lmer_only_P_A$`Module #`

col_area_vs_cover_code_lmer_only_P_A <- lmer(total_area ~ algae_P_A + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_P_A) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_P_A, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_P_A)

### coral lmer with algal overgrowth only >0
colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_P_A %>% filter(algae_P_A == 1)
module_colony_area_and_cover_code_data_lmer_only_above_1 <- colony_area_and_cover_code_data_lmer_only_above_1$`Module #`

col_area_vs_cover_code_lmer_only_above_1 <- lmer(total_area ~ mean_cover_code + Site_long*Shelter + (1|module_colony_area_and_cover_code_data_lmer_only_above_1) + (1|Year/Season), data = colony_area_and_cover_code_data_lmer_only_above_1, na.action = "na.fail")
summary(col_area_vs_cover_code_lmer_only_above_1)


# Plot lmer with SE 
col_area_vs_cover_code_mod_lmer_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with SE
col_area_vs_cover_code_mod_plot <- ggplot(data = col_area_vs_cover_data_mod, aes(x = mean_cover_code_new, y = tot_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  #stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = cover_lower, xmax = cover_upper), width = 0) +
  geom_errorbar(aes(ymin = area_lower, ymax = area_upper), width = 0) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

# Plot with raw data 
col_area_vs_cover_code_plot <- ggplot(data = colony_area_and_cover_code_data, aes(x = mean_cover_code, y = total_area, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5)) +
  stat_smooth(method=stats::lm, aes(fill = NULL, shape = NULL)) +
  geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(col_area_vs_cover_code_lmer_only)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth (1-4)", y = expression(paste("Total coral cover (cm"^"2",")"))) +
  #coord_cartesian(xlim = c(1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))
```


## Recruitment Time Series
```{r, echo = TRUE, message=FALSE, warning=FALSE}
recruitment_time_series_plot_3

ggsave("PR recruitment time series plot final.png", plot = recruitment_time_series_plot_3, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)
```


## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral recruitment, survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more herbivores and less algae)
summary(urchin_fish_algae_vs_PR_recruitment_lmer)
# model summary


urchin_fish_algae_vs_PR_recruitment_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_recruitment_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_recruitment_lmer), main = "U, F, & AO vs. PR recruitment")
# effects plots

```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)

## qqplots
qqnorm(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB), main = "U,F,& AO vs. PR 1-5 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB))
urchin_fish_algae_vs_PR_1_5_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PR 1-5 glmmTMB survival")


r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB), main = "U,F,& AO vs. PR 1-5 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PR_1_5_survival_lmer)

#urchin_fish_algae_vs_PR_1_5_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_1_5_survival_lmer), main = "U,F,& AO vs. PR 1-5 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PR_1_5_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer), main = "U,F,& AO vs. PR 1-5 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_1_5_growth_lmer))

urchin_fish_algae_vs_PR_1_5_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_1_5_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_1_5_growth_lmer), main = "U,F,& AO vs. PR 1-5 growth")
# effects plots
```

```{r PR Benthic Algal Overgrowth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

# lmer full model analysis
summary(urchin_vs_cover_data_lmer)
r.squaredGLMM(urchin_vs_cover_data_lmer)
effect(urchin_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(urchin_vs_cover_data_lmer_sig)
#r.squaredGLMM(urchin_vs_cover_data_lmer_sig)

# lmer with P/A for urchin biomass
#summary(urchin_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_P_A)

# lmer with >0 urchin biomass
#summary(urchin_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(urchin_vs_cover_data_lmer_only_above_0)

#urchin_vs_cover_code_mod_plot_no_trend
# Figure without trendline
#urchin_vs_cover_code_mod_plot
# figure with trendline
#urchin_vs_cover_code_plot_no_trend
# raw data figure without trendline
urchin_vs_cover_code_plot
# raw data figure with trendline
urchin_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(urchin_vs_cover_code_mod_lm)
```


```{r PR Benthic Algal Overgrowth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Herbivorous Fish vs Algal Cover Code (Less algae with more fish)
# lmer analysis only
summary(fish_vs_cover_data_lmer_only)

r.squaredGLMM(fish_vs_cover_data_lmer_only)

# lmer full model analysis
summary(fish_vs_cover_data_lmer)
r.squaredGLMM(fish_vs_cover_data_lmer)
effect(fish_vs_cover_data_lmer)

# lmer dropped non-significant variables
#summary(fish_vs_cover_data_lmer_sig)
#r.squaredGLMM(fish_vs_cover_data_lmer_sig)

# lmer with P/A for fish biomass
#summary(fish_vs_cover_data_lmer_only_P_A)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_P_A)

# lmer with >0 fish biomass
#summary(fish_vs_cover_data_lmer_only_above_0)
#r.squaredGLMM(fish_vs_cover_data_lmer_only_above_0)

fish_vs_cover_code_mod_plot_no_trend
# figure without trendline since it is an marginal result
#fish_vs_cover_code_mod_plot
# trendline added
fish_vs_cover_code_mod_lmer_plot
# lmer plot


# lm analysis
#summary(fish_vs_cover_code_mod_lm)
```

```{r PR Juvenile Coral Cover vs. Benthic Algal Overgrowth, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Algal Cover Code vs. Total Colony Area (Less coral with more algae)
# lmer model
summary(col_area_vs_cover_code_lmer_only)

r.squaredGLMM(col_area_vs_cover_code_lmer_only)

# lmer full model
summary(col_area_vs_cover_code_lmer)
r.squaredGLMM(col_area_vs_cover_code_lmer)
effect(col_area_vs_cover_code_lmer)

# lmer dropped non-significant variables
#summary(col_area_vs_cover_code_lmer_sig)
#r.squaredGLMM(col_area_vs_cover_code_lmer_sig)

# lmer with P/A for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_P_A)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_P_A)

# lmer with >1 for algal overgrowth
#summary(col_area_vs_cover_code_lmer_only_above_1)
#r.squaredGLMM(col_area_vs_cover_code_lmer_only_above_1)

#col_area_vs_cover_code_mod_plot
# figure with trendline
col_area_vs_cover_code_plot
# raw data figure with trendline
#effect(col_area_vs_cover_code_lmer_only)
# effects plot for raw lmer
col_area_vs_cover_code_mod_lmer_plot
# lmer plot with model trendline

# lm model 
summary(col_area_vs_cover_code_mod_lm)

```

```{r PR Herbivore Hypothesis Saved Plots, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

## Urchins
ggsave("Algal overgrowth vs urchins final.png", plot = urchin_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final with trend.png", plot = urchin_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data without trend.png", plot = urchin_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs urchins final raw data.png", plot = urchin_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Herbivorous fish
ggsave("Algal overgrowth vs herbivorous fish final.png", plot = fish_vs_cover_code_mod_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final with trend.png", plot = fish_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data without trend.png", plot = fish_vs_cover_code_plot_no_trend, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("Algal overgrowth vs herbivorous fish final raw data.png", plot = fish_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Coral cover vs. benthic algal code
ggsave("PR coral cover vs algal overgrowth.png", plot = col_area_vs_cover_code_mod_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

ggsave("PR coral cover vs algal overgrowth raw data.png", plot = col_area_vs_cover_code_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.


### Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Recruitment (More coral recruitment with more shelter)
summary(PR_recruitment_lmer_original)
# model summary

PR_recruitment_trans_fit
# fit

r.squaredGLMM(PR_recruitment_lmer_original)
# r^2

# pairwise multiple comparisons
mc_recruitment <- emmeans(PR_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment)
# pairwise multiple comparisons simple
mc_recruitment <- emmeans(PR_recruitment_lmer_original, ~ Site_long*Shelter)
pairs(mc_recruitment, simple = "each")


recruitment_plot_4

## Recruitment without interaction (More coral recruitment with more shelter)
#summary(recruitment_lmer_no_interaction_original)
#r.squaredGLMM(recruitment_lmer_no_interaction_original)
```

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Survival transformed (Greater coral survival with more shelter)
summary(PR_1_5_survival_glmmTMB)


qqnorm(resid(PR_1_5_survival_glmmTMB), main = "PR 1-5 survival glmmTMB Residuals")
qqline(resid(PR_1_5_survival_glmmTMB))
PR_1_5_survival_fit_glmmTMB
#fit

DHARMa::testDispersion(PR_1_5_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_1_5_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PR 1-5 survival glmmTMB")


r.squaredGLMM(PR_1_5_survival_glmmTMB)
performance::r2_nakagawa(PR_1_5_survival_glmmTMB)
# r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PR_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PR_1_5_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")



## Survival (Greater coral survival with more shelter)
#summary(PR_1_5_survival_lmer_original)


#PR_1_5_survival_fit
#fit

#r.squaredGLMM(PR_1_5_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PR_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons
#mc_survival <- emmeans(PR_1_5_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PR_1_5_growth_mixed_effects_original_trans)


#qqnorm(resid(PR_1_5_growth_mixed_effects_original_trans), main = "PR 1-5 Growth trans")
#qqline(resid(PR_1_5_growth_mixed_effects_original_trans))
#PR_1_5_growth_fit_trans
# fit

#r.squaredGLMM(PR_1_5_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PR_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PR_1_5_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PR_1_5_growth_mixed_effects_original)


PR_1_5_growth_fit
# fit

r.squaredGLMM(PR_1_5_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PR_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PR_1_5_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


# PR 6-10 mm
```{r PR 6-10 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "PR_S_6_10"
Grow <- "PR_G_6_10" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PR 6-10 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 6
max <- 10
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 2


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PR")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PR")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PR 6-10 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PR 6-10 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PR 6-10 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PR 6-10 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PR 6-10 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PR 6-10 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PR_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new, dispformula = )
summary(PR_6_10_survival_glmmTMB)


r.squaredGLMM(PR_6_10_survival_glmmTMB)
performance::r2_nakagawa(PR_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PR_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_6_10_survival_glmmTMB, plot = T)
PR_6_10_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 6-10 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PR_6_10_survival_glmmTMB), main = "PR 6-10 survival glmmTMB Residuals")
qqline(resid(PR_6_10_survival_glmmTMB))
PR_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 6-10 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_6_10_survival_glmmTMB), main = "PR 6-10 Survival")
qqline(resid(PR_6_10_survival_glmmTMB))
dev.off()



PR_6_10_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PR_6_10_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PR 6-10 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PR 6-10 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_6_10_survival_lmer_original), main = "PR 6-10 survival Residuals")
qqline(resid(PR_6_10_survival_lmer_original))
dev.off()

qqnorm(resid(PR_6_10_survival_lmer_original), main = "PR 6-10 survival Residuals")
qqline(resid(PR_6_10_survival_lmer_original))
PR_6_10_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PR_6_10_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PR_6_10_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PR_6_10_survival_lmer_original), main = "PR 6-10 survival")
# effects plots
```


```{r PR 6-10 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PR 6-10 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PR_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PR_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 6-10 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_6_10_survival_lmer), main = "Urchins vs. PR 6-10 Survival Residual Plot Original")
qqline(resid(urchin_vs_PR_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_6_10_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(urchin_vs_PR_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_6_10_survival_lmer), main = "Urchins vs PR 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_6_10_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 6-10 survival vs. urchins final.png", plot = urchin_vs_PR_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PR_6_10_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PR_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 6-10 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_6_10_survival_lmer), main = "Herbivorous fish vs. PR 6-10 Survival Residual Plot Original")
qqline(resid(fish_vs_PR_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_6_10_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(fish_vs_PR_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_6_10_survival_lmer), main = "Herbivorous fish vs PR 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_6_10_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 6-10 survival vs. herbivorous fish final.png", plot = fish_vs_PR_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PR_6_10_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PR_6_10_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 6-10 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_6_10_survival_lmer),main = "Algal overgrowth vs PR 6-10 Survival Residual Plot Original")
qqline(resid(algae_vs_PR_6_10_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_6_10_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PR_6_10_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_6_10_survival_lmer), main = "Algal overgrowth vs PR 6-10 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_6_10_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_6_10_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 6-10 survival vs. algal overgrowth final.png", plot = algae_vs_PR_6_10_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PR_6_10_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_6_10_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PR_6_10_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_6_10_survival_glmmTMB, plot = T)
PR_6_10_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 6-10 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 6-10 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB), main = "U,F,& AO vs. PR 6-10 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB))
urchin_fish_algae_vs_PR_6_10_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 6-10 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB), main = "PR 6-10 Survival")
qqline(resid(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PR 6-10 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_6_10_survival_lmer), main = "U,F,& AO vs. PR 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_6_10_survival_lmer), main = "U,F,& AO vs. PR 6-10 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_survival_lmer))
urchin_fish_algae_vs_PR_6_10_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_6_10_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_6_10_survival_lmer), main = "U,F,& AO vs. PR 6-10 survival")
# effects plots

```


```{r PR 6-10 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PR 6-10 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PR 6-10 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PR_6_10_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_6_10_growth_mixed_effects_original)

r.squaredGLMM(PR_6_10_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PR_6_10_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_6_10_growth_mixed_effects_original_trans)
# transformed model
```


```{r PR 6-10 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PR 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_6_10_growth_mixed_effects_original), main = "PR 6-10 Growth")
qqline(resid(PR_6_10_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PR_6_10_growth_mixed_effects_original), main = "PR 6-10 Growth")
qqline(resid(PR_6_10_growth_mixed_effects_original))
PR_6_10_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_6_10_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PR_6_10_growth_mixed_effects_original), main = "PR 6-10 growth")
# interaction plots

emm_original <- emmeans(PR_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PR 6-10 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_6_10_growth_mixed_effects_original_trans), main = "PR 6-10 Growth")
qqline(resid(PR_6_10_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PR_6_10_growth_mixed_effects_original_trans), main = "PR 6-10 Growth trans")
qqline(resid(PR_6_10_growth_mixed_effects_original_trans))
PR_6_10_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_6_10_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PR_6_10_growth_mixed_effects_original_trans), main = "PR 6-10 growth")
# interaction plots

emm_original <- emmeans(PR_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PR 6-10 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)



## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PR 6-10 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PR_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PR_6_10_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PR 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_6_10_growth_lmer, main = "Urchins vs. PR 6-10 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PR_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PR_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_6_10_growth_lmer), main = "Urchins vs PR 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_6_10_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PR 6-10 growth final.png", plot = urchin_vs_PR_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PR_6_10_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PR_6_10_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PR 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_6_10_growth_lmer, main = "Fish vs. PR 6-10 Growth Residual Plot Original"))
qqline(resid(fish_vs_PR_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PR_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_6_10_growth_lmer), main = "Fish vs. PR 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_6_10_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PR 6-10 growth final.png", plot = fish_vs_PR_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PR_6_10_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PR_6_10_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PR 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_6_10_growth_lmer, main = "Algae vs. PR 6-10 Growth Residual Plot Original"))
qqline(resid(algae_vs_PR_6_10_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_6_10_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PR_6_10_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_6_10_growth_lmer), main = "Algae vs. PR 6-10 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_6_10_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_6_10_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PR 6-10 growth final.png", plot = algae_vs_PR_6_10_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 6-10 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PR_6_10_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_6_10_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PR_6_10_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 6-10 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans), main = "PR 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans), main = "U,F,& AO vs. PR 6-10 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans))
urchin_fish_algae_vs_PR_6_10_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_6_10_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_6_10_growth_lmer_trans), main = "U,F,& AO vs. PR 6-10 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 6-10 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer), main = "PR 6-10 Growth")
qqline(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer))
urchin_fish_algae_vs_PR_6_10_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_6_10_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PR_6_10_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PR 6-10 glmmTMB survival")


r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PR_6_10_survival_glmmTMB), main = "U,F,& AO vs. PR 6-10 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PR_6_10_survival_lmer)

#urchin_fish_algae_vs_PR_6_10_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_6_10_survival_lmer), main = "U,F,& AO vs. PR 6-10 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PR_6_10_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_6_10_growth_lmer))

urchin_fish_algae_vs_PR_6_10_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_6_10_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_6_10_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PR_6_10_survival_glmmTMB)
# r^2

PR_6_10_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PR_6_10_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_6_10_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PR 6-10 survival glmmTMB")



r.squaredGLMM(PR_6_10_survival_glmmTMB)
performance::r2_nakagawa(PR_6_10_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PR_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PR_6_10_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PR_6_10_survival_lmer_original)


#PR_6_10_survival_fit
# fit

#r.squaredGLMM(PR_6_10_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PR_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PR_6_10_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PR_6_10_growth_mixed_effects_original_trans)


#qqnorm(resid(PR_6_10_growth_mixed_effects_original_trans), main = "PR 6-10 Growth trans")
#qqline(resid(PR_6_10_growth_mixed_effects_original_trans))
#PR_6_10_growth_fit_trans
# fit

#r.squaredGLMM(PR_6_10_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PR_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PR_6_10_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PR_6_10_growth_mixed_effects_original)


PR_6_10_growth_fit
# fit

r.squaredGLMM(PR_6_10_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PR_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PR_6_10_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```

# PR 11-15 mm
```{r PR 11-15 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "PR_S_11_15"
Grow <- "PR_G_11_15" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PR 11-15 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 11
max <- 15
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 3


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PR")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PR")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PR 11-15 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PR 11-15 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PR 11-15 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PR 11-15 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PR 11-15 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PR 11-15 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PR_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PR_11_15_survival_glmmTMB)

r.squaredGLMM(PR_11_15_survival_glmmTMB)
performance::r2_nakagawa(PR_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PR_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_11_15_survival_glmmTMB, plot = T)
PR_11_15_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 11-15 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 11-15 Survival")
dev.off()


# final DHARMa Q-Q plot
qqnorm(resid(PR_11_15_survival_glmmTMB), main = "PR 11-15 survival glmmTMB Residuals")
qqline(resid(PR_11_15_survival_glmmTMB))
PR_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 11-15 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_11_15_survival_glmmTMB), main = "PR 11-15 Survival")
qqline(resid(PR_11_15_survival_glmmTMB))
dev.off()



PR_11_15_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PR_11_15_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PR 11-15 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PR 11-15 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_11_15_survival_lmer_original), main = "PR 11-15 survival Residuals")
qqline(resid(PR_11_15_survival_lmer_original))
dev.off()

qqnorm(resid(PR_11_15_survival_lmer_original), main = "PR 11-15 survival Residuals")
qqline(resid(PR_11_15_survival_lmer_original))
PR_11_15_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PR_11_15_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PR_11_15_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PR_11_15_survival_lmer_original), main = "PR 11-15 survival")
# effects plots
```


```{r PR 11-15 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PR 11-15 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PR_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PR_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 11-15 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_11_15_survival_lmer), main = "Urchins vs. PR 11-15 Survival Residual Plot Original")
qqline(resid(urchin_vs_PR_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_11_15_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(urchin_vs_PR_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_11_15_survival_lmer), main = "Urchins vs PR 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_11_15_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 11-15 survival vs. urchins final.png", plot = urchin_vs_PR_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PR_11_15_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PR_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 11-15 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_11_15_survival_lmer), main = "Herbivorous fish vs. PR 11-15 Survival Residual Plot Original")
qqline(resid(fish_vs_PR_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_11_15_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(fish_vs_PR_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_11_15_survival_lmer), main = "Herbivorous fish vs PR 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_11_15_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 11-15 survival vs. herbivorous fish final.png", plot = fish_vs_PR_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PR_11_15_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PR_11_15_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 11-15 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_11_15_survival_lmer),main = "Algal overgrowth vs PR 11-15 Survival Residual Plot Original")
qqline(resid(algae_vs_PR_11_15_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_11_15_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PR_11_15_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_11_15_survival_lmer), main = "Algal overgrowth vs PR 11-15 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_11_15_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_11_15_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 11-15 survival vs. algal overgrowth final.png", plot = algae_vs_PR_11_15_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PR_11_15_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_11_15_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PR_11_15_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_11_15_survival_glmmTMB, plot = T)
PR_11_15_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 11-15 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 11-15 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB), main = "U,F,& AO vs. PR 11-15 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB))
urchin_fish_algae_vs_PR_11_15_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 11-15 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB), main = "PR 11-15 Survival")
qqline(resid(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PR 11-15 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_11_15_survival_lmer), main = "U,F,& AO vs. PR 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_11_15_survival_lmer), main = "U,F,& AO vs. PR 11-15 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_survival_lmer))
urchin_fish_algae_vs_PR_11_15_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_11_15_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_11_15_survival_lmer), main = "U,F,& AO vs. PR 11-15 survival")
# effects plots

```


```{r PR 11-15 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PR 11-15 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PR 11-15 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PR_11_15_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_11_15_growth_mixed_effects_original)

r.squaredGLMM(PR_11_15_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PR_11_15_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_11_15_growth_mixed_effects_original_trans)
# transformed model
```


```{r PR 11-15 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PR 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_11_15_growth_mixed_effects_original), main = "PR 11-15 Growth")
qqline(resid(PR_11_15_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PR_11_15_growth_mixed_effects_original), main = "PR 11-15 Growth")
qqline(resid(PR_11_15_growth_mixed_effects_original))
PR_11_15_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_11_15_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PR_11_15_growth_mixed_effects_original), main = "PR 11-15 growth")
# interaction plots

emm_original <- emmeans(PR_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PR 11-15 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_11_15_growth_mixed_effects_original_trans), main = "PR 11-15 Growth")
qqline(resid(PR_11_15_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PR_11_15_growth_mixed_effects_original_trans), main = "PR 11-15 Growth trans")
qqline(resid(PR_11_15_growth_mixed_effects_original_trans))
PR_11_15_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_11_15_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PR_11_15_growth_mixed_effects_original_trans), main = "PR 11-15 growth")
# interaction plots

emm_original <- emmeans(PR_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PR 11-15 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PR 11-15 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PR_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PR_11_15_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PR 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_11_15_growth_lmer, main = "Urchins vs. PR 11-15 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PR_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PR_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_11_15_growth_lmer), main = "Urchins vs PR 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_11_15_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PR 11-15 growth final.png", plot = urchin_vs_PR_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PR_11_15_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PR_11_15_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PR 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_11_15_growth_lmer, main = "Fish vs. PR 11-15 Growth Residual Plot Original"))
qqline(resid(fish_vs_PR_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PR_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_11_15_growth_lmer), main = "Fish vs. PR 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_11_15_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PR 11-15 growth final.png", plot = fish_vs_PR_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PR_11_15_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PR_11_15_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PR 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_11_15_growth_lmer, main = "Algae vs. PR 11-15 Growth Residual Plot Original"))
qqline(resid(algae_vs_PR_11_15_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_11_15_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PR_11_15_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_11_15_growth_lmer), main = "Algae vs. PR 11-15 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_11_15_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_11_15_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PR 11-15 growth final.png", plot = algae_vs_PR_11_15_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 11-15 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PR_11_15_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_11_15_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PR_11_15_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 11-15 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans), main = "PR 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans), main = "U,F,& AO vs. PR 11-15 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans))
urchin_fish_algae_vs_PR_11_15_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_11_15_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_11_15_growth_lmer_trans), main = "U,F,& AO vs. PR 11-15 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 11-15 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer), main = "PR 11-15 Growth")
qqline(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer), main = "U,F,& AO vs. PR 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer))
urchin_fish_algae_vs_PR_11_15_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_11_15_growth_lmer), main = "U,F,& AO vs. PR 11-15 growth")
# effects plots

```

## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PR_11_15_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PR 11-15 glmmTMB survival")



r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PR_11_15_survival_glmmTMB), main = "U,F,& AO vs. PR 11-15 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PR_11_15_survival_lmer)

#urchin_fish_algae_vs_PR_11_15_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_11_15_survival_lmer), main = "U,F,& AO vs. PR 11-15 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PR_11_15_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer), main = "U,F,& AO vs. PR 11-15 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_11_15_growth_lmer))

urchin_fish_algae_vs_PR_11_15_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_11_15_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_11_15_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PR_11_15_survival_glmmTMB)
# r^2

PR_11_15_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PR_11_15_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_11_15_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PR 11-15 survival glmmTMB")



r.squaredGLMM(PR_11_15_survival_glmmTMB)
performance::r2_nakagawa(PR_11_15_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PR_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PR_11_15_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PR_11_15_survival_lmer_original)


#PR_11_15_survival_fit
# fit

#r.squaredGLMM(PR_11_15_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PR_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PR_11_15_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PR_11_15_growth_mixed_effects_original_trans)


#qqnorm(resid(PR_11_15_growth_mixed_effects_original_trans), main = "PR 11-15 Growth trans")
#qqline(resid(PR_11_15_growth_mixed_effects_original_trans))
#PR_11_15_growth_fit_trans
# fit

#r.squaredGLMM(PR_11_15_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PR_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PR_11_15_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PR_11_15_growth_mixed_effects_original)


PR_11_15_growth_fit
# fit

r.squaredGLMM(PR_11_15_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PR_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PR_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```

# PR 16-20 mm
```{r PR 16-20 Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###


###### Summary Plot Databases
Sur <- "PR_S_16_20"
Grow <- "PR_G_16_20" 
# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r PR 16-20 Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 16
max <- 20
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed
size_class_vec <- 4


min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PR")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("PR")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data



```

```{r PR 16-20 Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%  
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```


```{r PR 16-20 Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```


```{r PR 16-20 Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect | size_class == size_class_vec) 
# select diameter size range and module sides to analyze

```


```{r PR 16-20 Survival Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### SURVIVAL
# Real deal
Survival_calc <- function(data, data_1, TimeStep_1, TimeStep_2, quarter){
data <- sub_3
  data_1 <- data_final
  
  Exclusion <- c("NF","D")
  Grouping <- c("TimeStep", "Site_long", "Shelter", "Module #", "Side")

  Col_name <- paste(quarter, "Survival", sep = "_")
  


  Start <- data %>% group_by(ID) %>% 
    filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion)
  # Database that has all corals that started the quarter within size_vect
  ## NOTE: used to have "!TimeStep == MinShrink_stasis" and "n() != 1" but no longer needed due to changes to "results_long" code
  

  

  
  End <- data_1 %>% filter(TimeStep == TimeStep_2) %>%
    inner_join(Start, by = c("ID", "Side", "Site_long", "Shelter", "Module #")) %>%
    rename(Date = Date.x,
           Status_Code = `Status Code.x`,
           TimeStep = TimeStep.x)
  # Database that has all corals that survived to the end of the quarter
  

  
  Start_summary <- Start %>% group_by_at(Grouping) %>% 
    count()
  # Database of the number of corals for each module side where corals in "Start" database were found
  
  End_summary <- End %>% group_by_at(Grouping) %>% 
    summarize(corals = n(),
              dead = sum(Status_Code %in% Exclusion),
              n = corals - dead)
  # Database summarizing the number of corals that survived (n) where at least 2 corals were seen or where no death occurred
  
  
  result_long <-  left_join(Start_summary, End_summary, by = c("Site_long", "Shelter", "Module #", "Side"))
  # Join the summary databases
  
  result_long <- result_long %>% filter(!is.na(n.y)) %>% 
    complete(fill = list(TimeStep.y = TimeStep_2))
  # Use complete function to fill in TimeStep for corals that were the only corals present on that module side AND died by the end of the quarter
  result_long$TimeStep <-   result_long$TimeStep.y
  
  
  

  
  
    result_long <- left_join(result_long, date_data, by = c("TimeStep", "Site_long", "Shelter", "Module #", "Side")) %>% 
    mutate(survived = replace_na(n.y, 0)) %>% 
    # For corals that were the only corals present on that module side AND died by the end of the quarter, replace the NA that resulted from the complete() function to 0 and rename that column "survived"
    mutate("Survival_prop" = (survived/corals)) %>% 
    # Calculate the proportion of corals that survived by dividing by the total colum (n.x)
    mutate(Quarter = quarter) %>% 
    # Use the quarter input from the function to create a new quarter column
     mutate(`Taxonomic Code` = species_label)
  # Label the genera based on the species label provided at the top of this R script
  ### NOTE: changed "Survival_prop" code from "(survived/n.x)" to "(survived/corals)" to correct for corals where measurements exist only in "Start" and not in "End". "n.x" is the number of rows in the "Start database" which includes corals that only have measurements at the start of the quarter.
  
  

  
  
  result_wide <-  left_join(Start_summary, End_summary, by = Grouping) %>% 
    replace(is.na(.), 0) %>%
    transmute(!!Col_name := (n.y/n.x) * 100)
  
  return(result_long)
  
}


# survival calculations
Q1_survival_original <- Survival_calc(sub_3, data_final, 1, 2, 1)
Q2_survival_original <- Survival_calc(sub_3, data_final, 2, 3, 2)
Q3_survival_original <- Survival_calc(sub_3, data_final, 3, 4, 3)
Q4_survival_original <- Survival_calc(sub_3, data_final, 4, 5, 4)
Q5_survival_original <- Survival_calc(sub_3, data_final, 5, 6, 5)
Q6_survival_original <- Survival_calc(sub_3, data_final, 6, 7, 6)
Q7_survival_original <- Survival_calc(sub_3, data_final, 7, 8, 7)
Q8_survival_original <- Survival_calc(sub_3, data_final, 8, 9, 8)
Q9_survival_original <- Survival_calc(sub_3, data_final, 9, 10, 9)
Q10_survival_original <- Survival_calc(sub_3, data_final, 10, 11, 10)
Q11_survival_original <- Survival_calc(sub_3, data_final, 11, 12, 11)


survival_results_long_original <- bind_rows(Q1_survival_original, Q2_survival_original, Q3_survival_original, Q4_survival_original, Q5_survival_original, Q6_survival_original, Q7_survival_original, Q8_survival_original, Q9_survival_original, Q10_survival_original, Q11_survival_original)
# binding each quarterly survival database






survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.


survival_results_long_2_original <- survival_results_long_original %>% group_by(Date, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`, Side, TimeStep) %>%
  filter(!is.na(Year)) %>% 
  summarize(total_corals = sum(corals),
            survive = sum(survived),
            Survival_prop = survive/total_corals,
            `%_Survival` = Survival_prop*100) %>% 
mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  mutate(Year = format(as.Date(Date, format="%Y/%m/%d"),"%y"))
# Clean up some of the columns for clarity and add in seasons column and Year column
### NOTE: changed "total_corals = sum(n.x)" to "= sum(corals)" because "corals" is the actual number of corals being analyzed vs. "n.x" being the number of corals at the "Start".  Corals must have "Start" and "End" row for each individual coral colony.





survival_results_long_2_original_time <- survival_results_long_2_original %>% group_by(Date, TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

survival_results_long_2_original <- survival_results_long_2_original %>% group_by(TimeStep, Year, Season, `Taxonomic Code`, Quarter, Site_long, Shelter, `Module #`) %>% 
  summarize(total_corals_new = sum(total_corals),
            survive_new = sum(survive),
            Survival_prop_new = survive_new/total_corals_new) %>% 
  mutate(`%_Survival` = Survival_prop_new*100)
# Summarize survival database to combine sides (N & S)

###NOTE: removed "Date" from group_by() from survival_results_long_2_original function to prevent survivorship being calculated by date instead of combining muliple dates surveyed into a single survivorship value for that TimeStep.  Then created a new object survival_results_long_2_original_time that keeps dates for the timeseries figures


survival_results_long_2_original$Survival_prop <- survival_results_long_2_original$Survival_prop_new
```


```{r PR 16-20 Survival Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival Analyses
survival_results_long_2_original <- survival_results_long_2_original %>% mutate(survival_trans = logit(Survival_prop))

plotNormalHistogram(survival_results_long_2_original$Survival_prop)

## Distributions 
plotNormalHistogram(survival_results_long_2_original$Survival_prop, main = "Survival Side")
# survival distributions

```


```{r PR 16-20 Survival Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
 
# all corals
module_survival <- as.numeric(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Site_long <- factor(survival_results_long_2_original$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
survival_results_long_2_original$Shelter <- factor(survival_results_long_2_original$Shelter, levels = c("Low", "High"), ordered = TRUE) 
# factorize variables

# DHARMa simulated model and Q-Q plots

PR_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(PR_16_20_survival_glmmTMB)

r.squaredGLMM(PR_16_20_survival_glmmTMB)
performance::r2_nakagawa(PR_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(PR_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_16_20_survival_glmmTMB, plot = T)
PR_16_20_survival_glmmmTMB_DHARMa_fit <- recordPlot()

png("outputs/PR 16-20 survival glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 16-20 Survival")
dev.off()

# final DHARMa Q-Q plot
qqnorm(resid(PR_16_20_survival_glmmTMB), main = "PR 16-20 survival glmmTMB Residuals")
qqline(resid(PR_16_20_survival_glmmTMB))
PR_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 16-20 survival glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_16_20_survival_glmmTMB), main = "PR 16-20 Survival")
qqline(resid(PR_16_20_survival_glmmTMB))
dev.off()



PR_16_20_survival_lmer_original <- lmer(Survival_prop ~ Site_long*Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(PR_16_20_survival_lmer_original)
# model summary


survival_lmer_no_interaction_original <- lmer(Survival_prop ~ Site_long + Shelter + (1|module_survival) + (1|Year/Season), data = survival_results_long_2_original, na.action = "na.fail")
summary(survival_lmer_no_interaction_original)
# no interaction

```

```{r PR 16-20 Survival Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Survival
png("outputs/PR 16-20 survival fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_16_20_survival_lmer_original), main = "PR 16-20 survival Residuals")
qqline(resid(PR_16_20_survival_lmer_original))
dev.off()

qqnorm(resid(PR_16_20_survival_lmer_original), main = "PR 16-20 survival Residuals")
qqline(resid(PR_16_20_survival_lmer_original))
PR_16_20_survival_fit <- recordPlot()
dev.off()
# qqplots

r.squaredGLMM(PR_16_20_survival_lmer_original)
#r-squared

emm_survival_lmer_1_original <- emmeans(PR_16_20_survival_lmer_original, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(PR_16_20_survival_lmer_original), main = "PR 16-20 survival")
# effects plots
```


```{r PR 16-20 Survival Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Survival barplot summary database and figures ###
## Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))



plot_data_Site2 <- survival_results_long_2_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
### NOTE: changed the code to get rid of "Quarter" in group_by() to have means and sd calculated based on entire database and combining the modules (treatment x site level means as in the transition matrices)





#plot_data_Site2 <- survival_results_long_2_original %>%
 # group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  #summarise(mean_survival = mean(`%_Survival`),
   #         sample_size = n()) %>% 
  #mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
#plot_data_Site2 <- plot_data_Site2 %>% 
 # group_by(Site_long, Shelter, size_class) %>% 
  #summarise(mean = mean(mean_survival),
   #         sd = std.dev.pop(mean_survival),
    #        lower = mean(mean_survival) - std.error.pop(mean_survival),
     #       upper = mean(mean_survival) + std.error.pop(mean_survival),
      #      sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site2 <- plot_data_Site2[c(3,4,1,2),]
plot_data_Site2$Shelter <- factor(plot_data_Site2$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting

position <- c("Waikiki", "Hanauma Bay")
# position Waikiki bars for barplot first

###### Assign name for summary database from input section at top of script
assign(Sur, plot_data_Site2)



myplotfunc_suvival <- function(x,y,z)
{
    data <- x
    
    mult_compare_survival <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}
# Function created to help with rendering in R markdown documents but is the same as survival_plot_3 above

survival_plot_3 <- myplotfunc_suvival(plot_data_Site2, mult_compare_survival, position)


## Barplot with labels
survival_plot_4 <- ggplot(data = plot_data_Site2, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_survival, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_y_continuous(breaks = seq(0, 100, by = 30)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = "Coral % survival") +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), axis.title.x = element_blank(),
        legend.position = "none", axis.text.y = element_text(angle = 90))


### Survival time series summary database and figures ###
### Summary Databases

### Population SE ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_survival_time_series <- survival_results_long_2_original_time %>%
  group_by(TimeStep, Quarter, Site_long, Shelter) %>% 
  summarise(mean = mean(`%_Survival`),
            sd = std.dev.pop(`%_Survival`),
            lower = mean(`%_Survival`) - std.error.pop(`%_Survival`),
            upper = mean(`%_Survival`) + std.error.pop(`%_Survival`),
            Date_new = mean(Date))

# add Shelter column #
plot_data_survival_time_series$Shelter <- factor(plot_data_survival_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_survival_time_series$Site_long <- factor(plot_data_survival_time_series$Site_long, levels = c("Hanauma Bay" ,"Waikiki"), ordered = TRUE)


### Time Series Plots
## combined plot without legend
survival_time_series_plot_3 <- ggplot(data = plot_data_survival_time_series, aes(x = Date_new, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  scale_y_continuous(breaks=seq(0, 100, 25)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = "Coral % survival") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

survival_time_series_plot_3
```


```{r PR 16-20 Survival vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$Year <- as.numeric(survival_results_long_2_original$Year)
# reclassify variables

urchin_vs_survival_data <- left_join(survival_results_long_2_original, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))


### Analyses ###

# Analysis
module_urchin_survival <- urchin_vs_survival_data$`Module #`

urchin_vs_PR_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_survival) + (1|Year/Season), data = urchin_vs_survival_data, na.action = "na.fail")
summary(urchin_vs_PR_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 16-20 survival vs. urchins fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_16_20_survival_lmer), main = "Urchins vs. PR 16-20 Survival Residual Plot Original")
qqline(resid(urchin_vs_PR_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_16_20_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(urchin_vs_PR_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_16_20_survival_lmer), main = "Urchins vs PR 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs survival without timesteps (12 points, 1 for each module)
urchin_vs_survival_data_mod <- urchin_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

urchin_vs_survival_data_mod <- urchin_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_16_20_survival_mod_lmer_plot <- ggplot(data = urchin_vs_survival_data_mod, aes(x = mean_urchin, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 16-20 survival vs. urchins final.png", plot = urchin_vs_PR_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Survival vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs survival ###
# Database
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)

fish_vs_survival_data <- left_join(survival_results_long_2_original, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

fish_vs_survival_data <- fish_vs_survival_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_survival <- fish_vs_survival_data$`Module #`

fish_vs_PR_16_20_survival_lmer <- lmer(Survival_prop ~ total_biomass + Site_long*Shelter + (1|module_fish_survival) + (1|Year/Season), data = fish_vs_survival_data, na.action = "na.fail")
summary(fish_vs_PR_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 16-20 survival vs. herbivorous fish fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_16_20_survival_lmer), main = "Herbivorous fish vs. PR 16-20 Survival Residual Plot Original")
qqline(resid(fish_vs_PR_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_16_20_survival_lmer)
#r-squared

emm_PR_survival_lmer_1_original <- emmeans(fish_vs_PR_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_PR_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_16_20_survival_lmer), main = "Herbivorous fish vs PR 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figurs ###

# Fish vs survival without timesteps (12 points, 1 for each module)
fish_vs_survival_data_mod <- fish_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

fish_vs_survival_data_mod <- fish_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_16_20_survival_mod_lmer_plot <- ggplot(data = fish_vs_survival_data_mod, aes(x = mean_fish, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 16-20 survival vs. herbivorous fish final.png", plot = fish_vs_PR_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Survival vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs survival ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
survival_results_long_2_original$`Module #` <- as.factor(survival_results_long_2_original$`Module #`)
survival_results_long_2_original$TimeStep <- as.factor(survival_results_long_2_original$TimeStep)

algae_vs_survival_data <- left_join(survival_results_long_2_original, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

algae_vs_survival_data <- algae_vs_survival_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_survival <- algae_vs_survival_data$`Module #`

algae_vs_PR_16_20_survival_lmer <- lmer(Survival_prop ~ mean_cover_code + Site_long*Shelter + (1|module_algae_survival) + (1|Year/Season), data = algae_vs_survival_data, na.action = "na.fail")
summary(algae_vs_PR_16_20_survival_lmer)


### Model assessments ###

## Survival
png("outputs/PR 16-20 survival vs. algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_16_20_survival_lmer),main = "Algal overgrowth vs PR 16-20 Survival Residual Plot Original")
qqline(resid(algae_vs_PR_16_20_survival_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_16_20_survival_lmer)
#r-squared

emm_survival_lmer_1_original <- emmeans(algae_vs_PR_16_20_survival_lmer, ~ Site_long*Shelter)
pairs(emm_survival_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_16_20_survival_lmer), main = "Algal overgrowth vs PR 16-20 Survival Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs survival without timesteps (12 points, 1 for each module)
algae_vs_survival_data_mod <- algae_vs_survival_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_survival_new = mean(Survival_prop),
            survival_sd = std.dev.pop(Survival_prop),
            survival_lower = mean(Survival_prop) - std.error.pop(Survival_prop),
            survival_upper = mean(Survival_prop) + std.error.pop(Survival_prop))

algae_vs_survival_data_mod <- algae_vs_survival_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_16_20_survival_mod_lmer_plot <- ggplot(data = algae_vs_survival_data_mod, aes(x = mean_algae, y = mean_survival_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = survival_lower, ymax = survival_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_16_20_survival_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algal overgrowth", y = "Coral % survival per quarter") +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("PR 16-20 survival vs. algal overgrowth final.png", plot = algae_vs_PR_16_20_survival_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Survival vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. survival
# Database
urchin_fish_vs_survival_data <- left_join(urchin_vs_survival_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_survival_data <- urchin_fish_vs_survival_data %>% filter(!is.na(total_biomass))

urchin_fish_vs_survival_data$TimeStep <- as.factor(urchin_fish_vs_survival_data$TimeStep)

urchin_fish_algae_survival_data <- left_join(urchin_fish_vs_survival_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_survival_data <- urchin_fish_algae_survival_data %>% filter(!is.na(mean_cover_code))


### Analyses ###

## Analyses
module_urchin_fish_algae_survival <- urchin_fish_algae_survival_data$`Module #`

urchin_fish_algae_vs_PR_16_20_survival_lmer <- lmer(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_16_20_survival_lmer)


# DHARMa simulated model and Q-Q plots

urchin_fish_algae_vs_PR_16_20_survival_glmmTMB <- glmmTMB(Survival_prop ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_survival) + (1|Year/Season), data = urchin_fish_algae_survival_data, na.action = "na.fail", family = glmmTMB_fam, weights = total_corals_new)
summary(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)


### Model assessments ###
r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
# r^2

DHARMa::testDispersion(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_16_20_survival_glmmTMB, plot = T)
PR_16_20_survival_vs_urchin_fish_algae_glmmTMB_DHARMa_fit <- recordPlot()


png("outputs/PR 16-20 survival vs urchin, herbivorous fish, algal overgrowth glmmTMB DHARMa fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
DHARMa::plotQQunif(simulationOutput, testUniformity = FALSE, testOutliers = FALSE, testDispersion = FALSE, main = "PR 16-20 Survival")
dev.off()


# final DHARMa Q-Q plot
qqnorm(resid(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB), main = "U,F,& AO vs. PR 16-20 survival glmmTMB Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB))
urchin_fish_algae_vs_PR_16_20_survival_fit_glmmTMB <- recordPlot()
dev.off()

# save the DHARMa Q-Q plot
png("outputs/PR 16-20 survival vs. urchin, fish, and algal overgrowth glmmTMB fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB), main = "PR 16-20 Survival")
qqline(resid(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB))
dev.off()


## Survival
png("outputs/PR 16-20 survival vs. urchin, herbivorous fish, and algal overgrowth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_16_20_survival_lmer), main = "U,F,& AO vs. PR 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_survival_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_16_20_survival_lmer), main = "U,F,& AO vs. PR 16-20 survival Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_survival_lmer))
urchin_fish_algae_vs_PR_16_20_survival_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_16_20_survival_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_survival_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_16_20_survival_lmer), main = "U,F,& AO vs. PR 16-20 survival")
# effects plots

```


```{r PR 16-20 Growth Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
###### NEW CODE for all measurement sets for each coral that are in size_vect
sub_3.5_test <- sub_3 %>% distinct(ID) 
# ID for all corals that fall within the desired size range (size_vect)


sub_3.6_test <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
  filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
  filter(!`Status Code` %in% exclusion) %>% 
  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals whose ID matches sub_3.5_test

sub_3.6_test_matrix <- data_final %>% group_by(ID) %>% 
  dplyr::arrange(ID, TimeStep) %>% 
 # filter(ID %in% sub_3.5_test$ID) %>% 
  mutate(MD = `Max Diameter (mm)`) %>% 
 # filter(!`Status Code` %in% exclusion) %>% 
#  drop_na(`Max Diameter (mm)`) %>% 
  filter(!n() == 1) 
# Database including all corals that are in the raw coral colony database for transition matrix calculations


################### INDIVIDUAL CORALS SAMPLED ONLY 1 TIME
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>%
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
        TimeStep == MinInTime | TimeStep == MinInTime + 1) %>% # filters for the first measurement that fell in range and the following measure
        filter(is.infinite(MinSkipped)) 


### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES
sub_4_test <- sub_3.6_test  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(size_vect) & `Max Diameter (mm)` <= max(size_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of size_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(size_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of size_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
  # Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinIn < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis,
         TimeStep >= MinInTime & TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) %>% # filters for measures before and including when it goes above the size range (a) and filters for measures before and including the first measure when shrinkage or stasis occurs (b)
  filter(is.infinite(MinSkipped))
# Excludes any corals where they were in the desired size range and then were not measured at the end of the quarter


############### FOR FILTERING CORALS WHERE INDIVIDUAL COLONIES CAN OCCUR MULTIPLE TIMES transition matrix
sub_4_test_matrix <- sub_3.6_test_matrix  %>% 
  arrange(ID,TimeStep) %>%
  # Arrange by ID and TimeSteps columns so each individual coral colonies measurments are in descending order
  mutate(Skipped = case_when(TimeStep - lag(TimeStep) > 1 ~ TRUE, TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if a sequential quarter measurement was skipped
  mutate(Shrank_stasis = case_when(lag(`Max Diameter (mm)`, n = 1) >= `Max Diameter (mm)`~ TRUE, TRUE ~ FALSE)) %>%   # Logical column created to indicate if a sequential quarter measurement showed colony stasis or shrinkage
  mutate(InRange = case_when(`Max Diameter (mm)` >= min(matrix_vect) & `Max Diameter (mm)` <= max(matrix_vect) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  # Logical column created to indicate if the colony measurement is within the range of matrix_vect
  mutate(AboveRange = case_when(`Max Diameter (mm)` > max(matrix_vect) ~ TRUE,
                                TRUE ~ FALSE)) %>%
  # Logical column created to indicate if the colony measurement is above the range of matrix_vect
  mutate(RLE = data.table::rleid(InRange)) %>% 
  # Create column indicating numerically where transitions occur between a colony being "InRange" and "AboveRange" with 1 being the first measurement, 2 being the second measurement, etc.
  mutate(MinIn = min(RLE[InRange]), MinAbove = min(TimeStep[AboveRange]), MinInTime = min(TimeStep[InRange]), MinShrink_stasis = min(TimeStep[Shrank_stasis]), MinSkipped = min(TimeStep[Skipped])) %>% 
# Create columns indicating based on RLE column when the colony first entered the desired size ragne, first went above, the TimeStep it first entered the range, the first TimeStep where shrinkage occured, and the first TimeStep where a measurement was skipped if it occured.  If shrinkage, stasis, or skipped measurements didn't occur, "MinShrink_stasis" or "MinSkipped" will equal "Inf".  If they did occur, the timesteps where they occured will be in these columns.
  filter(MinAbove != 1, # gets rid of all corals that started above the desired size range
         MinInTime < MinAbove, # ensures corals started in the range
         MinInTime < MinShrink_stasis, # ensures corals started in the range
         TimeStep <= MinAbove & TimeStep <= MinShrink_stasis) # ensures that only one measurement above or one measurement after stasis/shrinkage are included



###  Growth Calculation for transition matrices 
Growth_calc_matrix <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test_matrix

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -`Max Diameter (mm)`)
  # Database with all corals in TimeStep_1
  
  End <- data %>% filter(TimeStep == TimeStep_2) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = size_class) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end, `Status Code`)
  # Database with all corals in TimeStep_2
  
  Combined <- inner_join(Start, End, by = c("ID")) %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  # Joined "Start" and "End" by ID to do growth calculations
  
  Combined$`Status Code` <- Combined$`Status Code.y`
  
  return(Combined)
}

### NOTE: The point of using this function is to determine changes in size class for transition matrices.  All other information is extraneous


# Growth Database for matrices
# Individual Summary Databases #
growth_data_Q1_matrix <- Growth_calc_matrix(data, 1, 2, 1)
growth_data_Q2_matrix <- Growth_calc_matrix(data, 2, 3, 2)
growth_data_Q3_matrix <- Growth_calc_matrix(data, 3, 4, 3)
growth_data_Q4_matrix <- Growth_calc_matrix(data, 4, 5, 4)
growth_data_Q5_matrix <- Growth_calc_matrix(data, 5, 6, 5)
growth_data_Q6_matrix <- Growth_calc_matrix(data, 6, 7, 6)
growth_data_Q7_matrix <- Growth_calc_matrix(data, 7, 8, 7)
growth_data_Q8_matrix <- Growth_calc_matrix(data, 8, 9, 8)
growth_data_Q9_matrix <- Growth_calc_matrix(data, 9, 10, 9)
growth_data_Q10_matrix <- Growth_calc_matrix(data, 10, 11, 10)
growth_data_Q11_matrix <- Growth_calc_matrix(data, 11, 12, 11)
#growth_data_Q12_matrix <- Growth_calc_matrix(data, 12, 13, 12)


growth_data_all_matrix <- bind_rows(growth_data_Q1_matrix, growth_data_Q2_matrix, growth_data_Q3_matrix, growth_data_Q4_matrix, growth_data_Q5_matrix, growth_data_Q6_matrix, growth_data_Q7_matrix, growth_data_Q8_matrix, growth_data_Q9_matrix, growth_data_Q10_matrix, growth_data_Q11_matrix)



## Growth Calculation 
Growth_calc <- function(data, TimeStep_1, TimeStep_2, quarter){
  Exclusion <- c("NF","D")

  data <- sub_4_test

  Start <- data %>% filter(TimeStep == TimeStep_1, !`Status Code` %in% Exclusion) %>% 
    mutate(Start_date = Date) %>% 
    mutate(area_start = area_cm_squared) %>% 
    mutate(volume_start = Volume_cm_cubed) %>% 
    mutate(diameter_start = `Max Diameter (mm)`) %>% 
    mutate(size_class_start = size_class) %>% 
    dplyr::select(-Date, -TimeStep, -area_cm_squared, -Volume_cm_cubed, -`Max Diameter (mm)`)
  
  End <- data %>% filter(TimeStep == TimeStep_2, !`Status Code` %in% Exclusion) %>%
    mutate(End_date = Date) %>% 
    mutate(area_end = area_cm_squared) %>% 
    mutate(volume_end = Volume_cm_cubed) %>% 
    mutate(diameter_end = `Max Diameter (mm)`) %>% 
    mutate(size_class_end = ceiling(diameter_end/10)) %>% 
    dplyr::select(ID, End_date, diameter_end, area_end, volume_end, size_class_end)
  
  Combined <- inner_join(Start, End, by = "ID") %>% 
    mutate(delta_area = area_end - area_start) %>%
    mutate(delta_volume = volume_end - volume_start) %>% 
    mutate(delta_diameter = diameter_end - diameter_start) %>% 
    mutate(percent_area_change = 100*(area_end - area_start)/(area_start)) %>% 
    mutate(percent_volume_change = 100*(volume_end - volume_start)/(volume_start)) %>% 
    mutate(Quarter = quarter) %>% 
    mutate(TimeStep = TimeStep_2)
  
  return(Combined)
}



### Growth Database
# Individual Summary Databases #
growth_data_Q1 <- Growth_calc(data, 1, 2, 1)
growth_data_Q2 <- Growth_calc(data, 2, 3, 2)
growth_data_Q3 <- Growth_calc(data, 3, 4, 3)
growth_data_Q4 <- Growth_calc(data, 4, 5, 4)
growth_data_Q5 <- Growth_calc(data, 5, 6, 5)
growth_data_Q6 <- Growth_calc(data, 6, 7, 6)
growth_data_Q7 <- Growth_calc(data, 7, 8, 7)
growth_data_Q8 <- Growth_calc(data, 8, 9, 8)
growth_data_Q9 <- Growth_calc(data, 9, 10, 9)
growth_data_Q10 <- Growth_calc(data, 10, 11, 10)
growth_data_Q11 <- Growth_calc(data, 11, 12, 11)
#growth_data_Q12 <- Growth_calc(data, 12, 13, 12)


growth_data_all <- bind_rows(growth_data_Q1, growth_data_Q2, growth_data_Q3, growth_data_Q4, growth_data_Q5, growth_data_Q6, growth_data_Q7, growth_data_Q8, growth_data_Q9, growth_data_Q10, growth_data_Q11)



####### Cover code on the module scale (new)
growth_data_all <- growth_data_all[!grepl("_", growth_data_all$ID),]
# filter out colonies that fused

## Create row and column variables
growth_data_1cm <- growth_data_all %>% mutate(Column = as.factor(str_extract(Location, "[A-Z]_?[A-Z]?")),
         Row = as.factor(str_extract(Location, "[0-9]_?[0-9]?")))

growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 



growth_data_1cm <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% mutate(`Taxonomic Code` = species_label)



growth_data_1cm$Season <- as.factor(growth_data_1cm$Season)



growth_data_1cm_cover_code <- growth_data_1cm %>% 
  mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring"))))) %>% 
  filter(!is.na(`Cover Code`))

growth_data_1cm_cover_code$Season <- as.factor(growth_data_1cm_cover_code$Season)
growth_data_1cm_cover_code$`Module #` <- as.factor(growth_data_1cm_cover_code$`Module #`)
growth_data_1cm_cover_code$TimeStep <- as.factor(growth_data_1cm_cover_code$TimeStep)
growth_data_1cm_cover_code$Year <- as.numeric(growth_data_1cm_cover_code$Year)
cover_code_data$TimeStep <- as.factor(cover_code_data$TimeStep)
```


```{r PR 16-20 Growth Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
############# Transformations and Distributions (Not needed for growth analyses that are generally normally distributed)

## Distributions 
plotNormalHistogram(growth_data_1cm$delta_diameter, main = "Coral Diameter Growth (mm)")
# diameter distribution
plotNormalHistogram(growth_data_1cm$delta_area, main = "Coral Area Growth (cm^2)")
# area distribution

growth_data_1cm <- growth_data_1cm %>% mutate(delta_area_trans = sign(delta_area)*abs(delta_area)^(1/3))
# cube root transformation

plotNormalHistogram(growth_data_1cm$delta_area_trans, main = "Coral Area Growth (cm^2)")
# area distribution transformed
```


```{r PR 16-20 Growth Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}

# all corals
id_code <- as.factor(growth_data_1cm$ID)
growth_data_1cm$mod <- growth_data_1cm$`Module #`
growth_data_1cm$Year <- as.factor(growth_data_1cm$Year)
growth_data_1cm$Row <- as.factor(growth_data_1cm$Row)
module_growth <- growth_data_1cm$`Module #`
growth_data_1cm$Site_long <- factor(growth_data_1cm$Site_long, levels = c("Waikiki", "Hanauma Bay"), ordered = TRUE)
growth_data_1cm$Shelter <- factor(growth_data_1cm$Shelter, levels = c("Low", "High"), ordered = TRUE) 
growth_data_1cm$Season <- factor(growth_data_1cm$Season, levels = c("summer", "fall", "winter", "spring"), ordered = TRUE)
# factorize variables


PR_16_20_growth_mixed_effects_original <- lmer(delta_area ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_16_20_growth_mixed_effects_original)

r.squaredGLMM(PR_16_20_growth_mixed_effects_original)

growth_mixed_effects_no_interaction_original <- lmer(delta_area ~ Site_long + Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(growth_mixed_effects_no_interaction_original)
# model summary

PR_16_20_growth_mixed_effects_original_trans <- lmer(delta_area_trans ~ Site_long*Shelter + (1|module_growth) + (1|Year/Season) + (1|id_code), data = growth_data_1cm, na.action = "na.fail")
summary(PR_16_20_growth_mixed_effects_original_trans)
# transformed model
```


```{r PR 16-20 Growth Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide", error = TRUE}
### Analysis Assessment Side
## lmer
# all corals
png("outputs/PR 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_16_20_growth_mixed_effects_original), main = "PR 16-20 Growth")
qqline(resid(PR_16_20_growth_mixed_effects_original))
dev.off()

qqnorm(resid(PR_16_20_growth_mixed_effects_original), main = "PR 16-20 Growth")
qqline(resid(PR_16_20_growth_mixed_effects_original))
PR_16_20_growth_fit <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_16_20_growth_mixed_effects_original)
# r-squared for model fit

plot(allEffects(PR_16_20_growth_mixed_effects_original), main = "PR 16-20 growth")
# interaction plots

emm_original <- emmeans(PR_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests


### Analysis Assessment Side
## lmer
# all corals cube root transformed growth
png("outputs/PR 16-20 growth fit final trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(PR_16_20_growth_mixed_effects_original_trans), main = "PR 16-20 Growth")
qqline(resid(PR_16_20_growth_mixed_effects_original_trans))
dev.off()

qqnorm(resid(PR_16_20_growth_mixed_effects_original_trans), main = "PR 16-20 Growth trans")
qqline(resid(PR_16_20_growth_mixed_effects_original_trans))
PR_16_20_growth_fit_trans <- recordPlot()
dev.off()
# qqplots for fit

r.squaredGLMM(PR_16_20_growth_mixed_effects_original_trans)
# r-squared for model fit

plot(allEffects(PR_16_20_growth_mixed_effects_original_trans), main = "PR 16-20 growth")
# interaction plots

emm_original <- emmeans(PR_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
pairs(emm_original)
# post-hoc tests
```


```{r PR 16-20 Growth Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Growth barplot summary database and figures ###

## Growth Plot Module Side and Sector Combined Summary Databases  
## Summary Dataframes
#barplot with CI
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

#plot_data_Site3 
plot_data_Site3 <- growth_data_1cm %>%
  group_by(`Taxonomic Code`, Site_long, Shelter, `Module #`) %>% 
  summarise(mean_growth = mean(delta_area),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
# mean urchin biomass for each module over entire study
  
plot_data_Site3 <- plot_data_Site3 %>% 
  group_by(Site_long, Shelter, size_class) %>% 
  summarise(mean = mean(mean_growth),
            sd = std.dev.pop(mean_growth),
            lower = mean(mean_growth) - std.error.pop(mean_growth),
            upper = mean(mean_growth) + std.error.pop(mean_growth),
            sample_size = n()) 
# mean urchin biomass for each treatment (n = 3)


plot_data_Site3 <- plot_data_Site3[c(3,4,1,2),]
plot_data_Site3$Shelter <- factor(plot_data_Site3$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot final #


###### Assign name for summary database from input section at top of script
assign(Grow, plot_data_Site3)



myplotfunc_growth <- function(x,y,z)
{
    data <- x
    
    mult_compare_growth_all <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
    plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90),
        axis.text.x = element_blank())
    return(plot)
}

growth_plot_3 <- myplotfunc_growth(plot_data_Site3, mult_compare_growth_all, position)


## Barplot with labels
growth_plot_4 <- ggplot(data = plot_data_Site3, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
  #geom_text(aes(label = mult_compare_growth_all, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
 #     geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
  #          position = position_dodge(width = .8)) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_classic(base_size = 14.5) +
  theme(text = element_text(size = 18), legend.position = "none", 
        axis.title.x = element_blank(),
        axis.text.y = element_text(angle = 90))


### Growth time series summary database and plots ###


### Summary Databases
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))

plot_data_growth_time_series <- growth_data_1cm %>%
  group_by(Site_long, Shelter, Quarter) %>% 
  summarise(mean = mean(delta_area),
            sd = std.dev.pop(delta_area),
            lower = mean(delta_area) - std.error.pop(delta_area),
            upper = mean(delta_area) + std.error.pop(delta_area),
            Date = mean(End_date))

plot_data_growth_time_series$Shelter <- factor(plot_data_growth_time_series$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_growth_time_series$Site_long <- factor(plot_data_growth_time_series$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# all corals


### Time Series Plots
## all corals
# cropped plot for combined figure #
growth_time_series_plot_3 <- ggplot(data = plot_data_growth_time_series, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) + 
  geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c(NA, NA, 1, 1), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= 0) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%b") +
  labs(x = "Date", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

growth_time_series_plot_3
```


```{r PR 16-20 Growth vs. Urchin Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin biomass vs growth ###
# Database
growth_data_1cm_new <- growth_data_1cm %>% select(ID, mod, TimeStep, Site_long, Shelter, Season, delta_area) %>%
  group_by(ID, mod, TimeStep, Site_long, Shelter, Season) %>% 
  summarize(mean_growth = mean(delta_area)) %>% 
  group_by(mod, TimeStep, Site_long, Shelter, Season) %>%
  summarize(mean_growth_combined = mean(mean_growth)) %>% 
  rename('Module #' = mod)


growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)
# reclassify variables

urchin_vs_growth_data <- left_join(growth_data_1cm_new, mean_urchin_totals2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))


### Analyses ###

# Analysis
module_urchin_growth <- urchin_vs_growth_data$`Module #`

urchin_vs_PR_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + Site_long*Shelter + (1|module_urchin_growth) + (1|Year/Season), data = urchin_vs_growth_data, na.action = "na.fail")
summary(urchin_vs_PR_16_20_growth_lmer)


### Model assessments ##

## Growth
png("outputs/Urchins vs. PR 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_vs_PR_16_20_growth_lmer, main = "Urchins vs. PR 16-20 Growth Residual Plot Original"))
qqline(resid(urchin_vs_PR_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(urchin_vs_PR_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(urchin_vs_PR_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(urchin_vs_PR_16_20_growth_lmer), main = "Urchins vs PR 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
urchin_vs_growth_data_mod <- urchin_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_urchin = mean(urchin_biomass),
            urchin_sd = std.dev.pop(urchin_biomass),
            urchin_lower = mean(urchin_biomass) - std.error.pop(urchin_biomass),
            urchin_upper = mean(urchin_biomass) + std.error.pop(urchin_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

urchin_vs_growth_data_mod <- urchin_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
urchin_vs_PR_16_20_growth_mod_lmer_plot <- ggplot(data = urchin_vs_growth_data_mod, aes(x = mean_urchin, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = urchin_lower, xmax = urchin_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`urchin_biomass`), as.data.frame(t(fixef(urchin_vs_PR_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Urchin biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Urchins vs PR 16-20 growth final.png", plot = urchin_vs_PR_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Growth vs. Herbivorous Fish Biomass, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Fish biomass vs growth ###
# Database
growth_data_1cm_new$`Module #` <- as.factor(growth_data_1cm_new$`Module #`)

fish_vs_growth_data <- left_join(growth_data_1cm_new, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

fish_vs_growth_data <- fish_vs_growth_data %>% filter(!is.na(total_biomass))
# get rid of NAs associated with missing fish census from timestep 4


### Analyses ###

# Analysis
module_fish_growth <- fish_vs_growth_data$`Module #`

fish_vs_PR_16_20_growth_lmer <- lmer(mean_growth_combined ~ total_biomass + Site_long*Shelter + (1|module_fish_growth) + (1|Year/Season), data = fish_vs_growth_data, na.action = "na.fail")
summary(fish_vs_PR_16_20_growth_lmer)


#### Model assessments ###

## Growth
png("outputs/Herbivorous fish vs. PR 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(fish_vs_PR_16_20_growth_lmer, main = "Fish vs. PR 16-20 Growth Residual Plot Original"))
qqline(resid(fish_vs_PR_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(fish_vs_PR_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(fish_vs_PR_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(fish_vs_PR_16_20_growth_lmer), main = "Fish vs. PR 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Urchin vs growth without timesteps (12 points, 1 for each module)
fish_vs_growth_data_mod <- fish_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_fish = mean(total_biomass),
            fish_sd = std.dev.pop(total_biomass),
            fish_lower = mean(total_biomass) - std.error.pop(total_biomass),
            fish_upper = mean(total_biomass) + std.error.pop(total_biomass),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

fish_vs_growth_data_mod <- fish_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
fish_vs_PR_16_20_growth_mod_lmer_plot <- ggplot(data = fish_vs_growth_data_mod, aes(x = mean_fish, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = fish_lower, xmax = fish_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`total_biomass`), as.data.frame(t(fixef(fish_vs_PR_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Herbivorous fish biomass (kg/module)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Herbivorous fish vs PR 16-20 growth final.png", plot = fish_vs_PR_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Growth vs. Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Algal overgrowth vs growth ###
# Database
cover_code_data$`Module #` <- as.factor(cover_code_data$`Module #`)
growth_data_1cm_new$TimeStep <- as.factor(growth_data_1cm_new$TimeStep)

algae_vs_growth_data <- left_join(growth_data_1cm_new, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Season"))

algae_vs_growth_data <- algae_vs_growth_data %>% filter(!is.na(mean_cover_code))
# get rid of NAs associated with no cover code data for timesteps 1 & 2


### Analyses ###

# Analysis
module_algae_growth <- algae_vs_growth_data$`Module #`

algae_vs_PR_16_20_growth_lmer <- lmer(mean_growth_combined ~ mean_cover_code + Site_long*Shelter + (1|module_algae_growth) + (1|Year/Season), data = algae_vs_growth_data, na.action = "na.fail")
summary(algae_vs_PR_16_20_growth_lmer)


### Model assessments ###

## Growth
png("outputs/Algae vs. PR 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(algae_vs_PR_16_20_growth_lmer, main = "Algae vs. PR 16-20 Growth Residual Plot Original"))
qqline(resid(algae_vs_PR_16_20_growth_lmer))
dev.off()
# qqplots

r.squaredGLMM(algae_vs_PR_16_20_growth_lmer)
#r-squared

emm_growth_lmer_1_original <- emmeans(algae_vs_PR_16_20_growth_lmer, ~ Site_long*Shelter)
pairs(emm_growth_lmer_1_original)
# post-hoc tests

plot(allEffects(algae_vs_PR_16_20_growth_lmer), main = "Algae vs. PR 16-20 Growth Original")
# effects plots


### Scatter plot summary database and figures ###

# Algae vs growth without timesteps (12 points, 1 for each module)
algae_vs_growth_data_mod <- algae_vs_growth_data %>% group_by(`Module #`) %>% 
  summarize(mean_algae = mean(mean_cover_code),
            algae_sd = std.dev.pop(mean_cover_code),
            algae_lower = mean(mean_cover_code) - std.error.pop(mean_cover_code),
            algae_upper = mean(mean_cover_code) + std.error.pop(mean_cover_code),
            mean_growth_new = mean(mean_growth_combined),
            growth_sd = std.dev.pop(mean_growth_combined),
            growth_lower = mean(mean_growth_combined) - std.error.pop(mean_growth_combined),
            growth_upper = mean(mean_growth_combined) + std.error.pop(mean_growth_combined))

algae_vs_growth_data_mod <- algae_vs_growth_data_mod %>% mutate(Site_long = ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay")) %>% 
  mutate(Shelter = ifelse(`Module #` %in% c(111,113,115,211,213,215), "High", "Low"))

# Plot lmer with CI 
algae_vs_PR_16_20_growth_mod_lmer_plot <- ggplot(data = algae_vs_growth_data_mod, aes(x = mean_algae, y = mean_growth_new, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 5), position = "jitter") +
  stat_smooth(method=stats::glm, aes(fill = NULL, shape = NULL)) +
  geom_errorbarh(aes(xmin = algae_lower, xmax = algae_upper), width = 0) +
  geom_errorbar(aes(ymin = growth_lower, ymax = growth_upper), width = 0) +
  #geom_abline(aes(intercept=`(Intercept)`, slope=`mean_cover_code`), as.data.frame(t(fixef(algae_vs_PR_16_20_growth_lmer)))) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("black", "black", "white", "white"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 4))) +
  labs(x = "Algae overgrowth (1-4)", y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  #coord_cartesian(xlim = c(0, 0.450), ylim = c(1.1, 1.7)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(size = 16), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.text = element_text(size = rel(1.5)), legend.title = element_text(size = rel(1.5)), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))

ggsave("Algae overgrowth vs PR 16-20 growth final.png", plot = algae_vs_PR_16_20_growth_mod_lmer_plot, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```


```{r PR 16-20 Growth vs. Herbivore Biomass and Benthic Algal Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}

### Database ###

### Urchin, herbivorous fish, and algae vs. growth
# Database
urchin_fish_vs_growth_data <- left_join(urchin_vs_growth_data, mean_fish_totals_2, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_vs_growth_data <- urchin_fish_vs_growth_data %>% filter(!is.na(total_biomass))
urchin_fish_vs_growth_data$TimeStep <- as.factor(urchin_fish_vs_growth_data$TimeStep)

urchin_fish_algae_growth_data <- left_join(urchin_fish_vs_growth_data, cover_code_data, by = c("Module #", "TimeStep", "Site_long", "Shelter", "Year", "Season"))

urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% filter(!is.na(mean_cover_code))


### Analyses ###
module_urchin_fish_algae_growth <- urchin_fish_algae_growth_data$`Module #`

urchin_fish_algae_vs_PR_16_20_growth_lmer <- lmer(mean_growth_combined ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_16_20_growth_lmer)


urchin_fish_algae_growth_data <- urchin_fish_algae_growth_data %>% mutate(mean_growth_combined_trans = sign(mean_growth_combined)*abs(mean_growth_combined)^(1/3))
# cube root growth transformation

urchin_fish_algae_vs_PR_16_20_growth_lmer_trans <- lmer(mean_growth_combined_trans ~ urchin_biomass + total_biomass + mean_cover_code + (1|module_urchin_fish_algae_growth) + (1|Year/Season), data = urchin_fish_algae_growth_data, na.action = "na.fail")
summary(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans)
# cube root transformed model


### Model assessments ###

# Growth cube root transformed
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 16-20 growth fit trans.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans), main = "PR 16-20 Growth")
qqline(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans), main = "U,F,& AO vs. PR 16-20 growth trans Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans))
urchin_fish_algae_vs_PR_16_20_growth_trans_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_16_20_growth_trans_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_16_20_growth_lmer_trans), main = "U,F,& AO vs. PR 16-20 growth trans")
# effects plots


## Growth
png("outputs/Urchin, herbivorous fish, algal overgrowth vs. PR 16-20 growth fit final.png", width = 6.25, height = 5.209, units = "in", res = 96)
qqnorm(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer), main = "PR 16-20 rowth")
qqline(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer))
dev.off()

qqnorm(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer), main = "U,F,& AO vs. PR 16-20 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer))
urchin_fish_algae_vs_PR_16_20_growth_fit <- recordPlot()
dev.off()

urchin_fish_algae_vs_PR_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_growth_lmer)
#r-squared

plot(allEffects(urchin_fish_algae_vs_PR_16_20_growth_lmer), main = "U,F,& AO vs. PR 16-20 growth")
# effects plots

```


```{r PR Transition Matrix Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Workflow
# Change "min" in the "Variables" code chunk to 1 and "max" to 100 to insure you include all corals that grew from either size class 1, 2, 3, or 4 to a larger size class (5) outside 1-20 mm

# Run code through "Breakthrough code" to create long database with all transition probabilities for each quarter

# Run code for creation of transition matrices for Site only and Shelter only (no interaction)

### Site x Shelter Transition Matrix Dataframe Code ###
growth_data_all_matrix <- growth_data_all_matrix[!grepl("_", growth_data_all_matrix$ID),]
# filter out colonies that fused




growth_data_all_matrix <- growth_data_all_matrix %>% mutate(diameter_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(diameter_end), NA, diameter_end),
                                                            size_class_end = ifelse(`Status Code` %in% c("NF", "D") & !is.na(size_class_end), NA, size_class_end))
###NOTE: added mutate to make the "diameter_end" and "size_class_end" variables NA even if there was a final measurement of the dead colony in the database.  This is needed for calculating probabilities below for transition matrices which is based on the "size_class_end" being NA to count the transition as mortality.




max_size_class <- 4
# largest size class in transition matrix

## Size class sample size database
sample_size_data <- growth_data_all_matrix %>%
  filter(!is.na(diameter_start), size_class_start <= max_size_class) %>% 
  group_by(Site_long, Shelter, size_class_start) %>% 
  summarise(sample_size = n()) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_"))

test_dataframe_a <- growth_data_all_matrix %>% 
  filter(size_class_start <= max_size_class) %>% 
  group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>% 
  summarise(total_col = n())
# database with total number of colonies for each starting size class for each quarter


test_dataframe <- growth_data_all_matrix %>% filter(size_class_start <= max_size_class) %>% group_by(`Module #`, Quarter, Site_long, Shelter, size_class_start, size_class_end) %>% 
  summarise(total_size = n())
# database with totals for each starting size class transition including mortality represented by size_class_end = NA


test_dataframe_combined <- left_join(test_dataframe, test_dataframe_a)

test_dataframe_combined$total_col <- as.numeric(test_dataframe_combined$total_col)
# make the total_col column into a numeric column

####
# Breakthrough code
test_dataframe_combined_final <- test_dataframe_combined %>% ungroup() %>% 
  complete(`Module #`, Quarter, size_class_start, size_class_end, fill = list(total_size = 0, total_col = 0.5)) %>% 
  mutate(percent_of_colonies = total_size/total_col) %>% 
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
  mutate(experimental_treatment = paste(Site_long, Shelter, sep = "_")) %>% 
  sjmisc::replace_na(size_class_end, value = "M")


test_dataframe_combined_final_test <- test_dataframe_combined_final %>% group_by(`Module #`, Site_long, Shelter, Quarter, size_class_start) %>%

  mutate(total_col_new = ifelse(total_col == 0.5, max(total_col), total_col))

test_dataframe_combined_final_test <- test_dataframe_combined_final_test %>% filter(total_col_new != 0.5)

###### Dataframe for Site x Shelter heat maps and matrices



test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_test %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)
# Calculate mean transition probabilities for Site x Shelter
###NOTE: changed "test_dataframe_combined_final_summary_3" to "test_dataframe_combined_final_summary_4" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter

#test_dataframe_combined_final_summary_3 <- test_dataframe_combined_final_test %>% group_by(Quarter, experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))
# Calculate mean transition probabilities for Site x Shelter for each quarter

#test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_3 %>% group_by(experimental_treatment, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)
# Calculate mean of means to get a mean transition probability for Site x Shelter throughout the study with calculated standard errors




test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% ungroup() %>% 
  complete(experimental_treatment, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))
# Complete function used to insure that no mean transition probabilites are missing.  If not necessary, this version of "test_dataframe_combined_final_summary_4" should be the same as the earlier version above.

test_dataframe_combined_final_summary_4$size_class_end <- factor(test_dataframe_combined_final_summary_4$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
test_dataframe_combined_final_summary_4 <- left_join(test_dataframe_combined_final_summary_4, sample_size_data) %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))


## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4$mean_transition_prob <- round(test_dataframe_combined_final_summary_4$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4$se <- round(test_dataframe_combined_final_summary_4$se, 3)

# Make a new character column for including the mean plus or minus the standard error for placement inside of transition matrices
test_dataframe_combined_final_summary_4 <- test_dataframe_combined_final_summary_4 %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Site Transition Matrix Dataframe Code ###



test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_test %>% group_by(Site_long, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Site" to "test_dataframe_combined_final_summary_4_Site" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Site <- test_dataframe_combined_final_test %>% group_by(Quarter, Site_long, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))

#test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_3_Site %>% group_by(Site_long, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)





test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% ungroup() %>% 
  complete(Site_long, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Site$size_class_end <- factor(test_dataframe_combined_final_summary_4_Site$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Site <- sample_size_data %>% group_by(Site_long, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Site <- left_join(test_dataframe_combined_final_summary_4_Site, sample_size_data_Site) 

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Site$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Site$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Site$se <- round(test_dataframe_combined_final_summary_4_Site$se, 3)

test_dataframe_combined_final_summary_4_Site <- test_dataframe_combined_final_summary_4_Site %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))




### Shelter Transition Matrix Dataframe Code ###



test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_test %>% group_by(Shelter, size_class_start, size_class_end) %>% 
  summarise(mean_transition_prob = mean(percent_of_colonies),
            se = std.error.pop(percent_of_colonies),
            lower = mean(percent_of_colonies) - std.error.pop(percent_of_colonies),
            upper = mean(percent_of_colonies) + std.error.pop(percent_of_colonies)) %>% 
  drop_na(size_class_start)

###NOTE: changed "test_dataframe_combined_final_summary_3_Shelter" to "test_dataframe_combined_final_summary_4_Shelter" to get rid of grouping by "Quarter" from group_by() to calculated means on entire database instead of by quarter


#test_dataframe_combined_final_summary_3_Shelter <- test_dataframe_combined_final_test %>% group_by(Quarter, Shelter, size_class_start, size_class_end) %>% 
 # summarise(transition_prob = mean(percent_of_colonies))


#test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_3_Shelter %>% group_by(Shelter, size_class_start, size_class_end) %>% 
 # summarise(mean_transition_prob = mean(transition_prob),
  #          se = std.error.pop(transition_prob),
   #         lower = mean(transition_prob) - std.error.pop(transition_prob),
    #        upper = mean(transition_prob) + std.error.pop(transition_prob)) %>% 
  #drop_na(size_class_start)





test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% ungroup() %>% 
  complete(Shelter, size_class_start, size_class_end, fill = list(mean_transition_prob = 0))

test_dataframe_combined_final_summary_4_Shelter$size_class_end <- factor(test_dataframe_combined_final_summary_4_Shelter$size_class_end, levels = c("M", 5, 4, 3, 2, 1), ordered = TRUE)

## Add sample sizes to dataframe
sample_size_data_Shelter <- sample_size_data %>% group_by(Shelter, size_class_start) %>% 
  summarize(sample_size = sum(sample_size))
# change sample size dataframe for Site only analysis

test_dataframe_combined_final_summary_4_Shelter <- left_join(test_dataframe_combined_final_summary_4_Shelter, sample_size_data_Shelter) 

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(sample_size = ifelse(is.na(sample_size), 0, sample_size))

## Create column for combined proportion and SE
test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob <- round(test_dataframe_combined_final_summary_4_Shelter$mean_transition_prob, 3)
test_dataframe_combined_final_summary_4_Shelter$se <- round(test_dataframe_combined_final_summary_4_Shelter$se, 3)

test_dataframe_combined_final_summary_4_Shelter <- test_dataframe_combined_final_summary_4_Shelter %>% mutate(mean_transition_prob_full = paste(mean_transition_prob, se, sep = "  ")) %>% 
  mutate(mean_transition_prob_full = ifelse(mean_transition_prob_full %in% c("0  0", "0  NA"), 0, mean_transition_prob_full))





### Separated databases by Site x Shelter, Site, and Shelter ###
HAN_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_High")
HAN_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Hanauma Bay_Low")
WAI_high_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_High")
WAI_low_transition <- test_dataframe_combined_final_summary_4 %>% filter(experimental_treatment == "Waikiki_Low")

WAI_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Waikiki")
HAN_transitions <- test_dataframe_combined_final_summary_4_Site %>% filter(Site_long == "Hanauma Bay")

Low_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "Low")
High_transitions <- test_dataframe_combined_final_summary_4_Shelter %>% filter(Shelter == "High")
  

### Site x Shelter Matrix Generation Code ###
## Hanauma Bay_High
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_High_Matrix <- matrix(HAN_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_High_Matrix <- rbind(HAN_High_Matrix, n_size)

HAN_High_Matrix <- as.data.frame(HAN_High_Matrix)
HAN_High_Matrix_table <- tab_df(HAN_High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR HAN_High Transition Matrix.html")

## Hanauma Bay_Low
n_size <- HAN_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Low_Matrix <- matrix(HAN_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Low_Matrix <- rbind(HAN_Low_Matrix, n_size)

HAN_Low_Matrix <- as.data.frame(HAN_Low_Matrix)
HAN_Low_Matrix_table <- tab_df(HAN_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR HAN_Low Transition Matrix.html")


## Waikiki_High
n_size <- WAI_high_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_High_Matrix <- matrix(WAI_high_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_High_Matrix <- rbind(WAI_High_Matrix, n_size)

WAI_High_Matrix <- as.data.frame(WAI_High_Matrix)
WAI_High_Matrix_table <- tab_df(WAI_High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR WAI_High Transition Matrix.html")

## Waikiki_Low
n_size <- WAI_low_transition %>% group_by(experimental_treatment, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

WAI_Low_Matrix <- matrix(WAI_low_transition$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Low_Matrix <- rbind(WAI_Low_Matrix, n_size)

WAI_Low_Matrix <- as.data.frame(WAI_Low_Matrix)
WAI_Low_Matrix_table <- tab_df(WAI_Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR WAI_Low Transition Matrix.html")
####


### Site Matrix Generation Code ###
# Hanauma Bay only
col <- as.character(c(1, 2, 3, 4))
row <- as.character(c(1, 2, 3, 4, "5", "M"))
sample_size_row <- as.character(c("n"))
n_size <- HAN_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
HAN_Matrix <- matrix(HAN_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
HAN_Matrix <- rbind(HAN_Matrix, n_size)

HAN_Matrix <- as.data.frame(HAN_Matrix)
HAN_Matrix_table <- tab_df(HAN_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR Hanauma Bay Transition Matrix.html")


## Waikiki only
n_size <- WAI_transitions %>% group_by(Site_long, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
WAI_Matrix <- matrix(WAI_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
WAI_Matrix <- rbind(WAI_Matrix, n_size)

WAI_Matrix <- as.data.frame(WAI_Matrix)
WAI_Matrix_table <- tab_df(WAI_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR Waikiki Transition Matrix.html")


### Shelter Matrix Generation Code ###
# Low_only
n_size <- Low_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
Low_Matrix <- matrix(Low_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
Low_Matrix <- rbind(Low_Matrix, n_size)

Low_Matrix <- as.data.frame(Low_Matrix)
Low_Matrix_table <- tab_df(Low_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR Low Shelter Transition Matrix.html")


# High_only
n_size <- High_transitions %>% group_by(Shelter, size_class_start) %>% 
  slice_head() %>% 
  ungroup() %>% 
  dplyr::select(size_class_start, sample_size)
n_size <- matrix(n_size$sample_size, nrow = 1, ncol = 4, dimnames = list(sample_size_row, col))

# Create matrix and print
High_Matrix <- matrix(High_transitions$mean_transition_prob_full, nrow = 6, ncol = 4, dimnames = list(row, col))
High_Matrix <- rbind(High_Matrix, n_size)

High_Matrix <- as.data.frame(High_Matrix)
High_Matrix_table <- tab_df(High_Matrix, col.header = col, show.rownames = TRUE, file = "outputs/PR High Shelter Transition Matrix.html")



### Site x Shelter Heat Map Generation Code ###
## Waikiki_Low
WAI_Low_Heat_Map <- ggplot(data = WAI_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Waikiki_High
WAI_High_Heat_Map <- ggplot(data = WAI_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki_High") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_Low
HAN_Low_Heat_Map <- ggplot(data = HAN_low_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_Low") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# Hanauma Bay_High
HAN_High_Heat_Map <- ggplot(data = HAN_high_transition, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_low_transition$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay_High") +
  theme_bw() +
   theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Site Heat Map Generation Code ###
# Waikiki only
WAI_Heat_Map <- ggplot(data = WAI_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Waikiki") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5))  


# Hanauma Bay only
HAN_Heat_Map <- ggplot(data = HAN_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Hanauma Bay") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


### Shelter Heat Map Generation Code ###
# Low shelter only
Low_Heat_Map <- ggplot(data = Low_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("Low Shelter") +
  theme_bw() +
   theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 


# High shelter only
High_Heat_Map <- ggplot(data = High_transitions, aes(x = size_class_start, y = size_class_end, fill = mean_transition_prob)) +
  geom_tile(aes(fill = mean_transition_prob)) +
  geom_text(aes(label = round(mean_transition_prob, 2)), size = 8) +
  scale_x_continuous(position = "top", breaks = seq(1, 4, 1)) +
  scale_y_discrete((limits = rev(levels(WAI_transitions$size_class_end)))) +
 # scale_fill_gradient2(low = "red", mid = "blue", high = "green", breaks = seq(0, 1, 0.2), 
            #           limits = c(0, 1), position = "top")
  scale_fill_gradient(low = "white", high = "red", limits = c(0,1)) +
  ggtitle("High Shelter") +
  theme_bw() +
  theme(text = element_text(size = 24), axis.text = element_text(size = 24), axis.title = element_blank(), legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) 

```


## Herbivore Hypothesis
Analyses associated with the general hypothesis that greater herbivore biomass will reduce algal overgrowth of juvenile corals and consequently enhance juvenile coral survival, and growth.  We predict that herbivore biomass will be positively correlated and benthic algal overgrowth negatively correlated with coral demographic parameters.


### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## glmmTMB
summary(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)

## qqplots
urchin_fish_algae_vs_PR_16_20_survival_fit_glmmTMB

DHARMa::testDispersion(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = urchin_fish_algae_vs_PR_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "U,F,& AO vs. PR 16-20 glmmTMB survival")


r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
performance::r2_nakagawa(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB)
# r^2

plot(allEffects(urchin_fish_algae_vs_PR_16_20_survival_glmmTMB), main = "U,F,& AO vs. PR 16-20 glmmTMB survival")
# effects plots


## Survival (Greater coral survival with more herbivores and less algae)
#summary(urchin_fish_algae_vs_PR_16_20_survival_lmer)

#urchin_fish_algae_vs_PR_16_20_survival_fit
# qqplots

#r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_survival_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_16_20_survival_lmer), main = "U,F,& AO vs. PR 16-20 survival")
# effects plots

```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth (Greater coral growth with more herbivores and less algae)
summary(urchin_fish_algae_vs_PR_16_20_growth_lmer)

qqnorm(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer), main = "U,F,& AO vs. PR 16 growth Residuals")
qqline(resid(urchin_fish_algae_vs_PR_16_20_growth_lmer))

urchin_fish_algae_vs_PR_16_20_growth_fit
# qqplots

r.squaredGLMM(urchin_fish_algae_vs_PR_16_20_growth_lmer)
#r-squared

#plot(allEffects(urchin_fish_algae_vs_PR_16_20_growth_lmer), main = "U,F,& AO vs. PR 6-10 growth")
# effects plots
```

## Shelter and Reefscape Hypotheses
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).  

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals.  We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals.  Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}

## Survival transformed (Greater coral survival with more shelter)
summary(PR_16_20_survival_glmmTMB)
# r^2

PR_16_20_survival_fit_glmmTMB
#fit


DHARMa::testDispersion(PR_16_20_survival_glmmTMB)
simulationOutput <- DHARMa::simulateResiduals(fittedModel = PR_16_20_survival_glmmTMB, plot = F)
DHARMa::plotQQunif(simulationOutput, main = "PR 16-20 survival glmmTMB")


r.squaredGLMM(PR_16_20_survival_glmmTMB)
performance::r2_nakagawa(PR_16_20_survival_glmmTMB)
#r^2

# pairwise multiple comparisons
mc_survival <- emmeans(PR_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival)
# pairwise multiple comparisons
mc_survival <- emmeans(PR_16_20_survival_glmmTMB, ~ Site_long*Shelter)
pairs(mc_survival, simple = "each")


## Survival (Greater coral survival with more shelter)
#summary(PR_16_20_survival_lmer_original)


#PR_16_20_survival_fit
# fit

#r.squaredGLMM(PR_16_20_survival_lmer_original)
# r^2

# pairwise multiple comparisons
#mc_survival <- emmeans(PR_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival)
# pairwise multiple comparisons simple
#mc_survival <- emmeans(PR_16_20_survival_lmer_original, ~ Site_long*Shelter)
#pairs(mc_survival, simple = "each")


survival_plot_4

## Survival without interaction (Greater coral survival with more shelter)
#summary(survival_lmer_no_interaction_original)
#r.squaredGLMM(survival_lmer_no_interaction_original)
```

### Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## Growth transformed (Greater coral growth with more shelter)
#summary(PR_16_20_growth_mixed_effects_original_trans)


#qqnorm(resid(PR_16_20_growth_mixed_effects_original_trans), main = "PR 16-20 Growth trans")
#qqline(resid(PR_16_20_growth_mixed_effects_original_trans))
#PR_16_20_growth_fit_trans
# fit

#r.squaredGLMM(PR_16_20_growth_mixed_effects_original_trans)
# r^2

# pairwise multiple comparisons
#mc_growth <- emmeans(PR_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth)
# pairwise multiple comparisons simple
#mc_growth <- emmeans(PR_16_20_growth_mixed_effects_original_trans, ~ Site_long*Shelter)
#pairs(mc_growth, simple = "each")


## Growth (Greater coral growth with more shelter)
summary(PR_16_20_growth_mixed_effects_original)


PR_16_20_growth_fit
# fit

r.squaredGLMM(PR_16_20_growth_mixed_effects_original)
# r^2

# pairwise multiple comparisons
mc_growth <- emmeans(PR_16_20_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth)
# pairwise multiple comparisons simple
mc_growth <- emmeans(PR_11_15_growth_mixed_effects_original, ~ Site_long*Shelter)
pairs(mc_growth, simple = "each")


growth_plot_4

## Growth without interaction (Greater coral growth with more shelter)
#summary(growth_mixed_effects_no_interaction_original)
#r.squaredGLMM(growth_mixed_effects_no_interaction_original)

```


## Transition Matrices and Heat Maps
Transition matrices and heat maps that quantify and visualize probabilities of growth, stasis, shrinkage, and death for corals of all coral size classes (1-4) including growth to larger size classes (5).  Transition matrices also include the number of colonies that comprise the transitions for each size class.

Transition matrices and heat maps are presented in two forms: 1.) comparing each reefscape x shelter treatment combination (eg. Waikiki low shelter modules) and 2.) comparing low vs. high shelter regardless of reefscape and Waikiki vs. Hanauma Bay regardless of shelter treatment.

```{r, echo = TRUE, message=FALSE, warning=FALSE}
# NOTE: In all matrices row 5 represents the size class that is > 20 mm in diameter, row 6 represents percent mortality for each size class (1-4), and row 7 represents the total number of corals sampled in each size class or the sample size

## Waikiki-Low
WAI_Low_Matrix_table
WAI_Low_Heat_Map

ggsave("PR_WAI_Low_Heat_Map final.png", plot = WAI_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki-High
WAI_High_Matrix_table
WAI_High_Heat_Map

ggsave("PR_WAI_High_Heat_Map final.png", plot = WAI_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-Low
HAN_Low_Matrix_table
HAN_Low_Heat_Map

ggsave("PR_HAN_Low_Heat_Map final.png", plot = HAN_Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay-High
HAN_High_Matrix_table
HAN_High_Heat_Map

ggsave("PR_HAN_High_Heat_Map final.png", plot = HAN_High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Low Shelter
Low_Matrix_table
Low_Heat_Map

ggsave("PR_Low_Heat_Map final.png", plot = Low_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## High Shelter
High_Matrix_table
High_Heat_Map

ggsave("PR_High_Heat_Map final.png", plot = High_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Waikiki
WAI_Matrix_table
WAI_Heat_Map

ggsave("PR_WAI_Heat_Map final.png", plot = WAI_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)

## Hanauma Bay
HAN_Matrix_table
HAN_Heat_Map

ggsave("PR_HAN_Heat_Map final.png", plot = HAN_Heat_Map, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

# Linear Mixed Effects Model Tables
This section contains summary tables for all linear mixed effects models.  Models are of two types: lmer from the lme4 package and glmmTMB from the glmmTMB pacakge.  glmmTMB models were used to analyze survivorship and its associated proportional data.

## Herbivore Hypothesis
Analyses associated with the general hypothesis that a.) greater herbivore biomass will reduce algal overgrowth of juvenile corals and b.) greater algal overgrowth will consequently decrease cumulative juvenile coral cover (size classes 1-4 combined).

### Herbivore Biomass vs. Algal Overgrowth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# Herbivore biomass vs. Algal overgrowth Analyses
tab_model(herbivore_biomass_vs_algae_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Site", "Shelter", "Site x Shelter"), dv.labels = c("Algal overgrowth vs Herbivore biomass"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = "satterthwaite", p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/Herbivore Hypothesis.html")
```

### Urchin biomass (glmmTMB), Herbivorous Fish Biomass (glmmTMB), and Algal Overgrowth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# Urchin biomass, Herbivorous fish biomass, and Algal overgrowth analyses
tab_model(urchin_glmmTMB, fish_glmmTMB, cover_code_lmer, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = "satterthwaite", p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/Urchins, Herbivorous Fish, and Algal Overgrowth.html")

# need to change the r squared values for urchins and fish in powerpoint
```

### Urchin biomass, Herbivorous Fish Biomass, and Algal Overgrowth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# Urchin biomass, Herbivorous fish biomass, and Algal overgrowth analyses
tab_model(urchin_lmer, fish_lmer, cover_code_lmer, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = "satterthwaite", p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/Urchins, Herbivorous Fish, and Algal Overgrowth lmer.html")

# need to change the r squared values for urchins and fish in powerpoint
```

### Urchin, Herbivorous Fish, and Algal Cover vs. Coral Recruitment (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# Recruitment Table
tab_model(urchin_fish_algae_vs_PC_recruitment_lmer, urchin_fish_algae_vs_MO_recruitment_lmer, urchin_fish_algae_vs_PR_recruitment_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PC Recruitment", "MO Recruitment", "PR Recruitment"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs Recruitment.html")
```

### *Pocillopora* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PC_1_5_survival_glmmTMB, urchin_fish_algae_vs_PC_6_10_survival_glmmTMB, urchin_fish_algae_vs_PC_11_15_survival_glmmTMB, urchin_fish_algae_vs_PC_16_20_survival_glmmTMB, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PC 1-5 Survival", "PC 6-10 Survival", "PC 11-15 Survival", "PC 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PC Survival glmmTMB models.html", transform = NULL)
```

### *Pocillopora* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# PC Survival Table
tab_model(urchin_fish_algae_vs_PC_1_5_survival_lmer, urchin_fish_algae_vs_PC_6_10_survival_lmer, urchin_fish_algae_vs_PC_11_15_survival_lmer, urchin_fish_algae_vs_PC_16_20_survival_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PC 1-5 Survival", "PC 6-10 Survival", "PC 11-15 Survival", "PC 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PC Survival.html")

# need to change r squared values for PC 16-20 Survival in powerpoint
```

### *Pocillopora* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PC_1_5_growth_lmer_trans, urchin_fish_algae_vs_PC_6_10_growth_lmer_trans, urchin_fish_algae_vs_PC_11_15_growth_lmer_trans, urchin_fish_algae_vs_PC_16_20_growth_lmer_trans, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PC 1-5 Growth", "PC 6-10 Growth", "PC 11-15 Growth", "PC 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PC Growth Cube Root Transformed.html")
```

### *Pocillopora* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PC_1_5_growth_lmer, urchin_fish_algae_vs_PC_6_10_growth_lmer, urchin_fish_algae_vs_PC_11_15_growth_lmer, urchin_fish_algae_vs_PC_16_20_growth_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PC 1-5 Growth", "PC 6-10 Growth", "PC 11-15 Growth", "PC 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PC Growth.html")

# need to change r squared values for PC 1-5, PC 6-10, PC 11-15 and PC 16-20 Growth and p value for PC 11-15 algal overgrowth in powerpoint
```


### *Montipora* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_MO_1_5_survival_glmmTMB, urchin_fish_algae_vs_MO_6_10_survival_glmmTMB, urchin_fish_algae_vs_MO_11_15_survival_glmmTMB, urchin_fish_algae_vs_MO_16_20_survival_glmmTMB, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("MO 1-5 Survival", "MO 6-10 Survival", "MO 11-15 Survival", "MO 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs MO Survival glmmTMB models.html", transform = NULL)
```

### *Montipora* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_MO_1_5_survival_lmer, urchin_fish_algae_vs_MO_6_10_survival_lmer, urchin_fish_algae_vs_MO_11_15_survival_lmer, urchin_fish_algae_vs_MO_16_20_survival_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("MO 1-5 Survival", "MO 6-10 Survival", "MO 11-15 Survival", "MO 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs MO Survival.html")
```

### *Montipora* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_MO_1_5_growth_lmer_trans, urchin_fish_algae_vs_MO_6_10_growth_lmer_trans, urchin_fish_algae_vs_MO_11_15_growth_lmer_trans, urchin_fish_algae_vs_MO_16_20_growth_lmer_trans, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("MO 1-5 Growth", "MO 6-10 Growth", "MO 11-15 Growth", "MO 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs MO Growth Cube Root Transformed.html", transform = NULL)
```

### *Montipora* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_MO_1_5_growth_lmer, urchin_fish_algae_vs_MO_6_10_growth_lmer, urchin_fish_algae_vs_MO_11_15_growth_lmer, urchin_fish_algae_vs_MO_16_20_growth_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("MO 1-5 Growth", "MO 6-10 Growth", "MO 11-15 Growth", "MO 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs MO Growth.html")

# need to change r squared values for MO 1-5, MO 6-10, MO 11-15, and MO 16-20 Growth and all p values for MO 16-20 Growth in powerpoint
```


### *Porites* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PR_1_5_survival_glmmTMB, urchin_fish_algae_vs_PR_6_10_survival_glmmTMB, urchin_fish_algae_vs_PR_11_15_survival_glmmTMB, urchin_fish_algae_vs_PR_16_20_survival_glmmTMB, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PR 1-5 Survival", "PR 6-10 Survival", "PR 11-15 Survival", "PR 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PR Survival glmmTMB models.html", transform = NULL)
```

### *Porites* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PR_1_5_survival_lmer, urchin_fish_algae_vs_PR_6_10_survival_lmer, urchin_fish_algae_vs_PR_11_15_survival_lmer, urchin_fish_algae_vs_PR_16_20_survival_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PR 1-5 Survival", "PR 6-10 Survival", "PR 11-15 Survival", "PR 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PR Survival.html")

# need to change r squared values for PR 11-15 and PR 16-20 Survival in powerpoint
```

### *Porites* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PR_1_5_growth_lmer_trans, urchin_fish_algae_vs_PR_6_10_growth_lmer_trans, urchin_fish_algae_vs_PR_11_15_growth_lmer_trans, urchin_fish_algae_vs_PR_16_20_growth_lmer_trans, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PR 1-5 Growth", "PR 6-10 Growth", "PR 11-15 Growth", "PR 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PR Growth Cube Root Transformed.html")
```

### *Porites* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(urchin_fish_algae_vs_PR_1_5_growth_lmer, urchin_fish_algae_vs_PR_6_10_growth_lmer, urchin_fish_algae_vs_PR_11_15_growth_lmer, urchin_fish_algae_vs_PR_16_20_growth_lmer, pred.labels = c("Urchin biomass (kg)", "Herbivorous fish biomass (kg)", "Algal overgrowth (1-4)"), dv.labels = c("PR 1-5 Growth", "PR 6-10 Growth", "PR 11-15 Growth", "PR 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"), file = "outputs/Urchin biomass, Herbivorous fish biomass, and Algal overgrowth vs PR Growth.html")

# need to change r squared values for PR 6-10 and PC 11-15 Survival in powerpoint
```


## Shelter and Reefscape Hypothesis
Analyses associated with the general hypotheses regarding 1.) experimental module shelter (low and high) and 2.) reefscape context (Waikiki and Hanauma Bay).

1.) We hypothesize that high shelter experimental modules will have greater herbivore biomass and therefore lower algal overgrowth of juvenile corals. Consequently, lower algal overgrowth on high shelter modules will enhance juvenile coral recruitment, survival, and growth.

2.) Hanauma Bay is a long established Marine Life Conservation District on the Oahu, Hawaii and known to have relatively high abundance of herbivores and corals. We hypothesize that Hanauma Bay modules will greater herbivore biomass and therefore lower algal overgrowth of juvenile corals. Consequently, lower algal overgrowth on Hanauma Bay modules will enhance juvenile coral recruitment, survival, and growth.

### Recruitment (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# Recruitment
tab_model(PC_recruitment_lmer_original, MO_recruitment_lmer_original, PR_recruitment_lmer_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PC Recruitment", "MO Recruitment", "PR Recruitment"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/Recruitment.html", transform = NULL)
```

### *Pocillopora* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PC_1_5_survival_glmmTMB, PC_6_10_survival_glmmTMB, PC_11_15_survival_glmmTMB, PC_16_20_survival_glmmTMB, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PC 1-5 Survival", "PC 6-10 Survival", "PC 11-15 Survival", "PC 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PC Survival glmmTMB models.html", transform = NULL)
```

### *Pocillopora* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
# PC Survival
tab_model(PC_1_5_survival_lmer_original, PC_6_10_survival_lmer_original, PC_11_15_survival_lmer_original, PC_16_20_survival_lmer_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PC 1-5 Survival", "PC 6-10 Survival", "PC 11-15 Survival", "PC 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PC Survival.html")

# need to change r squared values for PC 1-5, PC 6-10, PC 11-15, and PC 16-20 Survival and all p-values in PC 16-20 in powerpoint
```

### *Pocillopora* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PC_1_5_growth_mixed_effects_original_trans, PC_6_10_growth_mixed_effects_original_trans, PC_11_15_growth_mixed_effects_original_trans, PC_16_20_growth_mixed_effects_original_trans, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PC 1-5 Growth", "PC 6-10 Growth", "PC 11-15 Growth", "PC 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PC Growth Cube Root Transformed.html", transform = NULL)
```

### *Pocillopora* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PC_1_5_growth_mixed_effects_original, PC_6_10_growth_mixed_effects_original, PC_11_15_growth_mixed_effects_original, PC_16_20_growth_mixed_effects_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PC 1-5 Growth", "PC 6-10 Growth", "PC 11-15 Growth", "PC 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PC Growth.html")

# need to change r squared values for PC 1-5, PC 11-15, and PC 16-20 Growth and all p values in PC 6-10 in powerpoint
```

### *Montipora* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(MO_1_5_survival_glmmTMB, MO_6_10_survival_glmmTMB, MO_11_15_survival_glmmTMB, MO_16_20_survival_glmmTMB, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("MO 1-5 Survival", "MO 6-10 Survival", "MO 11-15 Survival", "MO 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/MO Survival glmmTMB models.html", transform = NULL)
```

### *Montipora* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(MO_1_5_survival_lmer_original, MO_6_10_survival_lmer_original, MO_11_15_survival_lmer_original, MO_16_20_survival_lmer_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("MO 1-5 Survival", "MO 6-10 Survival", "MO 11-15 Survival", "MO 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/MO Survival.html")

# need to change r squared values for PC 6-10 Survival and all p values for PC 1-5, PC 6-10, PC 11-15, and PC 16-20 in powerpoint
```

### *Montipora* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(MO_1_5_growth_mixed_effects_original_trans, MO_6_10_growth_mixed_effects_original_trans, MO_11_15_growth_mixed_effects_original_trans, MO_16_20_growth_mixed_effects_original_trans, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("MO 1-5 Growth", "MO 6-10 Growth", "MO 11-15 Growth", "MO 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/Growth Cube Root Transformed.html")
```

### *Montipora* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(MO_1_5_growth_mixed_effects_original, MO_6_10_growth_mixed_effects_original, MO_11_15_growth_mixed_effects_original, MO_16_20_growth_mixed_effects_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("MO 1-5 Growth", "MO 6-10 Growth", "MO 11-15 Growth", "MO 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/MO Growth.html")

# need to change r squared values for MO 1-5, MO 6-10, MO 11-15, and MO 16-20 Growth and all p values for MO 1-5 and MO 16-20
```


### *Porites* Survival (glmmTMB)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PR_1_5_survival_glmmTMB, PR_6_10_survival_glmmTMB, PR_11_15_survival_glmmTMB, PR_16_20_survival_glmmTMB, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PR 1-5 Survival", "PR 6-10 Survival", "PR 11-15 Survival", "PR 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PR Survival glmmTMB models.html", transform = NULL)
```
 
### *Porites* Survival (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PR_1_5_survival_lmer_original, PR_6_10_survival_lmer_original, PR_11_15_survival_lmer_original, PR_16_20_survival_lmer_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PR 1-5 Survival", "PR 6-10 Survival", "PR 11-15 Survival", "PR 16-20 Survival"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "kr", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PR Survival.html")

# need to change r squared values for PR 1-5, PR 6-10, PR 11-15, PR 16-20 Survival and all p values for PR 11-15 and PR 16-20
```

### *Porites* Growth Cube Root Transformed (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PR_1_5_growth_mixed_effects_original_trans, PR_6_10_growth_mixed_effects_original_trans, PR_11_15_growth_mixed_effects_original_trans, PR_16_20_growth_mixed_effects_original_trans, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PR 1-5 Growth", "PR 6-10 Growth", "PR 11-15 Growth", "PR 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "satterthwaite", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PR Growth Cube Root Transformed.html", transform = NULL)
```

### *Porites* Growth (lmer)
```{r, echo = TRUE, message=FALSE, warning=FALSE}
tab_model(PR_1_5_growth_mixed_effects_original, PR_6_10_growth_mixed_effects_original, PR_11_15_growth_mixed_effects_original, PR_16_20_growth_mixed_effects_original, pred.labels = c("Site", "Shelter", "Site x Shelter"), dv.labels = c("PR 1-5 Growth", "PR 6-10 Growth", "PR 11-15 Growth", "PR 16-20 Growth"), show.re.var = TRUE, show.ngroups = FALSE, show.icc = FALSE, show.intercept = FALSE, show.est = TRUE, show.se = TRUE, show.df = TRUE, show.stat = TRUE, show.p = TRUE, df.method = NULL, p.val = "kr", show.ci = FALSE, string.est = "Estimate", string.se = "SE", string.df = "df", string.stat = "t value", string.p = "p", col.order = c("est", "se", "stat", "p"),  file = "outputs/PR Growth.html")

# need to change r squared values for PR 1-5, PR 6-10, PR 11-15, PR Growth and all p values for PR 6-10 and PR 16-20
```


```{r Barplots Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
# Recruitment
# PC
recruit_data_PC <- PC_1_5

# PR
recruit_data_PR <- PR_1_5

# MO 
recruit_data_MO <- MO_1_5

# Survival
# PC
survival_data_PC <- rbind(PC_S_1_5, PC_S_6_10, PC_S_11_15, PC_S_16_20)


# PR
survival_data_PR <- rbind(PR_S_1_5, PR_S_6_10, PR_S_11_15, PR_S_16_20)


# MO
survival_data_MO <- rbind(MO_S_1_5, MO_S_6_10, MO_S_11_15, MO_S_16_20)


# Growth
growth_data_PC <- rbind(PC_G_1_5, PC_G_6_10, PC_G_11_15, PC_G_16_20)


growth_data_PR <- rbind(PR_G_1_5, PR_G_6_10, PR_G_11_15, PR_G_16_20)


growth_data_MO <- rbind(MO_G_1_5, MO_G_6_10, MO_G_11_15, MO_G_16_20)

## PC Recruitment Barplot
recruit_data_PC$Site_long <- factor(recruit_data_PC$Site_long, levels = c("Waikiki", "Hanauma Bay"))
recruit_data_PC$Shelter <- factor(recruit_data_PC$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_recruitment_PC <- ggplot(data = recruit_data_PC, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))

## Barplot with axis labels
plot_recruitment_PC_labels <- ggplot(data = recruit_data_PC, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


## PC Survival Combined Barplot
survival_data_PC$Site_long <- factor(survival_data_PC$Site_long, levels = c("Waikiki", "Hanauma Bay"))
survival_data_PC$Shelter <- factor(survival_data_PC$Shelter, levels = c("Low", "High"))
survival_data_PC$size_class <- factor(survival_data_PC$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_survival_PC <- ggplot(data = survival_data_PC, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplot with axis labels
plot_survival_PC_labels <- ggplot(data = survival_data_PC, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 


## PC Growth Combined Barplot
growth_data_PC$Site_long <- factor(growth_data_PC$Site_long, levels = c("Waikiki", "Hanauma Bay"))
growth_data_PC$Shelter <- factor(growth_data_PC$Shelter, levels = c("Low", "High"))
growth_data_PC$size_class <- factor(growth_data_PC$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_growth_PC <- ggplot(data = growth_data_PC, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplot with axis labels
plot_growth_PC_labels <- ggplot(data = growth_data_PC, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 


## MO Recruitment Barplot
recruit_data_MO$Site_long <- factor(recruit_data_MO$Site_long, levels = c("Waikiki", "Hanauma Bay"))
recruit_data_MO$Shelter <- factor(recruit_data_MO$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_recruitment_MO <- ggplot(data = recruit_data_MO, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))

## Barplot with axis labels
plot_recruitment_MO_labels <- ggplot(data = recruit_data_MO, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


## MO Survival Combined Barplot
survival_data_MO$Site_long <- factor(survival_data_MO$Site_long, levels = c("Waikiki", "Hanauma Bay"))
survival_data_MO$Shelter <- factor(survival_data_MO$Shelter, levels = c("Low", "High"))
survival_data_MO$size_class <- factor(survival_data_MO$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_survival_MO <- ggplot(data = survival_data_MO, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplot with axis labels
plot_survival_MO_labels <- ggplot(data = survival_data_MO, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 


## MO Growth Combined Barplot
growth_data_MO$Site_long <- factor(growth_data_MO$Site_long, levels = c("Waikiki", "Hanauma Bay"))
growth_data_MO$Shelter <- factor(growth_data_MO$Shelter, levels = c("Low", "High"))
growth_data_MO$size_class <- factor(growth_data_MO$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_growth_MO <- ggplot(data = growth_data_MO, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplot with axis labels
plot_growth_MO_labels <- ggplot(data = growth_data_MO, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 

#, limits = c(0, 1.5)

## PR Recruitment Barplot
recruit_data_PR$Site_long <- factor(recruit_data_PR$Site_long, levels = c("Waikiki", "Hanauma Bay"))
recruit_data_PR$Shelter <- factor(recruit_data_PR$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_recruitment_PR <- ggplot(data = recruit_data_PR, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))

## Barplot with axis labels
plot_recruitment_PR_labels <- ggplot(data = recruit_data_PR, aes(fill=Shelter, y=mean, x=Site_long)) + 
  geom_bar(position = "dodge", stat="identity", width = .8) +
  scale_x_discrete(limits = position) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  scale_fill_grey(name = "Shelter", start = .8, end = .2) +
  labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
  theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


## PR Survival Combined Barplot
survival_data_PR$Site_long <- factor(survival_data_PR$Site_long, levels = c("Waikiki", "Hanauma Bay"))
survival_data_PR$Shelter <- factor(survival_data_PR$Shelter, levels = c("Low", "High"))
survival_data_PR$size_class <- factor(survival_data_PR$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplot without axis labels
plot_survival_PR <- ggplot(data = survival_data_PR, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplot with axis labels
plot_survival_PR_labels <- ggplot(data = survival_data_PR, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  labs(y = expression(paste("Coral % survival per quarter"))) +
  scale_y_continuous(breaks=seq(0, 100, 20), limits = c(0, 100)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 

## PR Growth Combined Barplot
growth_data_PR$Site_long <- factor(growth_data_PR$Site_long, levels = c("Waikiki", "Hanauma Bay"))
growth_data_PR$Shelter <- factor(growth_data_PR$Shelter, levels = c("Low", "High"))
growth_data_PR$size_class <- factor(growth_data_PR$size_class, levels = c("1-5", "6-10", "11-15", "16-20"))
# reorder summary dataframe for plotting #

## Barplots without axis labels
plot_growth_PR <- ggplot(data = growth_data_PR, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()) 

## Barplots with axis labels
plot_growth_PR_labels <- ggplot(data = growth_data_PR, aes(fill = size_class, x = interaction(Shelter, Site_long), y = mean)) +
  geom_bar(position = "dodge", stat="identity", width = .8) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = 0, size = 1.5) +
  coord_cartesian(ylim = c(0, 1.5)) +
  labs(y = expression(paste("Coral growth (cm"^"2","/quarter)"))) +
  scale_y_continuous(breaks=seq(0, 1.5, 0.5)) +
  guides(fill=guide_legend("size class (mm)")) +
  theme_classic(base_size = 13) +
  theme(panel.border = element_blank(), axis.title.y = element_text(size = 20), axis.text.y = element_text(size = 18, angle = 90), legend.position = "none", axis.title.x = element_blank()) 
```

# Final Barplot Figures

Barplots for all herbivore biomass, algal overgrowth, and coral demography linear mixed effects model analyses.  All barplots represent mixed effects model means and standard errors for each reefscape (Waikiki and Hanauma Bay) by shelter treatment (low and high) combination.  

Note that recruitment figures represent the mean number of recruits (1-5 mm diameter colonies) per square meter of substrate.  Survival and growth figures are combined such that all 4 size classes (1-4) are included side by side.  All figures in this section are used in the manuscript for this study.

## Urchin Biomass
```{r, echo = TRUE, message=FALSE, warning=FALSE}

urchin_plot_final

```

## Herbivorous Fish Biomass
```{r, echo = TRUE, message=FALSE, warning=FALSE}

fish_plot_2

```

## Benthic Algal Overgrowth
```{r, echo = TRUE, message=FALSE, warning=FALSE}

plot_cover_combined_plot0

```

## *Pocillopora* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
### PC Recruitment ###
plot_recruitment_PC_labels

ggsave("PC recruitment barplot final.png", plot = plot_recruitment_PC, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Pocillopora* Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_survival_PC_labels

ggsave("PC survival barplot final.png", plot = plot_survival_PC, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Pocillopora* Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_growth_PC_labels

ggsave("PC growth barplot final.png", plot = plot_growth_PC, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Montipora* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## MO
plot_recruitment_MO_labels

ggsave("MO recruitment barplot final.png", plot = plot_recruitment_MO, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Montipora* Surival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_survival_MO_labels

ggsave("MO survival barplot final.png", plot = plot_survival_MO, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Montipora* Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_growth_MO_labels

ggsave("MO growth barplot final.png", plot = plot_growth_MO, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Porites* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
## PR
plot_recruitment_PR_labels

ggsave("PR recruitment barplot final.png", plot = plot_recruitment_PR, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Porites* Survival
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_survival_PR_labels

ggsave("PR survival barplot final.png", plot = plot_survival_PR, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

## *Porites* Growth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
plot_growth_PR_labels

ggsave("PR growth barplot final.png", plot = plot_growth_PR, path = save_location, width = 6.25, height = 5.209, units = "in", dpi = 96)
```

# Time Series Figures
Figures representing the mean herbivore biomass, algal overgrowth, and coral recruitment through time with associated standard errors on experimental modules from May 2017 to March 2020.  Coral recruitment time series are for all three coral genera analyzed for this study (*Pocillopora*, *Montipora*, and *Porites*)

Time series figures represent the reefscape (Waikiki and Hanauma Bay) and shelter availability (low and high) treatments of this study.  Triangles represent Waikiki and circles represent Hanauma Bay.  Unfilled shapes represent low shelter modules and filled shapes represent high shelter modules.

## Urchin Biomass
```{r, echo = TRUE, message=FALSE, warning=FALSE}
urchin_time_series_plot
```

## Herbivorous Fish Biomass
```{r, echo = TRUE, message=FALSE, warning=FALSE}
fish_time_series_plot
```

## Algal Overgrowth
```{r, echo = TRUE, message=FALSE, warning=FALSE}
algae_time_series_plot_cover_code
```

## *Pocillopora* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
PC_recruitment_time_series_plot_3
```

## *Montipora* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
MO_recruitment_time_series_plot_3
```

## *Porites* Recruitment
```{r, echo = TRUE, message=FALSE, warning=FALSE}
PR_recruitment_time_series_plot_3
```

# Combined Recruitment Time Series Figures
Figures representing the cumulative number of recruits and mean quarterly number of recruits per meter squared on experimental modules from May 2017 to March 2020.  These figures represent colonies from all three coral genera analyzed for this study combined together (*Pocillopora*, *Montipora*, and *Porites*).

Time series figures represent the reefscape (Waikiki and Hanauma Bay) and shelter availability (low and high) treatments of this study.  Triangles represent Waikiki and circles represent Hanauma Bay.  Unfilled shapes represent low shelter modules and filled shapes represent high shelter modules.

```{r Combined Recruitment Master Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
## Master Database
###### Pub dataframe
sub_2 <- read_csv("databases/pub_data_final.csv")
sub_2 <- sub_2 %>% filter(`Module #` %in% modules)
###

# names of databases used for colored barplots with size classes 1-4 (1-20 mm)
## needs to be changed for each genera and size class combination
### recruitment database is for size class 1 the only (1-5 mm)
```


```{r Combined Recruitment Variables, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Variables Directory
min <- 1
max <- 5
size_vect <- seq(from = min, to = max, by = 1)  
# vector to select size range for corals to be analyzed

min_matrix <- 1
max_matrix <- 20
matrix_vect <- seq(from = min_matrix, to = max_matrix, by = 1)

### NOTE: 
# For size class analyses (1: 1-5 mm, 2: 6-10 mm, 3:11-15 mm, 4: 16-20 mm): you must do each size class script run separately and save to database objects (Rec, Sur, Grow) that under "Summary Plot Databases" in the above code chunk.  
# For transition matrices and heat maps: you must include all data to account for corals that grew outside of size classes 1-4 (size class 5: > 20 mm)


species <- c("PC", "PR", "MO", "MPA")
# must be changed for each genera (PC, PR, MO/MPA)
species_label <- c("All")
# used primarily for Montipora to label all colonies that are MO or MPA to MO
exclusion <- c("NF","D")
repro_min <- 50
# minimum size for being reproductively active


#### List of raw database objects used
# sub_2
# urchin_data
# urchin_biomass_parameters
# fish_data_hanauma
# fish_data_waikiki
# fish_biomass_parameters
# timestep_year_log
# cover_data
# date_data
# module_data
```


```{r Combined Recruitment Data Quality Control Code, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
sub_2 <- sub_2 %>%    
  arrange(ID, TimeStep, .bygroup = TRUE) %>% 
  group_by(ID) %>%     
 mutate(found = rev(cumsum(is.na(rev(`Status Code`))) > 0),
         `Status Code` = ifelse(found & `Status Code` == "NF", "X", `Status Code`),
         `Status Code` = ifelse(found & `Status Code` == "D", "ND", `Status Code`)) %>%
  filter(`Status Code` != "X" | is.na(`Status Code`)) %>% 
  mutate(`Taxonomic Code` = last(`Taxonomic Code`))


sub_2_test <- sub_2 %>% group_by(ID) %>% 
  filter(duplicated(TimeStep))

library(tidyverse)

iColonies <- sub_2 %>%
  arrange(ID, TimeStep) %>% 
  group_by(ID) %>% 
  summarise(MinTimeStep = min(TimeStep),
            MaxTimeStep = max(TimeStep),
            .groups = "drop") %>% 
  mutate(TimeStep = map2(.x = MinTimeStep, .y = MaxTimeStep, ~seq(from = .x, to = .y))) %>% 
  unnest(TimeStep) %>% 
  anti_join(., sub_2, c("TimeStep", "ID")) %>% 
  .$ID %>% 
  unique
    
res <- sub_2 %>% filter(ID %in% iColonies)

# Result
res


res <- res %>% filter(Side %in% side)
res <- res %>% filter(TimeStep %in% timestep)
nf_corals <- res %>% filter(`Status Code` %in% c("NF", "D"))
res_filtered <- res %>% filter(ID %in% nf_corals$ID)

# code to insure there are no duplicate colony numbers
```

```{r Combined Recruitment Calculations for Colony Area and Volume, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
######### PC Max Orthogonal and Height Calculations
### Simple

### Small corals with all measures
PC_data <- sub_2 %>% filter(`Taxonomic Code` == "PC", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PC database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PC_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_orthog)
# linear model

PC_mod_orthog_intercept <- summary(PC_mod_orthog)$coefficients[1,1]
PC_mod_orthog_slope  <- summary(PC_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate max orthogonal diameter as a function of the maximum diameter

### Height Model
plotNormalHistogram(PC_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data))
# scatterplot with trendline

PC_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PC_data)
summary(PC_mod_height)
# linear model

PC_mod_height_intercept <- summary(PC_mod_height)$coefficients[1,1] 
PC_mod_height_slope <- summary(PC_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model to calculate height as a function of the maximum diameter


### Database with all 3 measures 
PC_all <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>%
  filter(Side %in% side)
# PC database with all component measures


### Database for corals where height was not measured
PC_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>% 
  filter(Side %in% side)
# PC database with max diameter and max orthogonal components only


### Database for corals with no orthogonal or height measures 
PC_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PC_mod_orthog_slope*`Max Diameter (mm)` + PC_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PC_mod_height_slope*`Max Diameter (mm)` + PC_mod_height_intercept) %>%
  filter(Side %in% side)
# PC database with max diameter only

                                       
### Database for corals with no measurements
PC_none <- sub_2 %>% filter(`Taxonomic Code` == "PC",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PC database missing all component measures


###################### Combine Database
PC_final <- bind_rows(PC_all, PC_no_height, PC_no_orthog_or_height, PC_none)
# bind all 4 databases by row
PC_final <- PC_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models



######### PR Max Orthogonal and Height Calculations
### Small corals with all measures
PR_data <- sub_2 %>% filter(`Taxonomic Code` == "PR", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# PR database with all corals < 20 mm that have all component measures


### Max Orthogonal Model
plotNormalHistogram(PR_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_orthog)
# linear model

PR_mod_orthog_intercept <- summary(PR_mod_orthog)$coefficients[1,1]
PR_mod_orthog_slope  <- summary(PR_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(PR_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data))
# scatterplot with trendline

PR_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = PR_data)
summary(PR_mod_height)
# linear model

PR_mod_height_intercept <- summary(PR_mod_height)$coefficients[1,1]/summary(PR_mod_height)$coefficients[1,1]
PR_mod_height_slope <- summary(PR_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
PR_all <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# PR database with all 3 component measures

### No Height measure
PR_no_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>% 
  filter(Side %in% side)
# PR database with max diameter and max orthogonal components only

### No Orthogonal or Height Measures 
PR_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = PR_mod_orthog_slope*`Max Diameter (mm)` + PR_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = PR_mod_height_slope*`Max Diameter (mm)` + PR_mod_height_intercept) %>%
  filter(Side %in% side)
# PR database with max diameter only
                                       
### No Measurements
PR_none <- sub_2 %>% filter(`Taxonomic Code` == "PR",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# PR database missing all 3 component measures


###################### Combine Database
PR_final <- bind_rows(PR_all, PR_no_height, PR_no_orthog_or_height, PR_none)
# bind databases by row
PR_final <- PR_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MO Max Orthogonal and Height Calculations
### Small corals with all measures
MO_data <- sub_2 %>% filter(`Taxonomic Code` == "MO", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MO database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MO_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_orthog)
# linear model

MO_mod_orthog_intercept <- summary(MO_mod_orthog)$coefficients[1,1]
MO_mod_orthog_slope  <- summary(MO_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MO_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data))
# scatterplot with trendline

MO_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MO_data)
summary(MO_mod_height)
# linear model

MO_mod_height_intercept <- summary(MO_mod_height)$coefficients[1,1] 
MO_mod_height_slope <- summary(MO_mod_height)$coefficients[2,1]
# intercept and slope parameters from linear model


### All 3 measures 
MO_all <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures

### No Height measure
MO_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>% 
  filter(Side %in% side)
# MO database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MO_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MO_mod_orthog_slope*`Max Diameter (mm)` + MO_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MO_mod_height_slope*`Max Diameter (mm)` + MO_mod_height_intercept) %>%
  filter(Side %in% side)
# MO database with max diameter only
                                       
### No Measurements
MO_none <- sub_2 %>% filter(`Taxonomic Code` == "MO",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MO database with all 3 component measures missing

###################### Combine Database
MO_final <- bind_rows(MO_all, MO_no_height, MO_no_orthog_or_height, MO_none)
# bind all databases by row
MO_final <- MO_final %>% mutate(`Max Diameter (mm)` = abs(`Max Diameter (mm)`),
                                `Max Orthogonal (mm)` = abs(`Max Orthogonal (mm)`),
                                `Height (mm)` = abs(`Height (mm)`))
# calculated absolute value for all 3 component measures to eliminate negative values created by the max orthogonal and height models


######### MPA Max Orthogonal and Height Calculations
### Small corals with all measures
MPA_data <- sub_2 %>% filter(`Taxonomic Code` == "MPA", 
                            `Max Diameter (mm)` < 20 & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side, TimeStep %in% timestep)
# MPA database with all corals < 20 mm that have all component measures

### Max Orthogonal Model
plotNormalHistogram(MPA_data$`Max Orthogonal (mm)`)
# histogram

plot(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Max Orthogonal")
abline(lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_orthog <- lm(`Max Orthogonal (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_orthog)
# linear model

MPA_mod_orthog_intercept <- summary(MPA_mod_orthog)$coefficients[1,1]
MPA_mod_orthog_slope  <- summary(MPA_mod_orthog)$coefficients[2,1]
# intercept and slope parameters from linear model

### Height Model
plotNormalHistogram(MPA_data$`Height (mm)`)
# histogram

plot(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data, main = "Max Diameter vs Height")
abline(lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data))
# scatterplot with trendline

MPA_mod_height <- lm(`Height (mm)` ~ `Max Diameter (mm)`, data = MPA_data)
summary(MPA_mod_height)
# linear model

MPA_mod_height_intercept <- summary(MPA_mod_height)$coefficients[1,1]/summary(MPA_mod_height)$coefficients[1,1]
MPA_mod_height_slope <- summary(MPA_mod_height)$coefficients[2,1]*0
# intercept and slope parameters from linear model


### All 3 measures 
MPA_all <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                           !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`) & !is.na(`Height (mm)`)) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures

### No Height measure
MPA_no_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                 is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`) & !is.na(`Max Orthogonal (mm)`)) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>% 
  filter(Side %in% side)
# MPA database with max diameter and max orthogonal measures only

### No Orthogonal or Height Measures 
MPA_no_orthog_or_height <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                                           is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`) & !is.na(`Max Diameter (mm)`))) %>% 
  mutate(`Max Orthogonal (mm)` = MPA_mod_orthog_slope*`Max Diameter (mm)` + MPA_mod_orthog_intercept) %>% 
  mutate(`Height (mm)` = MPA_mod_height_slope*`Max Diameter (mm)` + MPA_mod_height_intercept) %>%
  filter(Side %in% side)
# MPA database with max diameter measures only
                                       
### No Measurements
MPA_none <- sub_2 %>% filter(`Taxonomic Code` == "MPA",
                            is.na(`Max Diameter (mm)`) & is.na(`Max Orthogonal (mm)` & is.na(`Height (mm)`))) %>% 
  filter(Side %in% side)
# MPA database with all 3 component measures missing


###################### Combine Database
MPA_final <- bind_rows(MPA_all, MPA_no_height, MPA_no_orthog_or_height, MPA_none)
# row bind database for MPA

#### Final Database
data_final <- bind_rows(PC_final, PR_final, MO_final, MPA_final)
```

```{r Combined Recruitment Final Coral Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
data_final <- data_final %>% filter(`Taxonomic Code` %in% species, # select taxonomic groups
                               Side %in% side) %>% # select module sides to be analyzed
  filter(TimeStep %in% timestep) %>% 
  mutate(`Height (mm)` = ifelse(`Height (mm)` < 1, 1, `Height (mm)`)) %>% 
  # if height < 1, make height = 1
  mutate(simple_area_mm_squared = pi*((`Max Diameter (mm)`/2)^2),
         # assuming circular growth pattern based on diameter
         simple_area_cm_squared = simple_area_mm_squared/100,
         # assuming circular growth pattern based on diameter
         area_mm_squared = pi*(`Max Diameter (mm)`/2)*(`Max Orthogonal (mm)`/2), 
         # calculate mm^2 area as an oval
         area_cm_squared = area_mm_squared/100)

data_final$Date <- as.Date(data_final$Date,'%m/%d/%y')

sub_3 <- data_final %>% filter(`Max Diameter (mm)` %in% size_vect) 
# select diameter size range and module sides to analyze

```

```{r Combined Recruitment Database, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Recruitment Database for Module Sides Combined (N & S) ###

### General Workflow Summary
# Make series of databases (ID Databases) for each quarter that filter for all corals within the designated size range represented by the size_vect vector while preventing any individual coral ID from being used in subsequent quarters (prevent pseudoreplication by sampling a individual coral colony more than once)

# Make a series of databases (Quarterly Total Recruits and Larval Output Databases) for each quarter that summarize the total number of recruits and total larval ouput for each module side and coral size_class using the previous series of databases to filter out corals that have already been sampled in previous timesteps or quarters

# Bind these series of databases together by row to make a new single dataframe with all module sides and size classes

# Used date log database to add survey dates back into the database that were lost during the use of the complete() function to fill in missing data (where no corals were observed which means there were 0 recruits per square meter not that there are no data)

# Used the complete() functions twice more to fill in for missing data after joining databases

# Use a series of group_by() and summary() functions to group data such that mean coral recruitment per square meter is calculated based on the total area of both N and S sides of each module

### ID Databases
start_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1))

Q1_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2))

Q2_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3))

Q3_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4))

Q4_recruits_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5))

Q5_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6))

Q6_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7))

Q7_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8))

Q8_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9))

Q9_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10))

Q10_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11))

Q11_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12))

#Q12_recruits_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13))


### Quarterly Total Recruits and Larval Output Databases
start_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, TimeStep %in% c(1)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q1_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), TimeStep %in% c(2)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q2_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), TimeStep %in% c(3)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q3_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), TimeStep %in% c(4)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q4_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), TimeStep %in% c(5)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>%  
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q5_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), TimeStep %in% c(6)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q6_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), TimeStep %in% c(7)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q7_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), TimeStep %in% c(8)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q8_recruitment_original <-  sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), TimeStep %in% c(9)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q9_recruitment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), TimeStep %in% c(10)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q10_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), TimeStep %in% c(11)) %>% 
  group_by(`Taxonomic Code`,Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

Q11_recruiment_original <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), TimeStep %in% c(12)) %>% 
  group_by(`Taxonomic Code`, Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output) %>% 
  summarise(recruits = n(),
            total_larvae = sum(larval_output))

#Q12_recruiment <- sub_3 %>% filter(`Max Diameter (mm)` %in% size_vect, !(ID %in% start_recruits_original$ID), !(ID %in% Q1_recruits_original$ID), !(ID %in% Q2_recruits_original$ID), !(ID %in% Q3_recruits_original$ID), !(ID %in% Q4_recruits_original$ID), !(ID %in% Q5_recruits_original$ID), !(ID %in% Q6_recruits_original$ID), !(ID %in% Q7_recruits_original$ID), !(ID %in% Q8_recruits_original$ID), !(ID %in% Q9_recruits_original$ID), !(ID %in% Q10_recruits_original$ID), !(ID %in% Q11_recruits_original$ID), TimeStep %in% c(13)) %>% 
#  group_by(Date, TimeStep, Year, Site_long, Shelter, `Module #`, Side, Settlement_Area, size_class, larval_output, Sector, Sector_Area) %>% 
#  summarise(recruits = n(),
 #           total_larvae = sum(larval_output))

### Final Databases
n1_original <- bind_rows(start_recruitment_original, Q1_recruitment_original, Q2_recruitment_original, Q3_recruitment_original, Q4_recruitment_original, Q5_recruitment_original, Q6_recruitment_original, Q7_recruitment_original, Q8_recruitment_original, Q9_recruitment_original, Q10_recruiment_original, Q11_recruiment_original)

date_data <- read_csv("databases/Coral Census Date Log.csv")

date_data$Date <- as.Date(date_data$Date,'%m/%d/%y')
n1_original$Year <- as.numeric(n1_original$Year)
date_data$Year <- as.numeric(date_data$Year)
date_data$`Module #` <- as.numeric(date_data$`Module #`)
n1_original$`Module #` <- as.numeric(n1_original$`Module #`)

date_data <- date_data %>% filter(TimeStep %in% timestep, Side %in% side, `Module #` %in% modules)
# filter census date database

n1_original <- n1_original %>% filter(TimeStep %in% timestep)



n1_original <- left_join(date_data, n1_original, by = c("Date", "Module #", "Site_long", "Shelter", "Side", "TimeStep"))
  
  
### Recruitment by combining sectors (N & S)

n2_original <- n1_original %>% ungroup()  %>% 
  complete(nesting(`Module #`), Side, TimeStep, fill = list(larval_output = 0, recruits = 0, Settlement_Area = 1)) %>% 
  drop_na(Side, `Module #`) %>%  
  mutate(`Taxonomic Code` = species_label)


n2_original <- n2_original %>%

  group_by(`Module #`, TimeStep, Side) %>% 
  mutate(recruits = sum(recruits),
         larvae = larval_output) %>%
  slice(n())

n3_original <- data_final %>% arrange((Date)) %>% 
  group_by(`Module #`, TimeStep, Side) %>% 
  filter(`Max Diameter (mm)` > repro_min) %>% 
  tally() 


n3_original$`Module #` <- as.numeric(n3_original$`Module #`)

n2_original <- left_join(n2_original, n3_original)

n2_original <- n2_original %>% rename("Reproductive" = n)


# Total coral colony calculation 
n5_original <- data_final %>% filter(TimeStep %in% timestep) %>% 
  mutate(Reproductive = ifelse(`Max Diameter (mm)` >= repro_min, "Yes", "No")) %>% 
  group_by(`Taxonomic Code`, Date, Year, Site_long, Shelter, `Module #`, TimeStep, Side, Sector) %>% 
  tally() %>% 
  filter(Side %in% side,
         `Taxonomic Code` %in% species) 


n5_original <- n5_original %>% group_by(Year, Site_long, Shelter, `Module #`, TimeStep, Side) %>% 
  summarize(Date = mean(Date),
            coral_count = sum(n)) %>% 
  filter(!is.na(Date))

n5_original <- n5_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1))

# make Module # a factor column #
n5_original$`Module #` <- as.numeric(n5_original$`Module #`)

n6_original <- left_join(n2_original, n5_original)

n6_original <- n6_original %>% ungroup() %>% 
  complete(`Module #`, Side, TimeStep, fill = list(coral_count = 0, recruits = 0, Settlement_Area = 1, Reproductive = 0))


n7_original <- n6_original %>%
  mutate(Site_long = as.factor(ifelse(`Module #` %in% c(111,112,113,114,115,116), "Waikiki", "Hanauma Bay"))) %>% 
  mutate(Shelter = as.factor(ifelse(`Module #` %in% c(111,211,113,213,115,215), "High", "Low"))) %>% 
group_by(TimeStep, `Module #`) %>%
  fill(Date, Year, .direction = "updown") %>% 
    mutate(Season = ifelse(TimeStep %in% seq(from = 1, to = 1000, by = 4), "summer",
                         ifelse(TimeStep %in% seq(from = 2, to = 1001, by = 4), "fall",
                                ifelse(TimeStep %in% seq(from = 3, to = 1002, by = 4), "winter",
                                       ifelse(TimeStep %in% seq(from = 4, to = 1003, by = 4), "spring", "spring")))))



#### Module Scale Database for Recruitment
date_data_new <- date_data %>% group_by(`Module #`, Site_long, Shelter, TimeStep, Year) %>% 
  summarize(Date_new = mean(Date))

module_data$`Module #` <- as.numeric(module_data$`Module #`)

n7_original <- left_join(n7_original, module_data, by = c("Site_long", "Shelter", "Module #", "Side", "TimeStep"))


n7_original$Settlement_Area <- n7_original$Settlement_Area.y
n7_original$Year <- n7_original$Year.x


n7_original <- n7_original %>% group_by(`Module #`, TimeStep, `Taxonomic Code`, Site_long, Shelter, Year, Season) %>% 
  summarize(recruits = sum(recruits),
    Settlement_Area = sum(Settlement_Area)) %>% 
  mutate(recruits_per_meter_squared = recruits/Settlement_Area)


n7_original <- left_join(n7_original, date_data_new, by = c("Module #", "Site_long", "Shelter", "TimeStep", "Year"))
n7_original$Date <- n7_original$Date_new

```


```{r Combined Recruitment Transformation and Distributions, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Recruitment Transformations and Distributions ###

# Side combined database
n7_original <-  n7_original %>% mutate(recruits_per_meter_squared_trans = log(recruits_per_meter_squared + 1))

plotNormalHistogram(n7_original$recruits_per_meter_squared, main = "Recruitment original")
# recruitment distributions

plotNormalHistogram(n7_original$recruits_per_meter_squared_trans, main = "Recruitment Trans Original")


```

```{r Combined Recruitment Analyses, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Recruitment Analyses for Module Sides Combined ( N & S) ###

#################### lmer original
# all corals with sides combined
# with interaction
module_recruitment <- as.numeric(n7_original$`Module #`)
n7_original$Site_long <- as.factor(n7_original$Site_long)
# factorize variables

recruitment_lmer_original <- lmer(recruits_per_meter_squared_trans ~ Site_long*Shelter + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(recruitment_lmer_original)
# model summary

recruitment_lmer_no_interaction_original <- lmer(recruits_per_meter_squared_trans ~ Site_long + Shelter + (1|Year/Season), data = n7_original, na.action = "na.fail")
summary(recruitment_lmer_no_interaction_original)
# model summary
```


```{r Combined Recruitment Model Assessments, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Analyses Assessment Side
## Recruitment
qqnorm(resid(recruitment_lmer_original, main = "Recruitment Residual Plot Original"))
qqline(resid(recruitment_lmer_original))
# qqplots

r.squaredGLMM(recruitment_lmer_original)
#r-squared

emm_recruit_lmer_1_original <- emmeans(recruitment_lmer_original, ~ Site_long*Shelter)
pairs(emm_recruit_lmer_1_original)
# post-hoc tests

plot(allEffects(recruitment_lmer_original), main = "Recruitment Original")
# effects plots
```


```{r Combined Recruitment Figures, results='hide', echo = FALSE, message=FALSE, warning=FALSE, fig.show = "hide"}
### Recruitment Module Side Combined (N & S) Summary Databases ###
std.dev.pop <- function(x) sqrt(sum((x - mean(x))^2)/(length(x)))
std.error.pop <- function(x) (std.dev.pop(x))/(sqrt(length(x)))
#standard error function for error bars

plot_data_Site1  <- n7_original %>%
  group_by(`Taxonomic Code`, Site_long, Shelter) %>% 
  summarise(mean = mean(recruits_per_meter_squared),
            sd = std.dev.pop(recruits_per_meter_squared), 
            lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared),
            sample_size = n()) %>% 
  mutate(size_class = paste(min,"-",max, sep = ""))
#%>% 
 #           add_column(`Taxonomic Group` = "PC", size = "46-50")
# Barplot summary database


plot_data_Site1 <- plot_data_Site1[c(3, 4, 1, 2),]
plot_data_Site1$Shelter <- factor(plot_data_Site1$Shelter, levels = c("Low", "High"))
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


###### Assign name for summary database from input section at top of script
assign(Rec, plot_data_Site1)



myplotfunc_recruitment <- function(x,y,z)
{
    data <- x
    
    mult_compare_recruitment <- y
    
    data <- data[c(3, 4, 1, 2),]
    data$Shelter <- factor(data$Shelter, levels = c("Low", "High"))
    # reorder summary dataframe for plotting 
    
    position <- z
    # ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 
    
   plot <- ggplot(data = data, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.text.x = element_blank(), axis.title.y = element_text(size = 18))
    return(plot)
}

recruitment_plot_3 <- myplotfunc_recruitment(plot_data_Site1, mult_compare_recruitment, position)


## Barplot with labels
recruitment_plot_4 <- ggplot(data = plot_data_Site1, aes(fill=Shelter, y=mean, x=Site_long)) + 
        geom_bar(position = "dodge", stat="identity", width = .8) +
        scale_x_discrete(limits = position) +
        geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(.8), width = .1) +
        #geom_text(aes(label = mult_compare_recruitment, y = data$upper), vjust = -.5, position = position_dodge(width = 0.8), size = 4) +
     # geom_text(aes(label = paste("n =", sample_size), y = -Inf), vjust = -.3,
      #      position = position_dodge(width = .8)) +
        scale_fill_grey(name = "Shelter", start = .8, end = .2) +
        labs(x = "Site", y = expression(paste("Coral recruitment per m"^"2"))) + 
        theme_classic(base_size = 20) +
        theme(axis.title.x = element_blank(),
              legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.45), axis.title.y = element_text(size = 18))


### Recruitment Time Series Summary Databases and Figures with Module Sides Combined (N & S) ###
## Recruitment Time Series Plots
plot_data_recruitment <- n7_original %>%
  group_by(Year, Site_long, Shelter, TimeStep) %>% 
  summarise(mean = mean(recruits_per_meter_squared),
            sd = std.dev.pop(recruits_per_meter_squared),
            lower = mean(recruits_per_meter_squared) - std.error.pop(recruits_per_meter_squared),
            upper = mean(recruits_per_meter_squared) + std.error.pop(recruits_per_meter_squared),
            Date = mean(Date))
# time series summary database


plot_data_recruitment$Shelter <- factor(plot_data_recruitment$Shelter, levels = c("Low", "High"), ordered = TRUE)
plot_data_recruitment$Site_long <- factor(plot_data_recruitment$Site_long, levels = c("Hanauma Bay", "Waikiki"), ordered = TRUE)
# reorder summary dataframe for plotting 

position <- c("Waikiki", "Hanauma Bay")
# ggplot2 barplot position with Waikiki (Low-High Shelter) and Hanauma Bay 


## combined figure with legend ##
recruitment_time_series_plot_3 <- ggplot(data = plot_data_recruitment, aes(x = Date, y = mean, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
  geom_point(aes(size = 3)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(21, 24, 21, 24), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) + 
  scale_x_date(date_breaks = "3 months",  date_labels = "%b") +
  theme_classic(base_size = 14.5) +
  coord_cartesian(ylim = c(0,25)) +
  labs(x = "Date", y = expression(paste("Coral recruitment per m"^"2"))) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), legend.text = element_text(size = rel(1)), plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5), legend.position = "none", legend.title = element_text(size = rel(1)), axis.text.y = element_text(angle = 90), axis.title.y = element_text(size = 18), axis.text = element_text(size = 16))


recruitment_time_series_plot_3


### Cumulative Recruitment Plot ###
n7_original_new <- n7_original %>% group_by(TimeStep, Season, Site_long, Shelter) %>% 
  summarise(Date_new = mean(Date),
            recruit = sum(recruits)) 

n7_original_new2 <- n7_original_new %>% group_by(Site_long, Shelter) %>%
  arrange(TimeStep) %>% 
  mutate(cum_sum_recruits = cumsum(recruit))

n7_original_new2$Shelter <- factor(n7_original_new2$Shelter, levels = c("Low", "High"), ordered = TRUE)
n7_original_new2$Site_long <- factor(n7_original_new2$Site_long, levels = c("Waikiki", "Hanauma Bay", ordered = TRUE))


cumulative_recruit_time_series <- ggplot(data = n7_original_new2, aes(x = Date_new, y = cum_sum_recruits, fill = interaction(Site_long, Shelter), shape = interaction(Site_long, Shelter))) +
geom_point(aes(size = 5)) +
  geom_line(aes(linetype = Shelter)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_shape_manual(name = 'Site x Shelter', values = c(24, 21, 24, 21), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  scale_fill_manual(name = "Site x Shelter", values = c("white", "white", "black", "black"), labels = c("Hanauma Bay - Low", "Waikiki - Low", "Hanauma Bay - High", "Waikiki - High")) +
  guides(size = FALSE, linetype = FALSE,  shape = guide_legend(override.aes = list(size = 5))) +
  theme(text = element_text(size = 1)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = "Date", y = "Cumulative # of Recruits") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.title.x = element_blank(), axis.title.y = element_text(size = 18), axis.text.y = element_text(angle = 90), axis.text = element_text(size = 16), legend.position = "none", plot.title = element_text(size = 20, hjust = 0.5, vjust = -1.5))
```

```{r Combined Recruitment Time Series Plots, echo = TRUE, message=FALSE, warning=FALSE}
cumulative_recruit_time_series

ggsave("Cumulative combined recruitment time series final.png", plot = cumulative_recruit_time_series, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)

recruitment_time_series_plot_3

ggsave("Combined recruitment time series final.png", plot = recruitment_time_series_plot_3, path = save_location, width = 8.469, height = 5.304, units = "in", dpi = 96)
```

## Supplementary Tables
### Module Benthic Algae and Invertebrate Table
```{r, echo = TRUE, message=FALSE, warning=FALSE}

tab_df(benthos_cover_data_final_summary_table, file = "outputs/Module Benthic Algae and Invertebrate Percent Cover Table.html")

```